<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥½ç”·äººæ™ºæ…§å®¶å±… v15.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <style>
        /* --- å…¨å±€ä½ˆå±€ --- */
        html, body { height: 100%; overflow: hidden; background-color: #f5f7fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        #app { height: 100vh; width: 100vw; position: relative; }
        [v-cloak] { display: none; }

        /* [v15.1] å…¥å£ä¸»é æ¨£å¼ */
        .landing-page { height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); text-align: center; padding: 20px; }
        .landing-card { background: white; padding: 40px 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
        .landing-logo { font-size: 4rem; color: #0d6efd; margin-bottom: 10px; }
        .landing-btn { margin-bottom: 10px; padding: 12px; font-weight: bold; border-radius: 12px; transition: transform 0.1s; }
        .landing-btn:active { transform: scale(0.98); }

        /* [v15.1] å…¨åŸŸç½²å (Footer Credit) - ä¿®æ”¹æ¨£å¼ */
        .app-footer { 
            position: fixed; 
            bottom: 5px; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            color: #bdc3c7; /* æ¥µæ·¡ç°è‰² */
            font-size: 0.7rem; /* æ¥µå°å­—é«” */
            z-index: 50; /* ä½æ–¼æµ®å‹•æŒ‰éˆ•(900-1000) */
            pointer-events: none; /* é»æ“Šç©¿é€ */
            letter-spacing: 1px;
            font-weight: 300;
        }

        /* æ‡‰ç”¨ç¨‹å¼ä½ˆå±€ (App Layout) */
        .app-layout { display: flex; height: 100%; width: 100%; }

        /* å´é‚Šæ¬„ */
        .sidebar { width: 240px; background: #fff; border-right: 1px solid #eee; display: flex; flex-direction: column; padding: 20px; z-index: 100; transition: all 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.02); }
        .sidebar-brand { font-size: 1.2rem; font-weight: 800; color: #333; margin-bottom: 2px; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
        .version-tag { font-size: 0.7rem; color: #999; padding-left: 44px; margin-bottom: 25px; font-family: monospace; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .sidebar-item { margin-bottom: 8px; }
        .sidebar-link { display: flex; align-items: center; padding: 12px 15px; color: #666; text-decoration: none; border-radius: 12px; transition: all 0.2s; font-weight: 500; }
        .sidebar-link:hover { background-color: #f8f9fa; color: #0d6efd; transform: translateX(3px); }
        .sidebar-link.active { background-color: #e7f1ff; color: #0d6efd; font-weight: 700; box-shadow: 0 2px 6px rgba(13, 110, 253, 0.15); }
        .sidebar-link i { font-size: 1.2rem; margin-right: 12px; width: 24px; text-align: center; }

        /* ä¸»å…§å®¹å€ & RWD */
        .main-content { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; position: relative; scroll-behavior: smooth; }
        .bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #eee; padding: 8px 0 25px 0; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: #999; text-decoration: none; font-size: 0.7rem; flex: 1; transition: color 0.2s; }
        .nav-btn.active { color: #0d6efd; transform: scale(1.05); }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 2px; }
        
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .bottom-nav { display: flex; }
            .main-content { padding: 15px; padding-bottom: 120px; }
        }

        /* UI å…ƒä»¶ */
        .card { border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); margin-bottom: 15px; background: #fff; transition: transform 0.2s; }
        .page-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.5rem; font-weight: 700; color: #2c3e50; margin: 0; }
        .sub-tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .sub-tab-btn { border: 1px solid #e9ecef; background: #fff; padding: 6px 16px; border-radius: 20px; color: #666; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s; text-decoration: none; font-weight: 500; }
        .sub-tab-btn.active { background: #333; color: #fff; border-color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .floating-bar { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: rgba(33, 37, 41, 0.95); backdrop-filter: blur(8px); padding: 10px 20px; border-radius: 50px; box-shadow: 0 5px 25px rgba(0,0,0,0.25); display: flex; gap: 20px; z-index: 900; align-items: center; }
        @media (min-width: 769px) { .floating-bar { bottom: 30px; } }
        .floating-btn { border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #fff; cursor: pointer; min-width: 40px; }
        .floating-btn i { font-size: 1.3rem; margin-bottom: 2px; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 300px; width: 90%; pointer-events: none; }
        .toast { pointer-events: auto; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); overflow: hidden; opacity: 0.95; border: none; }
        .toast-success { background-color: #198754; color: white; }
        .toast-danger { background-color: #dc3545; color: white; }
        .toast-warning { background-color: #ffc107; color: #000; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .modal { background: rgba(0,0,0,0.6); } 
        .category-tag { font-size: 0.7rem; padding: 2px 6px; background: #e9ecef; border-radius: 4px; color: #666; }
        .item-name { font-weight: 600; font-size: 1rem; color: #333; }
        .price-tag { font-size: 0.9rem; color: #198754; font-weight: bold; margin-right: 5px; }
        .unit-price { font-size: 0.75rem; color: #888; margin-right: 5px; }
        .link-icon, .map-btn { color: #0d6efd; text-decoration: none; margin-left: 5px; padding: 5px; display: inline-block; }
        .map-btn { color: #dc3545; }
        .sortable-header { cursor: pointer; user-select: none; }
        .ai-action-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .settings-btn { text-align: left; padding: 12px; height: 100%; display: flex; align-items: center; }
        .settings-btn i { font-size: 1.5rem; margin-right: 10px; }
        .guide-box { background: #fffcf5; border: 1px solid #faeccc; border-radius: 8px; padding: 15px; font-size: 0.9rem; color: #555; }
        .import-receiver { background-color: #fffdf0; border: 2px solid #ffc107; scroll-margin-top: 80px; }
        .preview-card { border-left: 4px solid #0d6efd; transition: all 0.3s; }
        .preview-card.warning { border-left-color: #ffc107; background-color: #fffbf0; }
        .stat-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; background: #f1f3f5; color: #666; margin-right: 5px; }
        .db-list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .db-badge { width: 24px; height: 24px; background: #0d6efd; color: white; border-radius: 50%; text-align: center; line-height: 24px; font-size: 0.8rem; margin-right: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div class="toast-container"><transition-group name="toast"><div v-for="t in toasts" :key="t.id" class="toast mb-2 show" :class="'toast-'+t.type"><div class="d-flex align-items-center p-3"><i class="bi me-2 fs-5" :class="getToastIcon(t.type)"></i><div class="flex-grow-1 fw-bold">{{ t.msg }}</div></div></div></transition-group></div>
    <div v-if="isLoading" class="loading-overlay"><div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div><div class="mt-3 fw-bold text-primary">{{ loadingMessage }}</div></div>

    <div v-if="currentView === 'landing'" class="landing-page">
        <div class="landing-card">
            <div class="landing-logo"><i class="bi bi-robot"></i></div>
            <h3 class="fw-bold mb-1">æ™ºæ…§ç®¡å®¶</h3>
            <p class="text-muted mb-4 small">v15.1 â€¢ æ‚¨çš„å®¶åº­æ•¸æ“šä¸­å¿ƒ</p>
            
            <button @click="enterSystem" class="btn btn-primary w-100 landing-btn"><i class="bi bi-door-open-fill me-2"></i> é€²å…¥ç³»çµ±</button>
            <button @click="loadDemoData" class="btn btn-outline-info w-100 landing-btn"><i class="bi bi-magic me-2"></i> è¼‰å…¥ç¤ºç¯„è³‡æ–™</button>
            <button @click="startFresh" class="btn btn-light text-danger w-100 landing-btn border"><i class="bi bi-eraser-fill me-2"></i> ç©ºç™½é–‹å§‹</button>
            
            <div class="mt-3 text-muted small">
                è³‡æ–™åƒ…å„²å­˜æ–¼ç€è¦½å™¨æˆ–æ‚¨çš„ Google Sheet<br>ä¿éšœ 100% éš±ç§
            </div>
        </div>
    </div>

    <div v-else class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand"><i class="bi bi-robot text-primary"></i> æ™ºæ…§ç®¡å®¶</div>
            <div class="version-tag">v15.1 â€¢ 2025-12-10</div>
            <ul class="sidebar-menu">
                <li class="sidebar-item"><a href="#" class="sidebar-link" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'"><i class="bi bi-box-seam"></i> ç‰©å“ç®¡ç†</a></li>
                <li class="sidebar-item"><a href="#" class="sidebar-link" :class="{active: currentTab === 'expenses'}" @click="currentTab = 'expenses'"><i class="bi bi-receipt"></i> è³¬å–®åˆ—è¡¨</a></li>
                <li class="sidebar-item"><a href="#" class="sidebar-link" :class="{active: currentTab === 'settings'}" @click="currentTab = 'settings'"><i class="bi bi-gear"></i> ç³»çµ±è¨­å®š</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <header class="d-md-none mb-3 d-flex justify-content-between align-items-center">
                <div><h5 class="mb-0 fw-bold">ğŸ‘¨â€ğŸ’¼ æ™ºæ…§ç®¡å®¶</h5><span class="text-muted" style="font-size: 0.6rem;">v15.1</span></div>
                <span class="badge bg-light text-dark border">{{ getCategoryNameFromTab() }}</span>
            </header>

            <div v-if="currentTab === 'inventory'">
                <div class="page-header d-none d-md-flex"><h2 class="page-title">ç‰©å“ç®¡ç†</h2><button @click="openAddModal" class="btn btn-primary rounded-pill shadow-sm"><i class="bi bi-plus-lg"></i> æ–°å¢ç‰©å“</button></div>
                <div class="sub-tabs"><a href="#" class="sub-tab-btn" :class="{active: !showAiImportPanel}" @click="showAiImportPanel=false">ğŸ“‹ ç‰©å“åˆ—è¡¨</a><a href="#" class="sub-tab-btn" :class="{active: showAiImportPanel}" @click="openAiInventoryModal">ğŸ¤– AI å…¥åº«</a></div>

                <div v-if="showAiImportPanel" class="card mb-3 import-receiver" ref="inventoryPanel">
                    <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center"><span><i class="bi bi-box-arrow-in-down"></i> æ­¥é©Ÿ 2: è«‹è²¼ä¸Š JSON</span><button @click="showAiImportPanel = false" class="btn-close btn-sm"></button></div>
                    <div class="card-body"><textarea ref="inventoryPasteRef" v-model="importJsonText" class="form-control mb-3" rows="4" placeholder="è«‹é•·æŒ‰è²¼ä¸Š..."></textarea><div class="d-flex gap-2"><button @click="testInventoryJson" class="btn btn-outline-secondary flex-fill">æ¸¬è©¦ç¯„æœ¬</button><button @click="processImportData" class="btn btn-warning fw-bold flex-fill">åˆ†æä¸¦åŒ¯å…¥</button></div></div>
                </div>

                <div class="card p-3 mb-3">
                    <div class="d-flex gap-2 mb-3"><div class="search-box flex-grow-1"><i class="bi bi-search"></i><input v-model="inventorySearchKeyword" type="text" class="form-control" placeholder="æœå°‹åç¨±..."></div><button @click="openAiInventoryModal" class="btn ai-action-btn text-white rounded-circle shadow" style="width: 45px; height: 45px; padding: 0; font-size: 1.2rem;"><i class="bi bi-robot"></i></button></div>
                    <div class="row g-2 mb-2">
                        <div class="col-12 col-md-4"><select v-model="filterCategory" class="form-select"><option value="">æ‰€æœ‰é¡åˆ¥</option><option v-for="cat in categories" :value="cat.id">{{ cat.name }}</option></select></div>
                        <div class="col-6 col-md-4"><select v-model="filterBrand" class="form-select"><option value="">æ‰€æœ‰å“ç‰Œ</option><option v-for="b in uniqueBrands" :value="b">{{ b }}</option></select></div>
                        <div class="col-6 col-md-4"><select v-model="sortOption" class="form-select"><option value="default">é»˜èªæ’åº</option><option value="stock_asc">åº«å­˜: å°‘â†’å¤š</option><option value="stock_desc">åº«å­˜: å¤šâ†’å°‘</option></select></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2"><span class="small text-muted fw-bold">å…± {{ filteredInventory.length }} é …ç‰©å“</span><div class="form-check"><input class="form-check-input" type="checkbox" id="selectAllInv" :checked="isAllInventorySelected" @click="toggleSelectAllInventory"><label class="form-check-label text-muted" for="selectAllInv">å…¨é¸</label></div></div>
                </div>

                <div class="card p-0 overflow-hidden"><div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th class="ps-3 sortable-header" @click="toggleSort('name')">ç‰©å“ <i class="bi" :class="getSortIcon('name')"></i></th><th class="text-center sortable-header" style="min-width: 80px;" @click="toggleSort('stock')">åº«å­˜ <i class="bi" :class="getSortIcon('stock')"></i></th><th class="text-center" style="width: 50px;">é¸</th></tr></thead><tbody><tr v-for="item in filteredInventory" :key="item.id" :class="{'table-active': isSelected(item)}"><td class="ps-3 py-3" @click="toggleSelection(item)"><div class="mb-1"><span class="category-tag">{{ getCategoryName(item.categoryId) }}</span><span v-if="item.brand" class="category-tag bg-primary-subtle text-primary">{{ item.brand }}</span></div><div><span class="item-name">{{ item.name }}</span><a v-if="item.url" :href="item.url" target="_blank" class="link-icon ms-2" @click.stop><i class="bi bi-box-arrow-up-right"></i></a></div><div class="info-row"><span class="price-tag">{{ item.latestPrice ? '$'+item.latestPrice : '' }}</span><span class="unit-price" v-if="item.unitPrice">({{ item.unitPrice }})</span></div></td><td class="text-center align-middle"><div class="btn-group btn-group-sm"><button @click.stop="updateStock(item, -1)" class="btn btn-outline-secondary px-3" style="font-size: 1.1rem;">-</button><button class="btn btn-light disabled text-dark fw-bold border-top border-bottom px-0" style="width:35px; font-size: 1rem;">{{ item.stock }}</button><button @click.stop="updateStock(item, 1)" class="btn btn-outline-success px-3" style="font-size: 1.1rem;">+</button></div></td><td class="text-center align-middle" @click="toggleSelection(item)"><input type="checkbox" class="form-check-input" style="transform: scale(1.3);" :checked="isSelected(item)"></td></tr></tbody></table></div></div>
                <div v-if="selectedItems.length === 0" class="d-md-none" style="position: fixed; bottom: 90px; right: 20px; z-index: 999;"><button @click="openAddModal" class="btn btn-primary rounded-circle shadow p-0" style="width: 60px; height: 60px; font-size: 28px;"><i class="bi bi-plus-lg"></i></button></div>
                <div v-if="selectedItems.length > 0" class="floating-bar"><button @click="actionEdit" class="floating-btn" :class="{disabled: selectedItems.length > 1}"><i class="bi bi-pencil-square"></i> ç·¨è¼¯</button><button @click="prepareExport('whatsapp')" class="floating-btn text-success"><i class="bi bi-whatsapp"></i> WA</button><button @click="prepareExport('share')" class="floating-btn text-primary"><i class="bi bi-share-fill"></i> åˆ†äº«</button><button @click="actionDelete" class="floating-btn text-danger"><i class="bi bi-trash"></i> åˆªé™¤</button></div>
            </div>

            <div v-if="currentTab === 'expenses'">
                <div class="page-header d-none d-md-flex"><h2 class="page-title">è³¬å–®åˆ—è¡¨</h2><button @click="showMonthlySummary" class="btn btn-outline-primary rounded-pill"><i class="bi bi-calendar-check"></i> çµ±è¨ˆå ±è¡¨</button></div>
                <div class="sub-tabs"><a href="#" class="sub-tab-btn" :class="{active: !showAiReceiptPanel}" @click="showAiReceiptPanel=false">ğŸ§¾ åˆ—è¡¨</a><a href="#" class="sub-tab-btn" :class="{active: showAiReceiptPanel}" @click="openAiReceiptModal">ğŸ¤– AI æƒå–®</a><a href="#" class="sub-tab-btn d-md-none" @click="showMonthlySummary">ğŸ“Š çµ±è¨ˆ</a></div>

                <div v-if="showAiReceiptPanel" class="card mb-3 import-receiver" ref="receiptPanel">
                    <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center"><span><i class="bi bi-receipt"></i> æ­¥é©Ÿ 2: è²¼ä¸Šå–®æ“š JSON</span><button @click="showAiReceiptPanel = false" class="btn-close btn-sm"></button></div>
                    <div class="card-body"><textarea ref="receiptPasteRef" v-model="receiptJsonText" class="form-control mb-2" rows="5" placeholder="è«‹é•·æŒ‰è²¼ä¸Š..."></textarea><div class="d-grid gap-2"><button @click="testReceiptJson" class="btn btn-outline-secondary flex-fill">æ¸¬è©¦ç¯„æœ¬</button><button @click="processReceiptJson" class="btn btn-warning fw-bold flex-fill">è§£æä¸¦å¡«å…¥è¡¨å–®</button></div></div>
                </div>

                <div class="card p-3 mb-3 border-primary" ref="expenseFormCard">
                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-plus-circle"></i> {{ isEditingExpense ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢æ”¯å‡º' }} <button v-if="isEditingExpense" @click="cancelEditExpense" class="btn btn-sm btn-link text-muted float-end">å–æ¶ˆ</button></h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-4"><label class="small text-muted">æ—¥æœŸ</label><input v-model="newExpense.date" type="date" class="form-control"></div>
                        <div class="col-6 col-md-4"><label class="small text-muted">é¡åˆ¥</label><select v-model="newExpense.category" class="form-select" @change="onCategoryChange"><option v-for="(brands, cat) in companyDB" :value="cat">{{ cat }}</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
                        <div class="col-12 col-md-4"><label class="small text-muted">åº—é‹ª</label><div class="input-group"><select v-model="selectedStore" class="form-select"><option v-for="store in currentCompanyOptions" :value="store.name">{{ store.name }}</option><option value="other">ï¼‹ æ–°å¢...</option></select><input v-if="selectedStore === 'other'" v-model="customStoreInput" type="text" class="form-control" placeholder="è¼¸å…¥åç¨±"></div></div>
                        <div class="col-12"><div class="row g-2"><div class="col-8 col-md-9"><input v-model="newExpense.address" class="form-control form-control-sm text-muted" placeholder="ğŸ“ åœ°å€ (AIè‡ªå‹•å¡«å¯«)" @input="autoGenerateMapUrl"></div><div class="col-4 col-md-3"><input v-model="newExpense.mapUrl" class="form-control form-control-sm text-primary" placeholder="ğŸ—ºï¸ Link"></div></div></div>
                        <div class="col-12 mt-2"><div class="bg-light p-2 rounded border"><div class="d-flex justify-content-between align-items-center mb-2"><label class="small fw-bold mb-0">æ˜ç´°</label><button v-if="isShoppingCategory" @click="addCartItemManual" class="btn btn-sm btn-outline-secondary py-0">+ æ‰‹å‹•</button></div><div v-if="isShoppingCategory" class="input-group mb-2"><select v-model="selectedInventoryItem" class="form-select form-select-sm"><option :value="null">-- å¾åº«å­˜é¸ --</option><option v-for="item in inventory" :value="item">{{ item.name }} (${{item.latestPrice}})</option></select><input v-model.number="tempQty" type="number" class="form-control form-select-sm" placeholder="é‡" style="max-width: 60px;" min="1"><button @click="addCartItem" class="btn btn-sm btn-primary" :disabled="!selectedInventoryItem">åŠ å…¥</button></div><div v-if="newExpense.items && newExpense.items.length > 0"><div v-for="(cartItem, idx) in newExpense.items" :key="idx" class="cart-item d-flex justify-content-between align-items-center"><div style="flex-grow: 1;"><div>{{ cartItem.name }}</div><div class="small text-muted">{{ cartItem.brand }} | ${{ cartItem.price }} x {{ cartItem.qty }}</div></div><div class="text-end" style="min-width: 70px;"><span class="fw-bold">${{ (cartItem.price * cartItem.qty).toFixed(1) }}</span><i @click="removeCartItem(idx)" class="bi bi-x text-danger ms-2 fs-5" style="cursor:pointer; vertical-align: middle;"></i></div></div></div><div v-if="(!newExpense.items || newExpense.items.length===0) && isShoppingCategory" class="text-center text-muted small py-2">æš«ç„¡æ˜ç´°</div></div></div>
                        <div v-if="!isShoppingCategory" class="col-12 mt-2"><label class="small text-muted fw-bold">å¸³å–®åŸé¡</label><input v-model.number="newExpense.subtotal" type="number" class="form-control" placeholder="è¼¸å…¥é‡‘é¡"></div>
                        <div class="col-12 mt-2"><div class="cart-summary border p-2 rounded bg-white"><div class="row g-2 align-items-center"><div class="col-5"><label class="small text-muted">æŠ˜æ‰£</label><div class="input-group input-group-sm"><span class="input-group-text">-$</span><input v-model.number="newExpense.discount" type="number" class="form-control" placeholder="0"></div></div><div class="col-7 text-end"><label class="small text-muted d-block">å¯¦ä»˜é‡‘é¡</label><input v-model.number="newExpense.amount" type="number" class="form-control fw-bold text-danger text-end fs-4" readonly></div></div></div></div>
                        <div class="col-12"><label class="small text-muted">å‚™è¨»/å–®è™Ÿ</label><input v-model="newExpense.refNumber" class="form-control" placeholder="é¸å¡«"></div>
                        <div class="col-12 mt-3"><button @click="saveExpense" class="btn w-100 py-2 fs-6" :class="isEditingExpense ? 'btn-warning' : 'btn-primary'">{{ isEditingExpense ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„' }}</button></div>
                    </div>
                </div>

                <div class="card p-3">
                    <div class="search-box mb-3"><i class="bi bi-search"></i><input v-model="expenseSearchQuery" type="text" class="form-control" placeholder="æœå°‹åº—åã€å‚™è¨»..."></div>
                    <div class="table-responsive"><table class="table table-striped table-sm text-nowrap align-middle"><thead><tr><th @click="toggleExpenseSort('date')" class="sortable-header">æ—¥æœŸ <i class="bi" :class="getExpenseSortIcon('date')"></i></th><th>åº—é‹ª</th><th>é‡‘é¡</th><th class="text-center" style="width: 40px;">é¸</th></tr></thead><tbody><tr v-for="exp in filteredExpenses" :key="exp.id" :class="{'table-active': isExpenseSelected(exp)}"><td @click="toggleExpenseSelection(exp)"><div>{{ exp.date }}</div></td><td @click="toggleExpenseSelection(exp)"><span class="badge bg-light text-dark border">{{ exp.category }}</span><div class="fw-bold text-primary small mt-1">{{ exp.note }} <a v-if="exp.mapUrl" :href="exp.mapUrl" target="_blank" class="map-btn" @click.stop><i class="bi bi-geo-alt-fill"></i></a></div></td><td class="fw-bold" @click="toggleExpenseSelection(exp)">${{ exp.amount }}</td><td class="text-center" @click="toggleExpenseSelection(exp)"><input type="checkbox" class="form-check-input" style="transform: scale(1.3);" :checked="isExpenseSelected(exp)"></td></tr></tbody></table></div>
                </div>
                <div v-if="selectedExpenseIds.length > 0" class="floating-bar"><button @click="actionExpenseDetail" class="floating-btn" :class="{disabled: selectedExpenseIds.length > 1}"><i class="bi bi-file-text"></i> æ˜ç´°</button><button @click="actionExpenseEdit" class="floating-btn" :class="{disabled: selectedExpenseIds.length > 1}"><i class="bi bi-pencil"></i> ç·¨è¼¯</button><button @click="actionExpenseDelete" class="floating-btn text-danger"><i class="bi bi-trash"></i> åˆªé™¤</button></div>
            </div>

            <div v-if="currentTab === 'settings'">
                <div class="card p-3 mb-3 border-info">
                    <h5 class="text-primary fw-bold"><i class="bi bi-cloud-check"></i> é›²ç«¯åŒæ­¥è¨­å®š (Google Sheets)</h5>
                    <div class="mb-3"><span class="text-muted small" style="cursor:pointer; text-decoration: underline;" @click="showDeployGuide=!showDeployGuide"><i class="bi" :class="showDeployGuide ? 'bi-chevron-up' : 'bi-chevron-down'"></i> âš™ï¸ Google ç«¯è¨­å®šæ•™å­¸ (ä¸€æ¬¡æ€§)</span><div v-if="showDeployGuide" class="guide-box mt-2"><div class="guide-step"><b>ã€è«‹ä½¿ç”¨é›»è…¦æ“ä½œæ­¥é©Ÿ 1-5ã€‘</b></div><div class="guide-step">1. <a href="https://sheets.new" target="_blank">é»æ­¤å»ºç«‹ç©ºç™½ Google è©¦ç®—è¡¨</a>ã€‚å»ºè­°å‘½åï¼šHomeStockDB</div><div class="guide-step">2. é»æ“Šä¸Šæ–¹é¸å–® <b>æ“´å……åŠŸèƒ½ > Apps Script</b>ã€‚</div><div class="guide-step">3. åˆªé™¤ç·¨è¼¯å™¨å…§æ‰€æœ‰æ–‡å­—ï¼Œè¤‡è£½ä¸‹æ–¹ä»£ç¢¼ä¸¦è²¼ä¸Šï¼š<div class="code-block mt-1"><button class="btn btn-sm btn-light copy-btn-overlay" @click="copyGasCode">è¤‡è£½</button>function doGet(e){return handleRequest(e);} function doPost(e){return handleRequest(e);} function handleRequest(e){var lock=LockService.getScriptLock();lock.tryLock(10000);try{var ss=SpreadsheetApp.getActiveSpreadsheet();var sheetName=e.parameter.sheet||'inventory';var sheet=ss.getSheetByName(sheetName);if(!sheet){sheet=ss.insertSheet(sheetName);}if(e.postData){var data=JSON.parse(e.postData.contents);if(!Array.isArray(data)||data.length===0){sheet.clear();return responseJSON({status:'success',message:'å·²æ¸…ç©ºè³‡æ–™è¡¨'});}var headers=Object.keys(data[0]);var rows=data.map(function(row){return headers.map(function(key){var val=row[key];if(typeof val==='object'&&val!==null){return JSON.stringify(val);}return String(val||"");});});sheet.clear();sheet.getRange(1,1,1,headers.length).setValues([headers]);if(rows.length>0){sheet.getRange(2,1,rows.length,headers.length).setValues(rows);}return responseJSON({status:'success',message:'å‚™ä»½æˆåŠŸ'});}else{var dataRange=sheet.getDataRange();var values=dataRange.getValues();if(values.length<2){return responseJSON([]);}var headers=values.shift();var result=values.map(function(row){var obj={};headers.forEach(function(header,index){var cellValue=row[index];try{if(typeof cellValue==='string'&&(cellValue.startsWith('[')||cellValue.startsWith('{'))){obj[header]=JSON.parse(cellValue);}else{obj[header]=cellValue;}}catch(e){obj[header]=cellValue;}});return obj;});return responseJSON(result);}}catch(e){return responseJSON({status:'error',message:String(e)});}finally{lock.releaseLock();}}function responseJSON(data){return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);}</div></div><div class="guide-step">4. é»æ“Šå³ä¸Šè§’ <b>éƒ¨ç½² > æ–°å¢éƒ¨ç½² > ç¶²é æ‡‰ç”¨ç¨‹å¼</b>ã€‚<br>è¨­å®šï¼šåŸ·è¡Œèº«åˆ†=<b>æˆ‘</b>ï¼Œèª°å¯ä»¥å­˜å–=<b>æ‰€æœ‰äºº</b> (é‡è¦!)ã€‚</div><div class="guide-step">5. é»æ“Šã€Œéƒ¨ç½²ã€ã€‚<br><span class="text-danger small"><i class="bi bi-exclamation-triangle"></i> è‹¥å‡ºç¾ã€ŒGoogle hasn't verified this appã€è­¦å‘Šï¼šé»æ“Šå·¦ä¸‹è§’ <b>Advanced (é€²éš)</b> â†’ æœ€ä¸‹æ–¹ <b>Go to ... (unsafe)</b> â†’ <b>Allow (å…è¨±)</b>ã€‚</span></div><div class="guide-step">6. è¤‡è£½ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€ä¸¦è²¼åœ¨ä¸‹æ–¹æ¬„ä½ã€‚</div></div></div>
                    <div class="mb-3"><label class="small text-muted fw-bold">Google Apps Script ç¶²å€ (Web App URL)</label><input v-model="gasUrl" type="password" class="form-control form-control-sm" placeholder="https://script.google.com/macros/s/..."><div class="small mt-1" :class="gasUrl ? 'text-success' : 'text-muted'">ç‹€æ…‹ï¼š{{ gasUrl ? 'âœ… å·²é€£çµ' : 'å°šæœªé€£çµ' }}</div></div>
                    <div class="d-grid gap-2"><div class="btn-group"><button @click="syncCloud('backup', 'inventory')" class="btn btn-primary btn-sm"><i class="bi bi-cloud-upload"></i> å‚™ä»½åº«å­˜</button><button @click="syncCloud('restore', 'inventory')" class="btn btn-outline-primary btn-sm"><i class="bi bi-cloud-download"></i> é‚„åŸåº«å­˜</button></div><div class="btn-group"><button @click="syncCloud('backup', 'expenses')" class="btn btn-success btn-sm"><i class="bi bi-cloud-upload"></i> å‚™ä»½å¸³å–®</button><button @click="syncCloud('restore', 'expenses')" class="btn btn-outline-success btn-sm"><i class="bi bi-cloud-download"></i> é‚„åŸå¸³å–®</button></div></div>
                </div>

                <div class="card p-3">
                    <h5 class="mb-3">æœ¬æ©Ÿæª”æ¡ˆç®¡ç†</h5>
                    <div class="card bg-light mb-3"><div class="card-body p-2"><h6 class="fw-bold mb-2">è³‡æ–™åº«æ¸…å–®ï¼š</h6><div class="db-list-item"><span class="db-badge">1</span> ç‰©å“åº«å­˜ (Inventory)</div><div class="db-list-item"><span class="db-badge">2</span> è³¬å–®ç´€éŒ„ (Expenses)</div><div class="db-list-item"><span class="db-badge">3</span> å…¬å¸è³‡æ–™ (Company DB)</div></div></div>
                    <div class="d-grid gap-2">
                        <button @click="prepareFileExport('json')" class="btn btn-outline-primary text-start p-3"><i class="bi bi-filetype-json me-2"></i> å®Œæ•´å‚™ä»½ (All_Backup.json)</button>
                        <hr class="my-1">
                        <button @click="prepareFileExport('inventory_csv')" class="btn btn-outline-success text-start"><i class="bi bi-file-earmark-spreadsheet me-2"></i> 1_Inventory.csv</button>
                        <button @click="prepareFileExport('expense_csv')" class="btn btn-outline-info text-start"><i class="bi bi-file-earmark-text me-2"></i> 2_Expenses.csv</button>
                        <button @click="prepareFileExport('company_db')" class="btn btn-outline-secondary text-start"><i class="bi bi-building me-2"></i> 3_CompanyDB.json</button>
                    </div>
                    <hr>
                    <label class="form-label fw-bold">ğŸ“¥ è³‡æ–™é‚„åŸ (JSON/CSV)</label><input type="file" ref="fileInput" @change="handleFileImport" class="form-control" accept=".json,.csv">
                </div>
            </div>

            <nav class="bottom-nav d-md-none">
                <a href="#" class="nav-btn" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'"><i class="bi bi-box-seam"></i><span>ç‰©å“</span></a>
                <a href="#" class="nav-btn" :class="{active: currentTab === 'expenses'}" @click="currentTab = 'expenses'"><i class="bi bi-receipt"></i><span>è³¬å–®</span></a>
                <a href="#" class="nav-btn" :class="{active: currentTab === 'settings'}" @click="currentTab = 'settings'"><i class="bi bi-gear"></i><span>è¨­å®š</span></a>
            </nav>
            <div class="app-footer">è±ç‹‚å‡ºå“ â€¢ æ™ºæ…§ç®¡å®¶</div>
        </div>

    <div v-if="showAiInventoryModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-gradient bg-primary text-white"><h5 class="modal-title">ğŸ¤– æ™ºèƒ½ç‰©å“å…¥åº«</h5><button @click="showAiInventoryModal = false" class="btn-close btn-close-white"></button></div><div class="modal-body"><div class="btn-group w-100 mb-3" role="group"><button @click="selectedAI='gemini'" class="btn btn-sm" :class="selectedAI==='gemini'?'btn-primary':'btn-outline-primary'">Gemini</button><button @click="selectedAI='grok'" class="btn btn-sm" :class="selectedAI==='grok'?'btn-dark':'btn-outline-dark'">Grok</button><button @click="selectedAI='chatgpt'" class="btn btn-sm" :class="selectedAI==='chatgpt'?'btn-success':'btn-outline-success'">ChatGPT</button></div><p class="small text-muted">è²¼ä¸Šå•†å“æ–‡å­—æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•å»æ‹ç…§ï¼š</p><textarea v-model="pastedText" class="form-control mb-2" rows="2" placeholder="ä¾‹: æƒ åº· ç¶­ä»–å¥¶ $20..."></textarea><div class="d-grid gap-2"><button @click="copyAndOpenAI('text')" class="btn btn-outline-secondary">ğŸ“ æ–‡å­—æŒ‡ä»¤</button><button @click="copyAndOpenAI('image')" class="btn btn-primary">ğŸ“¸ è®€åœ–æŒ‡ä»¤</button></div><div v-if="stagedItems.length > 0" class="mt-3 border-top pt-3"><h6 class="fw-bold">é è¦½çµæœ ({{ stagedItems.length }})</h6><div v-for="(item, idx) in stagedItems" :key="idx" class="card mb-2 preview-card bg-light"><div class="card-body p-2"><input v-model="item.name" class="form-control form-control-sm mb-1 fw-bold"><div class="row g-1"><div class="col-4"><input v-model.number="item.latestPrice" type="number" class="form-control form-control-sm"></div><div class="col-4"><input v-model="item.brand" class="form-control form-control-sm" placeholder="å“ç‰Œ"></div><div class="col-4"><input v-model="item.unitPrice" class="form-control form-control-sm" placeholder="å–®ä½"></div></div></div></div><button @click="confirmStagedImport" class="btn btn-success w-100">ç¢ºèªå…¥åº«</button></div></div></div></div></div>
    
    <div v-if="showAiReceiptModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-gradient bg-success text-white"><h5 class="modal-title">ğŸ§¾ AI å–®æ“šæƒæ</h5><button @click="showAiReceiptModal = false" class="btn-close btn-close-white"></button></div><div class="modal-body"><div class="btn-group w-100 mb-3"><button @click="selectedAI='gemini'" class="btn btn-sm" :class="selectedAI==='gemini'?'btn-primary':'btn-outline-primary'">Gemini</button><button @click="selectedAI='grok'" class="btn btn-sm" :class="selectedAI==='grok'?'btn-dark':'btn-outline-dark'">Grok</button><button @click="selectedAI='chatgpt'" class="btn btn-sm" :class="selectedAI==='chatgpt'?'btn-success':'btn-outline-success'">ChatGPT</button></div><button @click="copyReceiptPrompt" class="btn btn-success w-100 py-2 fw-bold"><i class="bi bi-camera-fill"></i> è¤‡è£½æŒ‡ä»¤ä¸¦æƒæå–®æ“š</button><div class="small text-muted mt-2 text-center">è·³è½‰å¾Œè«‹ä¸Šå‚³å–®æ“šç…§ç‰‡ï¼Œè¤‡è£½ JSON å¾ŒæŒ‰è¿”å›é€£çµã€‚</div></div></div></div></div>

    <div v-if="showMonthlyModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="bi bi-calendar3"></i> æ¯æœˆæ”¯å‡ºçµ±è¨ˆ</h5><button @click="showMonthlyModal = false" class="btn-close btn-close-white"></button></div><div class="modal-body p-0"><table class="table table-striped mb-0 text-center"><thead class="table-light"><tr><th>æœˆä»½</th><th>ç¸½æ”¯å‡º</th></tr></thead><tbody><tr v-for="stat in monthlyStats" :key="stat.month"><td>{{ stat.month }}</td><td class="fw-bold text-danger">${{ stat.total.toLocaleString() }}</td></tr><tr v-if="monthlyStats.length===0"><td colspan="2" class="py-3">æš«ç„¡è³‡æ–™</td></tr></tbody></table></div></div></div></div>
    <div v-if="showLostDataWarning" class="modal d-block" style="z-index: 2000;"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-danger"><div class="modal-header bg-danger text-white"><h5 class="modal-title">è­¦å‘Šï¼šè³‡æ–™åº«ç©ºç™½ï¼</h5></div><div class="modal-body"><p>æ‚¨å¯èƒ½åœ¨ App å…§éƒ¨ç€è¦½å™¨ä¸­ã€‚è«‹ç”¨ Safari/Chrome é–‹å•Ÿã€‚</p></div><div class="modal-footer"><button @click="showLostDataWarning=false" class="btn btn-secondary">é—œé–‰</button></div></div></div></div>
    <div v-if="showFileExportModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ğŸ“¤ æª”æ¡ˆè¼¸å‡º</h5><button @click="showFileExportModal=false" class="btn-close"></button></div><div class="modal-body d-grid gap-3"><button @click="executeExport('share')" class="btn btn-lg btn-success text-start"><i class="bi bi-whatsapp me-2"></i> <b>ç³»çµ±åˆ†äº«</b></button><button @click="executeExport('download')" class="btn btn-lg btn-outline-secondary text-start"><i class="bi bi-download me-2"></i> <b>ä¸‹è¼‰æª”æ¡ˆ</b></button></div></div></div></div>
    <div v-if="showExportModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">å‚³é€å…§å®¹</h5><button @click="showExportModal=false" class="btn-close"></button></div><div class="modal-body d-grid gap-2"><button @click="confirmExport('buy')" class="btn btn-outline-primary text-start fw-bold">ğŸ›’ éœ€è³¼è²·æ¸…å–®</button><button @click="confirmExport('inventory')" class="btn btn-outline-success text-start fw-bold">ğŸ“¦ åº«å­˜æ¸…å–®</button><button @click="confirmExport('links')" class="btn btn-outline-info text-start fw-bold">ğŸ”— ç‰©å“é€£çµ</button></div></div></div></div>
    <div v-if="showOrderDetailModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-light"><h5 class="modal-title">ğŸ“œ è¨‚å–®æ˜ç´°</h5><button @click="showOrderDetailModal=false" class="btn-close"></button></div><div class="modal-body p-0"><div class="p-3 border-bottom"><div class="fw-bold">{{ viewingOrder.date }} ({{ viewingOrder.category }})</div><div class="mt-1 text-primary fw-bold">{{ viewingOrder.note }}</div><div v-if="viewingOrder.address" class="small text-muted mt-1"><i class="bi bi-geo-alt"></i> {{ viewingOrder.address }}</div></div><table class="table table-sm mb-0"><thead class="table-light"><tr><th>ç‰©å“</th><th>å–®åƒ¹ x æ•¸é‡</th><th>å°è¨ˆ</th></tr></thead><tbody><tr v-for="(itm, idx) in viewingOrder.items" :key="idx"><td>{{ itm.name }}</td><td>${{ itm.price }} x {{ itm.qty }}</td><td class="text-end pe-3">${{ (itm.price * itm.qty).toFixed(1) }}</td></tr></tbody><tfoot class="table-group-divider"><tr><td colspan="2" class="text-end fw-bold">ç¸½è¨ˆ:</td><td class="text-end pe-3 fw-bold text-danger">${{ viewingOrder.amount }}</td></tr></tfoot></table><div class="p-3"><button @click="editOrderFromModal" class="btn btn-outline-primary w-100">ç·¨è¼¯æ­¤å–®</button></div></div></div></div></div>
    
    <div v-if="showAddModal || showEditModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">{{ showEditModal ? 'ç·¨è¼¯' : 'æ–°å¢' }}</h5><button @click="closeModal" class="btn-close"></button></div><div class="modal-body"><div class="row g-2 mb-2"><div class="col-6"><label class="small">åˆ†é¡</label><select v-model="editingForm.categoryId" class="form-select"><option v-for="cat in categories" :value="cat.id">{{ cat.name }}</option></select></div><div class="col-6"><label class="small">å“ç‰Œ</label><input v-model="editingForm.brand" class="form-control"></div></div><div class="mb-2"><label class="small">åç¨±</label><textarea v-model="editingForm.name" class="form-control" rows="2"></textarea></div><div class="row g-2 mb-2"><div class="col-4"><label class="small">åº«å­˜</label><input v-model.number="editingForm.stock" type="number" class="form-control"></div><div class="col-4"><label class="small">ç¸½åƒ¹</label><input v-model.number="editingForm.latestPrice" type="number" class="form-control"></div><div class="col-4"><label class="small">å–®åƒ¹</label><input v-model.number="editingForm.unitPrice" class="form-control"></div></div><div class="mb-2"><label class="small">ç¶²å€</label><input v-model="editingForm.url" class="form-control"></div></div><div class="modal-footer"><button @click="closeModal" class="btn btn-secondary">å–æ¶ˆ</button><button @click="saveItem" class="btn btn-primary">å„²å­˜</button></div></div></div></div></div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            currentView: 'landing', // [v15.1] New State
            currentTab: 'inventory', geminiMode: 'app', apiKey: '', searchQuery: '', gasUrl: '',
            isLoading: false, loadingMessage: '', showDeployGuide: false,
            selectedAI: 'gemini', inventory: [], expenses: [], selectedIds: [], inputMode: 'text',
            
            showAddModal: false, showEditModal: false, showExportModal: false, showOrderDetailModal: false, showLostDataWarning: false, showMonthlyModal: false, showFileExportModal: false, showAiInventoryModal: false, showAiReceiptModal: false,
            showAiImportPanel: false, showAiReceiptPanel: false,
            
            exportActionType: '', editingForm: {}, viewingOrder: {}, monthlyStats: [],
            importJsonText: '', receiptJsonText: '', pastedText: '', isAnalyzing: false, selectedItemForAnalysis: null, 
            isWaitingForPaste: false, isWaitingForReceiptPaste: false, 
            currentImportType: '', currentExportType: '', stagedItems: [],

            newExpense: { date: new Date().toISOString().split('T')[0], category: 'è¶…ç´šå¸‚å ´', amount: 0, subtotal: 0, note: '', refNumber: '', items: [], discount: 0, address: '', mapUrl: '' },
            selectedInventoryItem: null, tempQty: 1, selectedStore: '', customStoreInput: '',
            isEditingExpense: false, editingExpenseIndex: -1,

            filterCategory: '', filterBrand: '', sortOption: 'default', colSortKey: '', colSortOrder: 'asc', expenseSearchQuery: '', selectedExpenseIds: [], expenseSortKey: 'date', expenseSortOrder: 'desc',

            companyDB: { 
                "æ°´è²»": [], "é›»è²»": [], "ç…¤æ°£/çŸ³æ²¹æ°£": [], "ç§å®¶è»Šå…¥æ²¹": [], "å¯¬é »": [], "é›»è©±è²»": [], "é›²ç«¯åŠAI": [], "ä¸²æµå½±ç‰‡": [], "éŸ³æ¨‚ä¸²æµ": [], "å¥èº«æœƒç±": [], "é†«ç™‚ä¿éšª": [], "æŒ‰æ­ä¾›æ¬¾": [], "ç®¡ç†è²»": [], "è¶…ç´šå¸‚å ´": [], "é£²é£Ÿ": [], "äº¤é€š(å…«é”é€š)": [], "è»Šè³‡": [], "ç¶²è³¼": [] 
            },
            
            defaultCompanies: {
                "æ°´è²»": ["æ°´å‹™ç½²"], "é›»è²»": ["ä¸­é›»", "æ¸¯ç‡ˆ"], "ç…¤æ°£/çŸ³æ²¹æ°£": ["Towngas", "å”å’Œ", "ä¸­çŸ³åŒ–", "æ¨™æº–", "ç¾å­š", "èœ†æ®¼", "æ–°æµ·", "åŠå³¶", "åŠ å¾·å£«"], "ç§å®¶è»Šå…¥æ²¹": ["Shell", "Esso", "åŠ å¾·å£«", "ä¸­çŸ³åŒ–", "ä¸­æ²¹", "ECO"], "å¯¬é »": ["Netvigator", "HKBN", "HGC", "i-CABLE", "CMHK"], "é›»è©±è²»": ["csl", "1O1O", "SmarTone", "CMHK", "3HK", "HKT", "HKBN"], "é›²ç«¯åŠAI": ["AWS", "Azure", "GCP", "é˜¿é‡Œé›²", "ChatGPT", "Gemini", "Grok", "Perplexity", "Copilot", "MJ"], "ä¸²æµå½±ç‰‡": ["Netflix", "Disney+", "Max", "AppleTV+", "Viu", "hmvod", "NowE"], "éŸ³æ¨‚ä¸²æµ": ["Spotify", "AppleMusic", "KKBOX"], "å¥èº«æœƒç±": ["PURE", "Anytime", "24/7Fitness"], "é†«ç™‚ä¿éšª": ["AXA", "Bupa", "Bowtie", "BlueCross", "FWD", "Manulife", "Pru"], "æŒ‰æ­ä¾›æ¬¾": ["HSBC", "æ’ç”Ÿ", "ä¸­éŠ€", "æ¸£æ‰“"], "ç®¡ç†è²»": ["å±‹è‹‘ç®¡ç†è™•", "ç‰©ç®¡å…¬å¸"], "è¶…ç´šå¸‚å ´": ["æƒ åº·", "ç™¾ä½³", "AEON", "MarketPlace", "FUSION", "TASTE", "cityâ€™super", "HKTVmall"], "é£²é£Ÿ": ["éº¥ç•¶å‹", "å¤§å®¶æ¨‚", "å¤§å¿«æ´»", "ç¿ è¯", "Starbucks", "PacificCoffee"], "äº¤é€š(å…«é”é€š)": ["å…«é”é€š", "MTR", "KMB", "CTB", "LWB"], "è»Šè³‡": ["çš„å£«", "Uber"], "ç¶²è³¼": ["HKTVmall", "Taobao", "Tmall", "JD", "Amazon"]
            },

            categories: [ { id: '10', name: 'é£Ÿå“/ä¹¾ç³§' }, { id: '20', name: 'é£²å“' }, { id: '30', name: 'å®¶å±…æ¸…æ½”' }, { id: '40', name: 'å€‹äººè­·ç†' }, { id: '50', name: 'ç´™å“/è¡›ç”Ÿ' }, { id: '60', name: 'å»šæˆ¿ç”¨å“' }, { id: '70', name: 'è—¥å“/ä¿å¥' }, { id: '99', name: 'å…¶ä»–' } ],
            toasts: []
        };
    },
    computed: {
        filteredInventory() { const query = this.searchQuery.toLowerCase().trim(); if (!query) return this.inventory; return this.inventory.filter(item => { const matchName = item.name.toLowerCase().includes(query); const matchBrand = item.brand && item.brand.toLowerCase().includes(query); return matchName || matchBrand; }); },
        selectedItems() { return this.inventory.filter(item => this.selectedIds.includes(item.id)); },
        sortedExpenses() { return this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)); },
        currentCompanyOptions() { return this.companyDB[this.newExpense.category] || []; },
        isShoppingCategory() { return ['è¶…ç´šå¸‚å ´', 'ç¶²è³¼', 'é£²é£Ÿ'].includes(this.newExpense.category); },
        
        // v15.0 Re-adds
        uniqueBrands() { return [...new Set(this.inventory.map(i => i.brand).filter(b => b))].sort(); },
        filteredInventory() {
            let list = this.inventory;
            const query = this.searchQuery.toLowerCase().trim();
            if (query) list = list.filter(i => (i.name||'').toLowerCase().includes(query) || (i.brand||'').toLowerCase().includes(query));
            if (this.filterCategory) list = list.filter(i => i.categoryId === this.filterCategory);
            if (this.filterBrand) list = list.filter(i => i.brand === this.filterBrand);
            
            if (this.colSortKey) {
                 list.sort((a, b) => {
                    let valA = a[this.colSortKey] || ''; let valB = b[this.colSortKey] || '';
                    if (typeof valA === 'number') return this.colSortOrder === 'asc' ? valA - valB : valB - valA;
                    return this.colSortOrder === 'asc' ? valA.toString().localeCompare(valB) : valB.toString().localeCompare(valA);
                });
            } else if (this.sortOption === 'stock_asc') list.sort((a, b) => (a.stock || 0) - (b.stock || 0));
            else if (this.sortOption === 'stock_desc') list.sort((a, b) => (b.stock || 0) - (a.stock || 0));
            
            return list;
        },
        isAllInventorySelected() { return this.filteredInventory.length > 0 && this.selectedIds.length === this.filteredInventory.length; },
        
        filteredExpenses() {
            let list = this.expenses;
            const query = this.expenseSearchQuery.toLowerCase().trim();
            if (query) list = list.filter(e => (e.note||'').toLowerCase().includes(query) || e.category.toLowerCase().includes(query) || e.amount.toString().includes(query));
            if (this.expenseSortKey === 'date') list.sort((a, b) => this.expenseSortOrder === 'asc' ? new Date(a.date) - new Date(b.date) : new Date(b.date) - new Date(a.date));
            return list;
        }
    },
    watch: { 'newExpense.items': { handler() { this.updateCalculatedAmount(); }, deep: true }, 'newExpense.discount': function() { this.updateCalculatedAmount(); }, 'newExpense.subtotal': function() { this.updateCalculatedAmount(); } },
    mounted() { 
        this.loadData(); 
        
        // Auto-Enter if data exists
        if(this.inventory.length > 0 || this.expenses.length > 0) {
            this.currentView = 'app';
        }

        // v9.4 Smart Merge
        if (Object.keys(this.companyDB).length === 0) {
             for(let k in this.defaultCompanies) { this.companyDB[k] = this.defaultCompanies[k].map(n => ({ name: n, address: '', mapUrl: '' })); }
        } else {
             for(let k in this.defaultCompanies) {
                 if (!this.companyDB[k] || this.companyDB[k].length === 0) {
                     this.companyDB[k] = this.defaultCompanies[k].map(n => ({ name: n, address: '', mapUrl: '' }));
                 }
             }
        }
        
        // Default select
        this.selectedStore = this.currentCompanyOptions[0] ? this.currentCompanyOptions[0].name : 'other';

        const params = new URLSearchParams(window.location.search);
        const hash = window.location.hash;
        
        if (hash.includes('import_inventory')) {
            this.currentView = 'app';
            this.currentTab = 'inventory'; this.showAiImportPanel = true; this.clearHash();
            setTimeout(() => { if (this.$refs.inventoryPasteRef) { this.$refs.inventoryPasteRef.focus(); this.$refs.inventoryPasteRef.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }, 500);
        } else if (hash.includes('import_expenses')) {
            this.currentView = 'app';
            this.currentTab = 'expenses'; this.showAiReceiptPanel = true; this.clearHash();
            setTimeout(() => { if (this.$refs.receiptPasteRef) { this.$refs.receiptPasteRef.focus(); this.$refs.receiptPasteRef.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }, 500);
        }
    },
    methods: {
        // [v15.1] Landing Page Actions
        enterSystem() { this.currentView = 'app'; },
        startFresh() { if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡æ–°é–‹å§‹å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } },
        loadDemoData() {
            this.isLoading = true; this.loadingMessage = "æ­£åœ¨ä¸‹è¼‰ç¤ºç¯„è³‡æ–™...";
            fetch('https://fungccc.github.io/HomeStock/demo/HomeStock_demo.json')
                .then(res => res.json())
                .then(data => {
                     this.inventory = data.inventory || [];
                     this.expenses = data.expenses || [];
                     if(data.companyDB) this.companyDB = data.companyDB;
                     this.saveData();
                     this.showToast('ç¤ºç¯„è³‡æ–™è¼‰å…¥æˆåŠŸ', 'success');
                     this.currentView = 'app';
                })
                .catch(err => this.showToast('è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'danger'))
                .finally(() => this.isLoading = false);
        },

        showToast(msg, type='success') { const id = Date.now(); this.toasts.push({ id, msg, type }); setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id); }, 3000); },
        removeToast(id) { this.toasts = this.toasts.filter(t => t.id !== id); },
        getToastIcon(type) { if(type==='success') return 'bi-check-circle-fill'; if(type==='danger') return 'bi-x-circle-fill'; return 'bi-info-circle-fill'; },
        getCategoryNameFromTab() { if(this.currentTab==='inventory') return 'ç‰©å“ç®¡ç†'; if(this.currentTab==='expenses') return 'è³¬å–®åˆ—è¡¨'; return 'ç³»çµ±è¨­å®š'; },
        saveData() { localStorage.setItem('goodHusbandDB_v15', JSON.stringify({ inventory: this.inventory, expenses: this.expenses, companyDB: this.companyDB, gasUrl: this.gasUrl })); },
        loadData() { 
            let data = localStorage.getItem('goodHusbandDB_v15') || localStorage.getItem('goodHusbandDB_v12'); 
            if (data) { 
                try {
                    let p = JSON.parse(data); 
                    this.inventory = p.inventory || []; 
                    this.expenses = p.expenses || []; 
                    this.gasUrl = p.gasUrl || ''; 
                    if(p.companyDB) {
                        this.companyDB = p.companyDB;
                        for(let key in this.companyDB) {
                            this.companyDB[key] = this.companyDB[key].map(item => {
                                return (typeof item === 'string') ? { name: item, address: '', mapUrl: '' } : item;
                            });
                        }
                    }
                } catch(e) { console.log('Init data error', e); }
            } 
        },
        saveSettings() { this.saveData(); this.showToast('è¨­å®šå·²å„²å­˜ï¼'); }, getCategoryName(id) { const c = this.categories.find(x => x.id == id); return c ? c.name : 'æœªåˆ†é¡'; },
        
        async syncCloud(action, type) {
            if(!this.gasUrl) return this.showToast("è«‹å…ˆè¨­å®š GAS URL", 'warning');
            this.isLoading = true; this.loadingMessage = action === 'backup' ? 'æ­£åœ¨å‚™ä»½...' : 'æ­£åœ¨é‚„åŸ...';
            const targetUrl = `${this.gasUrl}${this.gasUrl.includes('?') ? '&' : '?'}sheet=${type}`;
            try {
                if (action === 'backup') { const dataTo = type === 'inventory' ? this.inventory : this.expenses; await fetch(targetUrl, { method: 'POST', body: JSON.stringify(dataTo) }).then(res => res.json()).then(data => { if(data.status === 'success') this.showToast(`âœ… ${type==='inventory'?'åº«å­˜':'å¸³å–®'}å‚™ä»½æˆåŠŸï¼`); else throw new Error(data.message); }); } 
                else { await fetch(targetUrl).then(res => res.json()).then(data => { if(Array.isArray(data)) { if(type === 'inventory') { this.inventory = data.map(i => ({...i, latestPrice: parseFloat(i.latestPrice)||0, stock: parseFloat(i.stock)||0 })); } else { this.expenses = data.map(e => ({...e, amount: parseFloat(e.amount)||0, items: typeof e.items === 'string' ? JSON.parse(e.items) : (e.items || []) })); } this.saveData(); this.showToast(`âœ… é‚„åŸæˆåŠŸï¼Œå…± ${data.length} ç­†`); } }); }
            } catch (e) { this.showToast("æ“ä½œå¤±æ•—: " + e.message, 'danger'); } finally { this.isLoading = false; }
        },
        copyGasCode() { const code = `function doGet(e){return handleRequest(e);}function doPost(e){return handleRequest(e);}function handleRequest(e){var lock=LockService.getScriptLock();lock.tryLock(10000);try{var ss=SpreadsheetApp.getActiveSpreadsheet();var sheetName=e.parameter.sheet||'inventory';var sheet=ss.getSheetByName(sheetName);if(!sheet){sheet=ss.insertSheet(sheetName);}if(e.postData){var data=JSON.parse(e.postData.contents);if(!Array.isArray(data)||data.length===0){sheet.clear();return responseJSON({status:'success',message:'å·²æ¸…ç©ºè³‡æ–™è¡¨'});}var headers=Object.keys(data[0]);var rows=data.map(function(row){return headers.map(function(key){var val=row[key];if(typeof val==='object'&&val!==null){return JSON.stringify(val);}return String(val||"");});});sheet.clear();sheet.getRange(1,1,1,headers.length).setValues([headers]);if(rows.length>0){sheet.getRange(2,1,rows.length,headers.length).setValues(rows);}return responseJSON({status:'success',message:'å‚™ä»½æˆåŠŸ'});}else{var dataRange=sheet.getDataRange();var values=dataRange.getValues();if(values.length<2){return responseJSON([]);}var headers=values.shift();var result=values.map(function(row){var obj={};headers.forEach(function(header,index){var cellValue=row[index];try{if(typeof cellValue==='string'&&(cellValue.startsWith('[')||cellValue.startsWith('{'))){obj[header]=JSON.parse(cellValue);}else{obj[header]=cellValue;}}catch(e){obj[header]=cellValue;}});return obj;});return responseJSON(result);}}catch(e){return responseJSON({status:'error',message:String(e)});}finally{lock.releaseLock();}}function responseJSON(data){return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);}`; navigator.clipboard.writeText(code).then(() => this.showToast("ä»£ç¢¼å·²è¤‡è£½ï¼", 'success')); },
        
        toggleSort(key) { if(this.colSortKey===key){this.colSortOrder=this.colSortOrder==='asc'?'desc':'asc';}else{this.colSortKey=key;this.colSortOrder='asc';} },
        getSortIcon(key) { if(this.colSortKey!==key) return 'bi-arrow-down-up text-muted'; return this.colSortOrder==='asc'?'bi-arrow-up text-primary':'bi-arrow-down text-primary'; },
        toggleSelectAllInventory() { if (this.isAllInventorySelected) { this.selectedIds = []; } else { this.selectedIds = this.filteredInventory.map(i => i.id); } },
        isSelected(item) { return this.selectedIds.includes(item.id); }, toggleSelection(item) { const id = item.id; if(this.selectedIds.includes(id)) this.selectedIds=this.selectedIds.filter(i=>i!==id); else this.selectedIds.push(id); }, selectAll(doSelect) { this.selectedIds = doSelect ? this.filteredInventory.map(i => i.id) : []; },
        toggleExpenseSort(key) { if(this.expenseSortKey===key){this.expenseSortOrder=this.expenseSortOrder==='asc'?'desc':'asc';}else{this.expenseSortKey=key;this.expenseSortOrder='asc';} },
        getExpenseSortIcon(key) { if(this.expenseSortKey!==key) return 'bi-arrow-down-up text-muted'; return this.expenseSortOrder==='asc'?'bi-arrow-up text-primary':'bi-arrow-down text-primary'; },
        isExpenseSelected(exp) { return this.selectedExpenseIds.includes(exp.id); }, toggleExpenseSelection(exp) { const id=exp.id; if(this.selectedExpenseIds.includes(id)) this.selectedExpenseIds=this.selectedExpenseIds.filter(i=>i!==id); else this.selectedExpenseIds.push(id); },
        actionExpenseDetail() { if(this.selectedExpenseIds.length!==1)return; const exp=this.expenses.find(e=>e.id===this.selectedExpenseIds[0]); if(exp&&exp.items&&exp.items.length>0)this.viewOrderDetails(exp); else this.showToast("æ­¤ç´€éŒ„ç„¡æ˜ç´°", 'warning'); },
        actionExpenseEdit() { if(this.selectedExpenseIds.length!==1)return; const exp=this.expenses.find(e=>e.id===this.selectedExpenseIds[0]); this.editExpenseDirectly(exp); this.selectedExpenseIds=[]; },
        actionExpenseDelete() { if(!confirm(`ç¢ºå®šåˆªé™¤é€™ ${this.selectedExpenseIds.length} ç­†ç´€éŒ„ï¼Ÿ`))return; this.expenses=this.expenses.filter(e=>!this.selectedExpenseIds.includes(e.id)); this.selectedExpenseIds=[]; this.saveData(); this.showToast('å·²åˆªé™¤', 'success'); },
        
        prepareExport(type) { this.exportActionType = type; this.showExportModal = true; }, confirmExport(format) { this.showExportModal = false; let text = ""; if (format === 'buy') text = "ğŸ›’ *éœ€è³¼è²·æ¸…å–®*ï¼š\n" + this.selectedItems.map(i => `- ${i.name} (åº«å­˜:${i.stock})`).join('\n'); else if (format === 'inventory') text = "ğŸ“¦ *åº«å­˜æ¸…å–®*ï¼š\n" + this.selectedItems.map(i => `- ${i.name} [${i.brand||''}] | $${i.latestPrice||'-'}`).join('\n'); else if (format === 'links') text = "ğŸ”— *ç‰©å“é€£çµ*ï¼š\n" + this.selectedItems.map(i => `- ${i.name}\n  ${i.url || 'ç„¡é€£çµ'}`).join('\n'); if (this.exportActionType === 'whatsapp') window.location.href = `whatsapp://send?text=${encodeURIComponent(text)}`; else if (this.exportActionType === 'share') { if (navigator.share) navigator.share({title:'åº«å­˜', text:text}); else this.showToast("ä¸æ”¯æ´åˆ†äº«", 'warning'); } else if (this.exportActionType === 'copy') navigator.clipboard.writeText(text).then(()=>this.showToast('å·²è¤‡è£½')); },
        clearHash() { history.replaceState(null, null, ' '); }, openTargetAI(url) { window.open(url, "_blank"); }, getAiUrl() { if (this.selectedAI === 'grok') return 'https://x.com/i/grok'; if (this.selectedAI === 'chatgpt') return 'https://chatgpt.com/'; return 'https://gemini.google.com/app'; },
        openAiInventoryModal() { this.showAiInventoryModal = true; },
        copyAndOpenAI(mode) { const returnUrl = window.location.href.split('#')[0] + "#import_inventory"; let contentText = mode === 'image' ? "(è«‹ç­‰å¾…æˆ‘ä¸Šå‚³åœ–ç‰‡)" : (this.pastedText || "ï¼ˆç„¡å…§å®¹ï¼‰"); let actionInstruction = mode === 'image' ? "è«‹åˆ†ææˆ‘ä¸Šå‚³çš„åœ–ç‰‡ã€‚" : "è«‹å°‡æˆ‘æä¾›çš„å•†å“å…§å®¹è½‰æ›ç‚º JSON æ ¼å¼ã€‚"; let extra = this.selectedAI === 'grok' ? `\n(âš ï¸ æ³¨æ„ï¼šGrok App è«‹æ‰‹å‹•åˆ‡æ›å›ç€è¦½å™¨è²¼ä¸Š)\n` : ''; const prompt = `ä½ ç¾åœ¨æ˜¯æˆ‘çš„ã€Œå®¶å±…åº«å­˜è³‡æ–™æ•´ç†å“¡ã€ã€‚${actionInstruction}\n\n1. è¼¸å‡ºæ ¼å¼ï¼šåš´æ ¼åªè¼¸å‡º JSON Array (ä»£ç¢¼å¡Š) [...]ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚\n2. æ¬„ä½ï¼šname, brand, categoryId, latestPrice (æ•¸å­—), unitPrice (å¦‚ 2/åŒ…), url\n3. åˆ†é¡IDè¡¨ï¼š10:é£Ÿå“, 20:é£²å“, 30:æ¸…æ½”, 40:è­·ç†, 50:è¡›ç”Ÿ, 60:å»šæˆ¿, 70:è—¥å“, 99:å…¶ä»–\n${extra}éå¸¸é‡è¦ï¼šè«‹åœ¨ JSON è¼¸å‡ºçµæŸå¾Œï¼Œæ–°èµ·ä¸€è¡Œï¼Œé™„ä¸Šé€™å€‹è¿”å›é€£çµï¼š\n[â†©ï¸ é»æ“Šé€™è£¡è¿”å›ç³»çµ±åŒ¯å…¥](${returnUrl})\n\næˆ‘çš„è¼¸å…¥å…§å®¹ï¼š\n${contentText}`; navigator.clipboard.writeText(prompt).then(() => { this.openTargetAI(this.getAiUrl()); }); },
        processImportData() { try { let cleanText = this.importJsonText.replace(/[\u201C\u201D]/g, '"').replace(/```json/g, '').replace(/```/g, ''); const linkIndex = cleanText.indexOf('[â†©ï¸'); if (linkIndex !== -1) cleanText = cleanText.substring(0, linkIndex); const firstBracket = cleanText.indexOf('['); const lastBracket = cleanText.lastIndexOf(']'); if (firstBracket !== -1 && lastBracket !== -1) cleanText = cleanText.substring(firstBracket, lastBracket + 1); const list = JSON.parse(cleanText); this.stagedItems = list.map(item => { const existingItem = this.inventory.find(inv => inv.name === item.name); return { ...item, id: existingItem ? existingItem.id : Date.now() + Math.random().toString(36).substr(2, 5), stock: existingItem ? existingItem.stock : 0 }; }); this.confirmStagedImport(); } catch (e) { this.showToast('JSON éŒ¯èª¤', 'danger'); } },
        confirmStagedImport() { this.stagedItems.forEach(item => { const idx = this.inventory.findIndex(inv => inv.id === item.id); if (idx !== -1) this.inventory[idx] = { ...this.inventory[idx], ...item, latestPrice: item.latestPrice }; else this.inventory.push({ ...item, priceHistory: [] }); }); this.stagedItems = []; this.importJsonText = ''; this.showAiImportPanel = false; this.showAiInventoryModal = false; this.saveData(); this.showToast('æ›´æ–°æˆåŠŸ', 'success'); },
        testInventoryJson() { this.importJsonText = JSON.stringify([{ "name": "æ¸¬è©¦å•†å“", "brand": "Demo", "categoryId": "10", "latestPrice": 100, "unitPrice": "1ä»¶", "url": "" }], null, 2); },
        
        openAiReceiptModal() { this.showAiReceiptModal = true; },
        // [v15.0 Updated Prompt: Address & Map]
        copyReceiptPrompt() { const returnUrl = window.location.href.split('#')[0] + "#import_expenses"; let extra = this.selectedAI === 'grok' ? `\n(âš ï¸ æ³¨æ„ï¼šGrok App è«‹æ‰‹å‹•åˆ‡æ›å›ç€è¦½å™¨)\n` : ''; const prompt = `ä½ ç¾åœ¨æ˜¯æˆ‘çš„ã€Œæ”¶æ“š/ç™¼ç¥¨åˆ†æå“¡ã€ã€‚è«‹åˆ†ææˆ‘ä¸Šå‚³çš„åœ–ç‰‡ã€‚\nè«‹æå–ä»¥ä¸‹è³‡è¨Šä¸¦åš´æ ¼è¼¸å‡º JSON æ ¼å¼ï¼š\n{\n "date": "YYYY-MM-DD",\n "store": "ç°¡çŸ­åº—å(å¦‚ New Balance, æƒ åº·)",\n "address": "è«‹æå–æ”¶æ“šä¸Šçš„åœ°å€ï¼Œè‹¥ç„¡è©³ç´°åœ°å€è«‹æä¾›åœ°å€(å¦‚ æ—ºè§’)",\n "total": æ•¸å­—(æœ€çµ‚å¯¦ä»˜é‡‘é¡),\n "category": "è«‹æ¨æ¸¬é¡åˆ¥(è¶…ç´šå¸‚å ´, ç¶²è³¼, é£²é£Ÿ, è¡£ç‰©, å…¶ä»–)",\n "items": [ { "name": "å•†å“å", "price": å–®åƒ¹, "qty": æ•¸é‡ } ]\n}\næ³¨æ„ï¼š"total" å¿…é ˆæ˜¯æŠ˜æ‰£å¾Œçš„æœ€çµ‚ä»˜æ¬¾é‡‘é¡ã€‚${extra}\néå¸¸é‡è¦ï¼šè«‹åœ¨ JSON è¼¸å‡ºçµæŸå¾Œï¼Œæ–°èµ·ä¸€è¡Œï¼Œé™„ä¸Šè¿”å›é€£çµï¼š\n[â†©ï¸ é»æ“Šé€™è£¡è¿”å›ç³»çµ±åŒ¯å…¥](${returnUrl})`; navigator.clipboard.writeText(prompt).then(() => { this.openTargetAI(this.getAiUrl()); }); },
        processReceiptJson() { if (!this.receiptJsonText) return this.showToast("è«‹å…ˆè²¼ä¸Šå…§å®¹ï¼", 'warning'); try { let cleanText = this.receiptJsonText.replace(/[\u201C\u201D]/g, '"').replace(/```json/g, '').replace(/```/g, ''); const linkIndex = cleanText.indexOf('[â†©ï¸'); if (linkIndex !== -1) cleanText = cleanText.substring(0, linkIndex); const firstBrace = cleanText.indexOf('{'); const lastBrace = cleanText.lastIndexOf('}'); if (firstBrace !== -1 && lastBrace !== -1) cleanText = cleanText.substring(firstBrace, lastBrace + 1); const data = JSON.parse(cleanText); this.newExpense.date = data.date || new Date().toISOString().split('T')[0]; this.newExpense.note = data.store || ''; this.newExpense.amount = data.total || 0; this.newExpense.subtotal = data.total || 0; this.newExpense.category = data.category || 'å…¶ä»–'; this.newExpense.address = data.address || ''; this.autoGenerateMapUrl(); if (data.items && Array.isArray(data.items)) { this.newExpense.items = data.items.map(i => ({ itemId: 'AI-' + Date.now() + Math.random(), name: i.name, brand: '', price: i.price || 0, qty: i.qty || 1 })); } let matched = false; if (this.companyDB[data.category]) { const found = this.companyDB[data.category].find(c => c.name === data.store); if(found) { this.newExpense.category = data.category; matched = true; } else { for (const cat in this.companyDB) { const foundInCat = this.companyDB[cat].find(c => c.name === data.store); if (foundInCat) { this.newExpense.category = cat; matched = true; break; } } } } this.onCategoryChange(); if (matched) { this.selectedStore = data.store; } else { this.selectedStore = 'other'; this.customStoreInput = data.store; } this.showAiReceiptPanel = false; this.receiptJsonText = ''; this.isEditingExpense = false; this.showAiReceiptModal = false; this.$nextTick(() => { this.showToast("å–®æ“šè§£ææˆåŠŸï¼", 'success'); if (this.$refs.expenseFormCard) { this.$refs.expenseFormCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }); } catch (e) { this.showToast('è§£æå¤±æ•—: ' + e.message, 'danger'); } },
        testReceiptJson() { this.receiptJsonText = JSON.stringify({ "date": "2025-01-01", "store": "æ¸¬è©¦å•†åº—", "address": "æ¸¬è©¦åœ°å€", "total": 128.5, "category": "é£²é£Ÿ", "items": [ { "name": "æ¸¬è©¦æ¼¢å ¡", "price": 50, "qty": 2 } ] }, null, 2); },
        autoGenerateMapUrl() { const store = (this.selectedStore === 'other' ? this.customStoreInput : this.selectedStore) || this.newExpense.note; const address = this.newExpense.address || ""; if (store) { const searchQuery = store + (address ? " " + address : ""); this.newExpense.mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`; } },
        updateCalculatedAmount() { let baseAmount = 0; if (this.isShoppingCategory) { baseAmount = (this.newExpense.items || []).reduce((sum, item) => sum + (item.price * item.qty), 0); this.newExpense.subtotal = baseAmount; } else { baseAmount = this.newExpense.subtotal || 0; } const discount = this.newExpense.discount || 0; this.newExpense.amount = parseFloat(Math.max(0, baseAmount - discount).toFixed(1)); },
        addCartItemManual(){ this.newExpense.items.push({itemId:'MANUAL', name:'æ–°é …ç›®', brand:'', price:0, qty:1}); },
        openAddModal(){this.editingForm={categoryId:'99',stock:1,brand:''};this.showAddModal=true;},closeModal(){this.showAddModal=false;this.showEditModal=false;this.editingForm={};},saveItem(){if(!this.editingForm.name)return this.showToast('åç¨±å¿…å¡«', 'warning');if(this.showEditModal){const idx=this.inventory.findIndex(i=>i.id===this.editingForm.id);if(idx!==-1)this.inventory[idx]={...this.editingForm};}else{this.editingForm.id=Date.now().toString();this.inventory.push(this.editingForm);}this.saveData();this.closeModal();this.selectedIds=[];this.showToast('å·²å„²å­˜', 'success');},actionDelete(){if(!confirm('åˆªé™¤ï¼Ÿ'))return;this.inventory=this.inventory.filter(i=>!this.selectedIds.includes(i.id));this.selectedIds=[];this.saveData();this.showToast('å·²åˆªé™¤', 'success');},actionEdit(){if(this.selectedItems.length!==1)return;this.editingForm=JSON.parse(JSON.stringify(this.selectedItems[0]));this.showEditModal=true;},updateStock(item,change){item.stock=Math.max(0,(item.stock||0)+change);this.saveData();},
        onStoreSelectChange() { if (this.selectedStore && this.selectedStore !== 'other') { const storeObj = this.currentCompanyOptions.find(c => c.name === this.selectedStore); if (storeObj) { this.newExpense.address = storeObj.address || ''; this.newExpense.mapUrl = storeObj.mapUrl || ''; } } else { this.customStoreInput = ''; } },
        onCategoryChange(){ this.selectedStore = (this.currentCompanyOptions.length > 0) ? this.currentCompanyOptions[0].name : 'other'; this.onStoreSelectChange(); },
        addCartItem(){if(!this.selectedInventoryItem)return;if(this.tempQty<1)return this.showToast('æ•¸é‡è‡³å°‘ç‚º 1', 'warning');if(!this.newExpense.items)this.newExpense.items=[];this.newExpense.items.push({itemId:this.selectedInventoryItem.id,name:this.selectedInventoryItem.name,brand:this.selectedInventoryItem.brand||'',price:this.selectedInventoryItem.latestPrice||0,qty:this.tempQty});this.tempQty=1;this.selectedInventoryItem=null;},removeCartItem(idx){this.newExpense.items.splice(idx,1);},
        saveExpense(){ let storeName = this.selectedStore; if(storeName==='other') storeName = this.customStoreInput||'å…¶ä»–'; this.newExpense.note = storeName; this.updateCalculatedAmount(); if(!this.newExpense.amount&&this.newExpense.amount!==0)return this.showToast('é‡‘é¡å¿…å¡«', 'warning'); if (this.newExpense.category && this.companyDB[this.newExpense.category]) { const existingStoreIndex = this.companyDB[this.newExpense.category].findIndex(c => c.name === storeName); if (existingStoreIndex === -1) { this.companyDB[this.newExpense.category].push({ name: storeName, address: this.newExpense.address || '', mapUrl: this.newExpense.mapUrl || '' }); } else { if (this.newExpense.address) { this.companyDB[this.newExpense.category][existingStoreIndex].address = this.newExpense.address; this.companyDB[this.newExpense.category][existingStoreIndex].mapUrl = this.newExpense.mapUrl; } } } if(this.isEditingExpense){this.expenses[this.editingExpenseIndex]={...this.newExpense};this.showToast('ç´€éŒ„å·²æ›´æ–°', 'success');}else{this.newExpense.id=Date.now().toString()+Math.random().toString(36).substr(2,5);this.expenses.push({...this.newExpense});if(this.isShoppingCategory&&this.newExpense.items&&this.newExpense.items.length>0){if(confirm(`å„²å­˜æˆåŠŸï¼\næ˜¯å¦è¦å°‡é€™ ${this.newExpense.items.length} é …å•†å“çš„æ•¸é‡åŠ å…¥åº«å­˜ï¼Ÿ`)){this.updateInventoryFromOrder(this.newExpense.items);}}else{this.showToast('ç´€éŒ„å·²å„²å­˜', 'success');}}this.resetExpenseForm();this.saveData(); },
        updateInventoryFromOrder(items){let count=0;items.forEach(orderItem=>{const invItem=this.inventory.find(i=>i.id===orderItem.itemId);if(invItem){invItem.stock=(invItem.stock||0)+orderItem.qty;count++;}});this.showToast(`å·²æ›´æ–° ${count} å€‹åº«å­˜é …ç›®`, 'success');},deleteExpense(idx){if(confirm('åˆªé™¤ç´€éŒ„ï¼Ÿ')){this.expenses.splice(idx,1);this.saveData();this.showToast('å·²åˆªé™¤', 'success');}},viewOrderDetails(exp){this.viewingOrder=exp;this.showOrderDetailModal=true;},editOrderFromModal(){this.showOrderDetailModal=false;this.editExpenseDirectly(this.viewingOrder);},
        editExpenseDirectly(exp){ this.newExpense=JSON.parse(JSON.stringify(exp)); if(this.newExpense.subtotal === undefined) { this.newExpense.subtotal = this.newExpense.amount + (this.newExpense.discount || 0); } const currentOpts=this.companyDB[this.newExpense.category]||[];if(currentOpts.includes(this.newExpense.note)){this.selectedStore=this.newExpense.note;}else{this.selectedStore='other';this.customStoreInput=this.newExpense.note;}this.isEditingExpense=true;this.editingExpenseIndex=this.expenses.findIndex(e=>e.id===exp.id);window.scrollTo({top:0,behavior:'smooth'}); },
        cancelEditExpense(){this.resetExpenseForm();},resetExpenseForm(){this.newExpense={date:new Date().toISOString().split('T')[0],category:'è¶…ç´šå¸‚å ´',amount:0,subtotal:0,note:'',refNumber:'',items:[],discount:0, address:'', mapUrl:''};this.selectedInventoryItem=null;this.tempQty=1;this.isEditingExpense=false;this.editingExpenseIndex=-1;this.onCategoryChange();},exportExpenseCSV(){let csv="\uFEFFæ—¥æœŸ,é¡åˆ¥,å…¬å¸,é‡‘é¡,å–®è™Ÿ,åœ°å€\n";this.sortedExpenses.forEach(e=>csv+=`${e.date},${e.category},"${e.note||''}",${e.amount},"${e.refNumber||''}", "${e.address||''}"\n`);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download="family_expenses.csv";document.body.appendChild(a);a.click();a.remove();},showMonthlySummary(){const stats={};this.expenses.forEach(e=>{const monthKey=e.date.substring(0,7);if(!stats[monthKey])stats[monthKey]=0;stats[monthKey]+=parseFloat(e.amount||0);});this.monthlyStats=Object.keys(stats).map(k=>({month:k,total:stats[k]})).sort((a,b)=>b.month.localeCompare(a.month));this.showMonthlyModal=true;},
        prepareFileExport(type){this.currentExportType=type;this.showFileExportModal=true;},executeExport(method){this.showFileExportModal=false;let content="",filename="",mimeType="text/plain";if(this.currentExportType==='json'){content=JSON.stringify({inventory:this.inventory,expenses:this.expenses,apiKey:this.apiKey,companyDB:this.companyDB});filename="good_husband_backup.json";mimeType="application/json";}else if(this.currentExportType==='inventory_csv'){content="\uFEFFid,åˆ†é¡,å“ç‰Œ,åç¨±,åº«å­˜,åƒ¹æ ¼,å–®åƒ¹,ISBN,ç¶²å€\n";this.inventory.forEach(i=>{content+=[i.id,i.categoryId,i.brand,i.name,i.stock,i.latestPrice,i.unitPrice,i.isbn,i.url].map(f=>`"${String(f||'').replace(/"/g,'""')}"`).join(',')+"\n";});filename="1_Inventory.csv";mimeType="text/csv";}else if(this.currentExportType==='expense_csv'){content="\uFEFFæ—¥æœŸ,é¡åˆ¥,å…¬å¸,é‡‘é¡,å–®è™Ÿ,åœ°å€\n";this.sortedExpenses.forEach(e=>content+=`${e.date},${e.category},"${e.note||''}",${e.amount},"${e.refNumber||''},"${e.address||''}"\n`);filename="2_Expenses.csv";mimeType="text/csv";}else if(this.currentExportType==='company_db'){content=JSON.stringify(this.companyDB,null,2);filename="3_CompanyDB.json";mimeType="application/json";}if(method==='download'){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type:mimeType}));a.download=filename;document.body.appendChild(a);a.click();a.remove();}else if(method==='share'){const file=new File([content],filename,{type:mimeType});if(navigator.canShare&&navigator.canShare({files:[file]})){navigator.share({files:[file],title:filename,text:'å¥½ç”·äººæ™ºæ…§å®¶å±…è³‡æ–™åŒ¯å‡º'}).catch(err=>console.log('Share canceled',err));}else{this.showToast("ä¸æ”¯æ´åˆ†äº«ï¼Œæ”¹ç‚ºä¸‹è¼‰", 'warning');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type:mimeType}));a.download=filename;document.body.appendChild(a);a.click();a.remove();}}},triggerImport(type){this.currentImportType=type;this.$refs.fileInput.click();},handleFileImport(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(evt)=>{const c=evt.target.result;if(this.currentImportType==='json'){try{const p=JSON.parse(c);this.inventory=p.inventory||[];this.expenses=p.expenses||[];this.apiKey=p.apiKey||'';if(p.companyDB)this.companyDB=p.companyDB;this.saveData();this.showToast('é‚„åŸæˆåŠŸ', 'success');}catch(err){this.showToast('JSON æ ¼å¼éŒ¯èª¤', 'danger');}}else if(this.currentImportType==='inventory_csv'){const l=c.trim().split(/\r?\n/);let count=0;for(let i=1;i<l.length;i++){const cols=l[i].split(',').map(s=>s.replace(/^"|"$/g,''));if(cols.length>3){this.inventory.push({id:Date.now()+Math.random().toString(36),categoryId:cols[1],brand:cols[2],name:cols[3],stock:cols[4],latestPrice:cols[5]});count++;}}this.saveData();this.showToast(`åŒ¯å…¥ ${count} ç­†åº«å­˜`, 'success');}else if(this.currentImportType==='expense_csv'){const l=c.trim().split(/\r?\n/);let count=0;for(let i=1;i<l.length;i++){const cols=l[i].split(',').map(s=>s.replace(/^"|"$/g,''));if(cols.length>=4){this.expenses.push({id:Date.now()+Math.random().toString(36),date:cols[0],category:cols[1],note:cols[2],amount:parseFloat(cols[3]),refNumber:cols[4]||''});count++;}}this.saveData();this.showToast(`åŒ¯å…¥ ${count} ç­†æ”¯å‡º`, 'success');}else if(this.currentImportType==='company_db'){try{const d=JSON.parse(c);if(d&&typeof d==='object'){this.companyDB=d;this.saveData();this.showToast('å…¬å¸è³‡æ–™åº«å·²æ›´æ–°', 'success');}else throw new Error();}catch(err){this.showToast('æ ¼å¼éŒ¯èª¤', 'danger');}}e.target.value='';};r.readAsText(f);}
    }
}).mount('#app');
</script>
</body>
</html>
