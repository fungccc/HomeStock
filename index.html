<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å®¶å±…åº«å­˜ç³»çµ± v2.2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .status-low { color: red; font-weight: bold; }
        .status-ok { color: green; }
        .nav-link.active { background-color: #0d6efd !important; color: white !important; }
        .loading { opacity: 0.6; pointer-events: none; }
        [v-cloak] { display: none; }
        .table-responsive { overflow-x: auto; }
        .btn-xs { padding: 0.1rem 0.4rem; font-size: 0.75rem; }
        /* è®“è¡¨æ ¼æ–‡å­—å‚ç›´ç½®ä¸­ */
        .table > tbody > tr > td { vertical-align: middle; }
        .isbn-text { font-family: monospace; color: #666; letter-spacing: 1px; }
        .category-tag { font-size: 0.85rem; padding: 2px 6px; background: #e9ecef; border-radius: 4px; display: inline-block; }
    </style>
</head>
<body>

<div id="app" class="container py-3" v-cloak>
    <h3 class="mb-3 text-center">ğŸ  æ™ºæ…§å®¶å±…åº«å­˜ç³»çµ±</h3>

    <ul class="nav nav-pills mb-3 justify-content-center nav-justified">
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'planning'}" @click="currentTab = 'planning'" href="#">ğŸ“‹ è³‡æ–™åº«</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'" href="#">ğŸ“¦ ç”¨å“åº«å­˜</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'pricewatch'}" @click="currentTab = 'pricewatch'" href="#">ğŸ’° æ ¼åƒ¹</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'utility'}" @click="currentTab = 'utility'" href="#">âš¡ æ°´é›»ç…¤</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'settings'}" @click="currentTab = 'settings'" href="#">âš™ï¸ è¨­å®š</a></li>
    </ul>

    <div v-if="currentTab === 'planning'">
        <div class="card p-3 border-primary mb-3">
            <h5 class="text-primary">ğŸ“¥ JSON åŒ¯å…¥</h5>
            <div class="input-group">
                <textarea v-model="importJsonText" class="form-control" rows="1" placeholder='è²¼ä¸Š Gemini JSON...'></textarea>
                <button @click="importFromJSON" class="btn btn-primary">åŒ¯å…¥</button>
            </div>
        </div>

        <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5>å®¶å±…ç”¨å“è³‡æ–™åº«</h5>
                <span class="badge bg-secondary">{{ planningList.length }} é …ç›®</span>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th style="width:15%">åˆ†é¡</th>
                            <th style="width:25%">åç¨±</th>
                            <th style="width:20%">ISBN/æ¢ç¢¼</th>
                            <th style="width:20%">åƒè€ƒåƒ¹æ ¼</th>
                            <th style="width:20%">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item, index) in planningList" :key="index">
                            
                            <template v-if="editingIndex !== index">
                                <td>
                                    <span class="category-tag">
                                        {{ getCategoryName(item.categoryId) }}
                                    </span>
                                </td>
                                <td>
                                    <div>{{ item.name }}</div>
                                    <a v-if="item.url" :href="item.url" target="_blank" class="badge bg-info text-decoration-none mt-1">ç¶²åº—</a>
                                </td>
                                <td>
                                    <span class="isbn-text">{{ item.isbn || '-' }}</span>
                                </td>
                                <td>
                                    <div v-if="item.price">
                                        <strong>${{ item.price }}</strong>
                                        <div class="small text-muted">{{ item.unitPrice }}</div>
                                    </div>
                                    <span v-else class="text-muted">-</span>
                                </td>
                                <td>
                                    <button @click="startEdit(index)" class="btn btn-sm btn-outline-secondary me-1">âœï¸ ç·¨è¼¯</button>
                                    <button @click="moveToInventory(index)" class="btn btn-sm btn-success">ğŸ“¥ å…¥åº«</button>
                                </td>
                            </template>

                            <template v-else>
                                <td>
                                    <select v-model="item.categoryId" class="form-select form-select-sm">
                                        <option v-for="cat in categories" :value="cat.id">{{ cat.id }} {{ cat.name }}</option>
                                    </select>
                                </td>
                                <td>
                                    <input v-model="item.name" class="form-control form-control-sm mb-1" placeholder="åç¨±">
                                    <input v-model="item.url" class="form-control form-control-sm" placeholder="ç¶²å€URL">
                                </td>
                                <td>
                                    <input v-model="item.isbn" class="form-control form-control-sm isbn-text" placeholder="è¼¸å…¥æ¢ç¢¼">
                                </td>
                                <td>
                                    <input v-model.number="item.price" type="number" class="form-control form-control-sm mb-1" placeholder="ç¸½åƒ¹">
                                    <input v-model="item.unitPrice" class="form-control form-control-sm" placeholder="å–®åƒ¹å‚™è¨»">
                                </td>
                                <td>
                                    <button @click="stopEdit" class="btn btn-sm btn-primary w-100">ğŸ’¾ å„²å­˜</button>
                                </td>
                            </template>
                        </tr>
                        <tr v-if="planningList.length === 0">
                            <td colspan="5" class="text-center text-muted py-3">æš«ç„¡è³‡æ–™ï¼Œè«‹åŒ¯å…¥ JSON</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'inventory'">
        <div class="card p-3 mb-3">
            <h5>æ‰‹å‹•æ–°å¢</h5>
            <div class="input-group">
                <input v-model="newItem.name" type="text" class="form-control" placeholder="åç¨±">
                <input v-model.number="newItem.stock" type="number" class="form-control" placeholder="æ•¸é‡" style="max-width: 80px;">
                <button @click="addItem" class="btn btn-primary">æ–°å¢</button>
            </div>
        </div>

        <div class="card p-3">
            <h5>ç¾æœ‰åº«å­˜</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle text-nowrap">
                    <thead><tr><th>åç¨±</th><th>åº«å­˜</th><th>è³‡è¨Š</th><th>æ“ä½œ</th></tr></thead>
                    <tbody>
                        <tr v-for="(item, index) in inventory" :key="index">
                            <td>
                                {{ item.name }}
                                <div class="small text-muted" v-if="item.categoryId">
                                    {{ getCategoryName(item.categoryId) }}
                                </div>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button @click="item.stock--; saveData()" class="btn btn-outline-danger">-</button>
                                    <button class="btn btn-light disabled" style="color:#000; width:40px">{{ item.stock }}</button>
                                    <button @click="item.stock++; saveData()" class="btn btn-outline-success">+</button>
                                </div>
                            </td>
                            <td>
                                <div class="small" v-if="item.isbn">æ¢ç¢¼: {{ item.isbn }}</div>
                                <div class="small text-success" v-if="item.latestPrice">${{ item.latestPrice }}</div>
                            </td>
                            <td>
                                <button @click="deleteItem(index)" class="btn btn-sm btn-danger">åˆªé™¤</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'pricewatch'">
        <div class="card p-3 mb-3">
            <h5>éœ€æŸ¥åƒ¹ç‰©å“</h5>
            <ul class="list-group list-group-flush">
                <li v-for="(item, index) in itemsDueForCheck" :key="index" class="list-group-item d-flex justify-content-between align-items-center px-0">
                    <div>
                        <strong>{{ item.name }}</strong>
                        <div class="small text-muted">ä¸Šæ¬¡: {{ item.lastPriceCheck || 'å¾æœª' }}</div>
                    </div>
                    <div>
                        <a :href="'https://www.wellcome.com.hk/zh-hant/search?q=' + encodeURIComponent(item.name)" target="_blank" class="btn btn-sm btn-outline-danger me-1">æƒ åº·</a>
                        <a :href="'https://www.pns.hk/zh-hk/search?text=' + encodeURIComponent(item.name)" target="_blank" class="btn btn-sm btn-outline-primary me-1">ç™¾ä½³</a>
                        <button @click="selectItemForAnalysis(item)" class="btn btn-sm btn-warning">æ›´æ–°</button>
                    </div>
                </li>
            </ul>
        </div>
        <div class="card p-3 border-warning" :class="{ loading: isAnalyzing }">
            <h5>ğŸ¤– åƒ¹æ ¼åˆ†æå™¨</h5>
            <div v-if="selectedItem">
                <p class="mb-1">æ­£åœ¨æ›´æ–°: <strong>{{ selectedItem.name }}</strong></p>
                <textarea v-model="pastedText" class="form-control mb-2" rows="3" placeholder="è²¼ä¸Šå•†å“åƒ¹æ ¼æ–‡å­—..."></textarea>
                <button @click="analyzePrice" class="btn btn-success w-100" :disabled="!apiKey">åˆ†æä¸¦æ›´æ–°</button>
            </div>
            <div v-else class="text-center text-muted">ğŸ‘† è«‹å…ˆé¸æ“‡ç‰©å“</div>
        </div>
    </div>

    <div v-if="currentTab === 'utility'">
        <div class="card p-3">
            <h5>æ–°å¢ç´€éŒ„</h5>
            <div class="row g-2">
                <div class="col-4"><select v-model="newBill.type" class="form-select"><option value="é›»è²»">âš¡ é›»è²»</option><option value="æ°´è²»">ğŸ’§ æ°´è²»</option><option value="ç…¤æ°£">ğŸ”¥ ç…¤æ°£</option></select></div>
                <div class="col-4"><input v-model="newBill.date" type="date" class="form-control"></div>
                <div class="col-4"><input v-model.number="newBill.amount" type="number" class="form-control" placeholder="$"></div>
                <div class="col-12"><button @click="addBill" class="btn btn-primary w-100">è¨˜éŒ„</button></div>
            </div>
        </div>
        <div class="card p-3 mt-3">
            <div class="table-responsive">
                <table class="table table-striped text-nowrap">
                    <thead><tr><th>é¡åˆ¥</th><th>æ—¥æœŸ</th><th>é‡‘é¡</th><th>åˆªé™¤</th></tr></thead>
                    <tbody>
                        <tr v-for="(bill, index) in sortedBills" :key="index">
                            <td>{{ bill.type }}</td><td>{{ bill.date }}</td><td>${{ bill.amount }}</td>
                            <td><button @click="deleteBill(index)" class="btn btn-sm btn-danger">X</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'settings'">
        <div class="card p-3 mb-3">
            <h5>ğŸ”‘ Gemini API Key</h5>
            <input v-model="apiKey" type="password" class="form-control mb-2" placeholder="åœ¨æ­¤è²¼ä¸Š Key">
            <button @click="saveSettings" class="btn btn-success w-100">å„²å­˜è¨­å®š</button>
        </div>
        <div class="card p-3">
            <h5>ğŸ’¾ å‚™ä»½èˆ‡é‚„åŸ</h5>
            <div class="d-flex gap-2">
                <button @click="exportData" class="btn btn-outline-primary w-50">åŒ¯å‡º JSON</button>
                <button onclick="document.getElementById('importFile').click()" class="btn btn-outline-secondary w-50">åŒ¯å…¥æª”æ¡ˆ</button>
                <input type="file" id="importFile" style="display:none" @change="importData">
            </div>
        </div>
    </div>

</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            currentTab: 'planning',
            apiKey: '',
            importJsonText: '',
            
            // UI ç‹€æ…‹
            editingIndex: -1, // -1 ä»£è¡¨æ²’æœ‰ä»»ä½•è¡Œåœ¨ç·¨è¼¯ä¸­
            
            // é è¨­åˆ†é¡ (Classification)
            categories: [
                { id: '10', name: 'é£Ÿå“/ä¹¾ç³§' },
                { id: '20', name: 'é£²å“' },
                { id: '30', name: 'å®¶å±…æ¸…æ½”' },
                { id: '40', name: 'å€‹äººè­·ç†' },
                { id: '50', name: 'ç´™å“/è¡›ç”Ÿ' },
                { id: '60', name: 'å»šæˆ¿ç”¨å“' },
                { id: '70', name: 'è—¥å“/ä¿å¥' },
                { id: '99', name: 'å…¶ä»–' }
            ],

            planningList: [], 
            inventory: [],
            newItem: { name: '', stock: 1, checkInterval: 7 },
            bills: [],
            newBill: { type: 'é›»è²»', date: '', amount: '' },
            selectedItem: null,
            pastedText: '',
            isAnalyzing: false
        };
    },
    computed: {
        itemsDueForCheck() {
            const today = new Date();
            return this.inventory.filter(item => {
                if (!item.lastPriceCheck) return true;
                const diffDays = Math.ceil(Math.abs(today - new Date(item.lastPriceCheck)) / (1000 * 60 * 60 * 24)); 
                return diffDays >= (item.checkInterval || 7);
            });
        },
        sortedBills() { return this.bills.sort((a, b) => new Date(b.date) - new Date(a.date)); }
    },
    mounted() { this.loadData(); },
    methods: {
        saveData() {
            localStorage.setItem('homeInventoryDB_v2', JSON.stringify({
                inventory: this.inventory, planningList: this.planningList, bills: this.bills, apiKey: this.apiKey
            }));
        },
        loadData() {
            const data = localStorage.getItem('homeInventoryDB_v2');
            if (data) {
                const parsed = JSON.parse(data);
                this.inventory = parsed.inventory || [];
                this.planningList = parsed.planningList || [];
                this.bills = parsed.bills || [];
                this.apiKey = parsed.apiKey || '';
            }
        },
        saveSettings() { this.saveData(); alert('è¨­å®šå·²å„²å­˜ï¼'); },
        
        // å–å¾—åˆ†é¡åç¨±
        getCategoryName(id) {
            const cat = this.categories.find(c => c.id == id);
            return cat ? `${id}-${cat.name}` : id || 'æœªåˆ†é¡';
        },

        // --- ç·¨è¼¯åŠŸèƒ½ ---
        startEdit(index) {
            this.editingIndex = index; // é–‹å•Ÿè©²è¡Œçš„ç·¨è¼¯æ¨¡å¼
        },
        stopEdit() {
            this.editingIndex = -1; // é—œé–‰ç·¨è¼¯æ¨¡å¼
            this.saveData(); // å„²å­˜ä¿®æ”¹
        },

        // --- åŒ¯å…¥åŠŸèƒ½ ---
        importFromJSON() {
            try {
                if (!this.importJsonText) return;
                const newItems = JSON.parse(this.importJsonText);
                if (Array.isArray(newItems)) {
                    const today = new Date().toISOString().split('T')[0];
                    newItems.forEach(item => {
                        if (!item.priceDate) item.priceDate = today;
                        // å˜—è©¦è‡ªå‹•æ­¸é¡ (ç°¡å–®é—œéµå­—åˆ¤æ–·ï¼Œå¯é¸)
                        if (!item.categoryId) item.categoryId = '99'; 
                        if (!item.isbn) item.isbn = '';
                    });
                    this.planningList.push(...newItems);
                    this.importJsonText = '';
                    this.saveData();
                    alert(`æˆåŠŸåŒ¯å…¥ ${newItems.length} å€‹é …ç›®ï¼`);
                } else { alert('æ ¼å¼éŒ¯èª¤'); }
            } catch (e) { alert('JSON è§£æå¤±æ•—'); }
        },
        
        // --- ç§»åˆ°åº«å­˜ ---
        moveToInventory(index) {
            const item = this.planningList[index];
            this.inventory.push({
                name: item.name,
                stock: 1, 
                checkInterval: 7,
                lastBuyDate: new Date().toISOString().split('T')[0],
                url: item.url,
                latestPrice: item.price,
                lastPriceCheck: item.priceDate,
                categoryId: item.categoryId, // å¸¶å…¥åˆ†é¡
                isbn: item.isbn              // å¸¶å…¥ ISBN
            });
            this.planningList.splice(index, 1);
            this.saveData();
        },

        // --- å…¶ä»–åŸæœ‰åŠŸèƒ½ ---
        addItem() {
            if (!this.newItem.name) return alert('è«‹è¼¸å…¥åç¨±');
            this.inventory.push({ ...this.newItem });
            this.newItem = { name: '', stock: 1, checkInterval: 7 };
            this.saveData();
        },
        deleteItem(index) { if(confirm('ç¢ºå®šåˆªé™¤?')) { this.inventory.splice(index, 1); this.saveData(); } },
        addBill() {
            if (!this.newBill.amount) return alert('è«‹è¼¸å…¥é‡‘é¡');
            this.bills.push({ ...this.newBill });
            this.newBill = { type: 'é›»è²»', date: '', amount: '' };
            this.saveData();
        },
        deleteBill(index) { this.bills.splice(index, 1); this.saveData(); },
        selectItemForAnalysis(item) { this.selectedItem = item; this.pastedText = ''; },
        async analyzePrice() {
            if (!this.pastedText || !this.apiKey) return alert('è«‹è²¼ä¸Šæ–‡å­—');
            this.isAnalyzing = true;
            const prompt = `åˆ†æé€™æ®µå•†å“æ–‡å­—ï¼Œå›å‚³JSON: {"price": æ•¸å­—, "source": "ä¾†æºå‚™è¨»"} \næ–‡å­—: ${this.pastedText}`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                const result = JSON.parse(aiText.replace(/```json|```/g, '').trim());
                const index = this.inventory.indexOf(this.selectedItem);
                if (index !== -1) {
                    this.inventory[index].latestPrice = result.price;
                    this.inventory[index].lastPriceCheck = new Date().toISOString().split('T')[0];
                    this.saveData();
                    alert(`æ›´æ–°æˆåŠŸï¼$${result.price}`);
                    this.selectedItem = null;
                }
            } catch (error) { alert('åˆ†æå¤±æ•—'); } finally { this.isAnalyzing = false; }
        },
        exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                inventory: this.inventory, planningList: this.planningList, bills: this.bills, apiKey: this.apiKey
            }));
            const a = document.createElement('a'); a.href = dataStr; a.download = "home_stock_backup.json";
            document.body.appendChild(a); a.click(); a.remove();
        },
        importData(event) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    this.inventory = parsed.inventory || [];
                    this.planningList = parsed.planningList || [];
                    this.bills = parsed.bills || [];
                    this.apiKey = parsed.apiKey || '';
                    this.saveData();
                    alert('åŒ¯å…¥æˆåŠŸï¼');
                } catch(err) { alert('æª”æ¡ˆéŒ¯èª¤'); }
            };
            reader.readAsText(event.target.files[0]);
        }
    }
}).mount('#app');
</script>
</body>
</html>
