<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½ç”·äººæ™ºæ…§å®¶å±…åº«å­˜ v4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 90px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: none; margin-bottom: 15px; }
        .nav-link.active { background-color: #0d6efd !important; color: white !important; }
        [v-cloak] { display: none; }
        .table-responsive { overflow-x: auto; }
        .table > tbody > tr > td { vertical-align: middle; }
        .category-tag { font-size: 0.7rem; padding: 2px 6px; background: #e9ecef; border-radius: 4px; color: #666; display: inline-block; margin-right: 4px;}
        .brand-tag { font-size: 0.7rem; padding: 2px 6px; background: #e3f2fd; border-radius: 4px; color: #0d6efd; display: inline-block;}
        .item-name { font-weight: 600; font-size: 1rem; }
        .price-tag { font-size: 0.9rem; color: #198754; font-weight: bold; }
        .history-btn { font-size: 0.75rem; text-decoration: none; border-bottom: 1px dashed #999; color: #666; cursor: pointer;}

        /* æµ®å‹•æ“ä½œåˆ— */
        .floating-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(5px);
            padding: 10px 15px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; gap: 12px; z-index: 1000; align-items: center;
            border: 1px solid #dee2e6; width: 92%; max-width: 420px; justify-content: space-around;
        }
        .floating-btn { border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #555; cursor: pointer; width: 50px; }
        .floating-btn i { font-size: 1.3rem; margin-bottom: 2px; }
        .floating-btn:active { transform: scale(0.95); }

        .form-check-input { width: 1.3em; height: 1.3em; cursor: pointer; border-color: #999;}
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; }
        .search-box input { padding-left: 35px; border-radius: 20px; }
    </style>
</head>
<body>

<div id="app" class="container py-3" v-cloak>
    <h4 class="mb-3 text-center fw-bold">ğŸ‘¨â€ğŸ’¼ å¥½ç”·äººæ™ºæ…§å®¶å±…åº«å­˜ v4.0</h4>

    <ul class="nav nav-pills mb-3 justify-content-center nav-justified bg-white p-1 rounded shadow-sm">
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'" href="#">ğŸ“¦ åº«å­˜ç®¡ç†</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'expenses'}" @click="currentTab = 'expenses'" href="#">ğŸ’¸ å®¶åº­æ”¯å‡º</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'pricewatch'}" @click="currentTab = 'pricewatch'" href="#">ğŸ¤– æ ¼åƒ¹åŒ¯å…¥</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'settings'}" @click="currentTab = 'settings'" href="#">âš™ï¸ è¨­å®š</a></li>
    </ul>

    <div v-if="currentTab === 'inventory'">
        <div class="card p-3 mb-3 sticky-top" style="z-index: 900; background: rgba(255,255,255,0.95);">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input v-model="searchQuery" type="text" class="form-control" placeholder="æœå°‹åç¨±ã€å“ç‰Œã€åˆ†é¡...">
            </div>
            <div class="d-flex justify-content-between mt-2 align-items-center">
                <span class="small text-muted">{{ filteredInventory.length }} é …ç‰©å“</span>
                <button v-if="selectedItems.length > 0" @click="selectAll(false)" class="btn btn-sm btn-link text-danger text-decoration-none">å–æ¶ˆå…¨é¸</button>
            </div>
        </div>

        <div class="card p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover mb-0 text-nowrap">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">ç‰©å“ / åƒ¹æ ¼</th>
                            <th class="text-center">åº«å­˜</th>
                            <th class="text-center" style="width: 50px;">é¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in filteredInventory" :key="item.id" :class="{'table-active': isSelected(item)}">
                            <td class="ps-3" @click="toggleSelection(item)">
                                <div>
                                    <span class="category-tag">{{ getCategoryName(item.categoryId) }}</span>
                                    <span v-if="item.brand" class="brand-tag">{{ item.brand }}</span>
                                </div>
                                <div class="item-name text-truncate" style="max-width: 200px;">{{ item.name }}</div>
                                
                                <div class="mt-1 d-flex align-items-center gap-2">
                                    <span v-if="item.latestPrice" class="price-tag">${{ item.latestPrice }}</span>
                                    <span v-else class="text-muted small">-</span>
                                    
                                    <span v-if="item.priceHistory && item.priceHistory.length > 0" 
                                          @click.stop="viewHistory(item)" class="history-btn">
                                        <i class="bi bi-graph-down"></i> èµ°å‹¢
                                    </span>
                                </div>
                                <div class="small text-muted" style="font-size:0.75rem">
                                    {{ item.priceDate ? item.priceDate : '' }} {{ item.unitPrice ? '('+item.unitPrice+')' : '' }}
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button @click.stop="updateStock(item, -1)" class="btn btn-outline-secondary px-2">-</button>
                                    <button class="btn btn-light disabled text-dark fw-bold border-top border-bottom" style="width:35px">{{ item.stock }}</button>
                                    <button @click.stop="updateStock(item, 1)" class="btn btn-outline-success px-2">+</button>
                                </div>
                            </td>
                            <td class="text-center" @click="toggleSelection(item)">
                                <input type="checkbox" class="form-check-input" :checked="isSelected(item)">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="selectedItems.length === 0" style="position: fixed; bottom: 25px; right: 25px; z-index: 999;">
            <button @click="openAddModal" class="btn btn-primary rounded-circle shadow p-0" style="width: 56px; height: 56px; font-size: 24px;">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>

        <div v-if="selectedItems.length > 0" class="floating-bar">
            <button @click="actionEdit" class="floating-btn" :class="{disabled: selectedItems.length > 1}"><i class="bi bi-pencil-square"></i> ç·¨è¼¯</button>
            <button @click="actionWhatsApp" class="floating-btn text-success"><i class="bi bi-whatsapp"></i> WA</button>
            <button @click="actionShare" class="floating-btn text-primary"><i class="bi bi-share-fill"></i> åˆ†äº«</button>
            <button @click="actionCopy" class="floating-btn"><i class="bi bi-clipboard"></i> è¤‡è£½</button>
            <button @click="actionDelete" class="floating-btn text-danger"><i class="bi bi-trash"></i> åˆªé™¤</button>
        </div>
    </div>

    <div v-if="currentTab === 'expenses'">
        <div class="card p-3 mb-3 border-primary">
            <h5 class="text-primary fw-bold"><i class="bi bi-journal-plus"></i> æ–°å¢æ”¯å‡º/è¨‚å–®</h5>
            <div class="row g-2">
                <div class="col-6">
                    <label class="small text-muted">æ—¥æœŸ</label>
                    <input v-model="newExpense.date" type="date" class="form-control">
                </div>
                <div class="col-6">
                    <label class="small text-muted">é¡åˆ¥</label>
                    <select v-model="newExpense.category" class="form-select">
                        <option value="è³¼ç‰©è¨‚å–®">ğŸ›’ è³¼ç‰©è¨‚å–®</option>
                        <option value="é›»è²»">âš¡ é›»è²»</option>
                        <option value="æ°´è²»">ğŸ’§ æ°´è²»</option>
                        <option value="ç…¤æ°£">ğŸ”¥ ç…¤æ°£è²»</option>
                        <option value="å¯¬é »/é›»è©±">ğŸ“¶ å¯¬é »/é›»è©±</option>
                        <option value="é¤é£²">ğŸ½ï¸ é¤é£²/å¤–è³£</option>
                        <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="small text-muted">é‡‘é¡</label>
                    <input v-model.number="newExpense.amount" type="number" class="form-control" placeholder="$">
                </div>
                <div class="col-6">
                    <label class="small text-muted">å‚™è¨» (é …ç›®/åº—é‹ª)</label>
                    <input v-model="newExpense.note" type="text" class="form-control" placeholder="ä¾‹: ç™¾ä½³, æ·˜å¯¶...">
                </div>
                <div class="col-12 mt-2">
                    <button @click="addExpense" class="btn btn-primary w-100">å„²å­˜ç´€éŒ„</button>
                </div>
            </div>
        </div>

        <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">æ”¯å‡ºç´€éŒ„</h5>
                <button @click="exportExpenseCSV" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-file-earmark-excel"></i> åŒ¯å‡º CSV
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-sm text-nowrap align-middle">
                    <thead><tr><th>æ—¥æœŸ</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th></th></tr></thead>
                    <tbody>
                        <tr v-for="(exp, index) in sortedExpenses" :key="index">
                            <td>{{ exp.date }}</td>
                            <td><span class="badge bg-light text-dark border">{{ exp.category }}</span></td>
                            <td class="fw-bold">${{ exp.amount }}</td>
                            <td class="text-muted small">{{ exp.note }}</td>
                            <td><i @click="deleteExpense(index)" class="bi bi-x-circle text-danger" style="cursor:pointer"></i></td>
                        </tr>
                        <tr v-if="expenses.length === 0"><td colspan="5" class="text-center py-3 text-muted">æš«ç„¡æ”¯å‡ºç´€éŒ„</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'pricewatch'">
        <div class="card p-3 border-warning mb-3">
            <h5 class="text-warning-emphasis"><i class="bi bi-robot"></i> Gemini JSON åŒ¯å…¥</h5>
            <textarea v-model="importJsonText" class="form-control mb-2" rows="2" placeholder='è²¼ä¸Š Gemini çµ¦çš„ JSON...'></textarea>
            <button @click="importFromJSON" class="btn btn-warning w-100">åŒ¯å…¥ä¸¦æ›´æ–°åº«å­˜</button>
            <div class="form-text small">æ”¯æ´æ¬„ä½ï¼šå“ç‰Œã€åƒ¹æ ¼æ—¥æœŸã€åƒ¹æ ¼</div>
        </div>
        <div class="card p-3" :class="{ loading: isAnalyzing }">
            <h5>ğŸ¤– åƒ¹æ ¼åˆ†æå™¨</h5>
            <div class="small text-muted mb-2">æ›´æ–°ç¾æœ‰ç‰©å“åƒ¹æ ¼ (è‡ªå‹•å­˜å…¥æ­·å²ç´€éŒ„)</div>
            <select v-model="selectedItemForAnalysis" class="form-select mb-2">
                <option :value="null">-- é¸æ“‡ç‰©å“ --</option>
                <option v-for="item in inventory" :value="item">{{ item.name }}</option>
            </select>
            <textarea v-model="pastedText" class="form-control mb-2" rows="3" placeholder="è²¼ä¸Šç¶²é åƒ¹æ ¼æ–‡å­—..."></textarea>
            <button @click="analyzePrice" class="btn btn-success w-100" :disabled="!apiKey || !selectedItemForAnalysis">åˆ†æä¸¦æ›´æ–°</button>
        </div>
    </div>

    <div v-if="currentTab === 'settings'">
        <div class="card p-3 mb-3">
            <h5>ğŸ”‘ Gemini API Key</h5>
            <input v-model="apiKey" type="password" class="form-control mb-2" placeholder="åœ¨æ­¤è²¼ä¸Š Key">
            <button @click="saveSettings" class="btn btn-success w-100">å„²å­˜</button>
        </div>
        <div class="card p-3">
            <button @click="exportData" class="btn btn-outline-primary w-100 mb-2">åŒ¯å‡ºå®Œæ•´å‚™ä»½ (JSON)</button>
            <input type="file" @change="importData" class="form-control">
        </div>
    </div>

    <div v-if="showAddModal || showEditModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ showEditModal ? 'ç·¨è¼¯ç‰©å“' : 'æ–°å¢ç‰©å“' }}</h5>
                    <button @click="closeModal" class="btn-close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-2">
                        <div class="col-6"><label class="small">åˆ†é¡</label><select v-model="editingForm.categoryId" class="form-select"><option v-for="cat in categories" :value="cat.id">{{ cat.name }}</option></select></div>
                        <div class="col-6"><label class="small">å“ç‰Œ (Brand)</label><input v-model="editingForm.brand" class="form-control" placeholder="ä¾‹: ç¶­ä»–"></div>
                    </div>
                    <div class="mb-2"><label class="small">åç¨±</label><input v-model="editingForm.name" class="form-control"></div>
                    <div class="row g-2 mb-2">
                        <div class="col-4"><label class="small">åº«å­˜</label><input v-model.number="editingForm.stock" type="number" class="form-control"></div>
                        <div class="col-4"><label class="small">ç¾åƒ¹ ($)</label><input v-model.number="editingForm.latestPrice" type="number" class="form-control"></div>
                        <div class="col-4"><label class="small">æŸ¥åƒ¹æ—¥æœŸ</label><input v-model="editingForm.priceDate" type="date" class="form-control"></div>
                    </div>
                    <div class="mb-2"><label class="small">æ¢ç¢¼ (ISBN)</label><input v-model="editingForm.isbn" class="form-control"></div>
                    <div class="mb-2"><label class="small">ç¶²å€ URL</label><input v-model="editingForm.url" class="form-control"></div>
                </div>
                <div class="modal-footer">
                    <button @click="closeModal" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button @click="saveItem" class="btn btn-primary">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showHistoryModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title">ğŸ“‰ åƒ¹æ ¼æ­·å²: {{ historyItem.name }}</h6>
                    <button @click="showHistoryModal = false" class="btn-close"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-sm table-striped mb-0 text-center">
                        <thead><tr><th>æ—¥æœŸ</th><th>åƒ¹æ ¼</th></tr></thead>
                        <tbody>
                            <tr v-for="rec in historyItem.priceHistory" :key="rec.date">
                                <td>{{ rec.date }}</td>
                                <td class="fw-bold">${{ rec.price }}</td>
                            </tr>
                            <tr v-if="!historyItem.priceHistory || historyItem.priceHistory.length === 0">
                                <td colspan="2" class="text-muted small py-2">ç„¡æ­·å²ç´€éŒ„</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            currentTab: 'inventory',
            apiKey: '',
            searchQuery: '',
            
            // è³‡æ–™åº«
            inventory: [],
            expenses: [], // çµ±ä¸€çš„æ”¯å‡º/å¸³å–®ç´€éŒ„
            
            // UI ç‹€æ…‹
            selectedIds: [],
            showAddModal: false, showEditModal: false, showHistoryModal: false,
            editingForm: {}, historyItem: {},
            
            // Gemini & Import
            importJsonText: '', pastedText: '', isAnalyzing: false, selectedItemForAnalysis: null,
            newExpense: { date: new Date().toISOString().split('T')[0], category: 'è³¼ç‰©è¨‚å–®', amount: '', note: '' },
            
            categories: [
                { id: '10', name: 'é£Ÿå“/ä¹¾ç³§' }, { id: '20', name: 'é£²å“' },
                { id: '30', name: 'å®¶å±…æ¸…æ½”' }, { id: '40', name: 'å€‹äººè­·ç†' },
                { id: '50', name: 'ç´™å“/è¡›ç”Ÿ' }, { id: '60', name: 'å»šæˆ¿ç”¨å“' },
                { id: '70', name: 'è—¥å“/ä¿å¥' }, { id: '99', name: 'å…¶ä»–' }
            ]
        };
    },
    computed: {
        filteredInventory() {
            const query = this.searchQuery.toLowerCase().trim();
            if (!query) return this.inventory;
            return this.inventory.filter(item => {
                const matchName = item.name.toLowerCase().includes(query);
                const matchBrand = item.brand && item.brand.toLowerCase().includes(query);
                return matchName || matchBrand || (item.isbn && item.isbn.includes(query));
            });
        },
        selectedItems() { return this.inventory.filter(item => this.selectedIds.includes(item.id)); },
        sortedExpenses() { return this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)); }
    },
    mounted() { this.loadData(); },
    methods: {
        saveData() { localStorage.setItem('goodHusbandDB_v4', JSON.stringify({ inventory: this.inventory, expenses: this.expenses, apiKey: this.apiKey })); },
        loadData() {
            // v4 è®€å–
            let data = localStorage.getItem('goodHusbandDB_v4');
            if (data) {
                let p = JSON.parse(data);
                this.inventory = p.inventory || [];
                this.expenses = p.expenses || [];
                this.apiKey = p.apiKey || '';
            } else {
                // v3 é·ç§»
                let v3 = localStorage.getItem('homeInventoryDB_v3');
                if (v3) {
                    let p = JSON.parse(v3);
                    this.inventory = p.inventory || [];
                    this.apiKey = p.apiKey || '';
                    // å°‡èˆŠç‰ˆ bills è½‰æ›ç‚ºæ–°ç‰ˆ expenses
                    if (p.bills) {
                        p.bills.forEach(b => {
                            this.expenses.push({
                                date: b.date,
                                category: b.type, // e.g., 'é›»è²»'
                                amount: b.amount,
                                note: 'èˆŠç´€éŒ„é·ç§»'
                            });
                        });
                    }
                    alert('å·²å‡ç´šè‡³ v4.0 å¥½ç”·äººç³»çµ±ï¼èˆŠå¸³å–®å·²æ•´åˆè‡³ã€Œå®¶åº­æ”¯å‡ºã€ã€‚');
                    this.saveData();
                }
            }
        },
        saveSettings() { this.saveData(); alert('è¨­å®šå·²å„²å­˜ï¼'); },
        getCategoryName(id) { const c = this.categories.find(x => x.id == id); return c ? c.name : 'æœªåˆ†é¡'; },

        // --- åº«å­˜é¸å– ---
        isSelected(item) { return this.selectedIds.includes(item.id); },
        toggleSelection(item) {
            const id = item.id;
            if (this.selectedIds.includes(id)) this.selectedIds = this.selectedIds.filter(i => i !== id);
            else this.selectedIds.push(id);
        },
        selectAll(doSelect) { this.selectedIds = doSelect ? this.filteredInventory.map(i => i.id) : []; },

        // --- æµ®å‹•æ“ä½œ ---
        actionWhatsApp() {
            const text = "ğŸ›’ éœ€è³¼è²·æ¸…å–®ï¼š\n" + this.selectedItems.map(i => `- ${i.name} (${i.brand||''}) åº«å­˜:${i.stock}`).join('\n');
            window.location.href = `whatsapp://send?text=${encodeURIComponent(text)}`;
        },
        actionShare() {
            const text = "ğŸ›’ åº«å­˜æ¸…å–®ï¼š\n" + this.selectedItems.map(i => `${i.name}`).join('\n');
            if (navigator.share) navigator.share({title:'åº«å­˜', text:text});
            else alert("ä¸æ”¯æ´åˆ†äº«");
        },
        actionCopy() { navigator.clipboard.writeText(this.selectedItems.map(i=>i.name).join('\n')).then(()=>alert('å·²è¤‡è£½')); },
        actionDelete() {
            if(!confirm('åˆªé™¤é¸å–é …ç›®ï¼Ÿ')) return;
            this.inventory = this.inventory.filter(i => !this.selectedIds.includes(i.id));
            this.selectedIds = []; this.saveData();
        },
        actionEdit() {
            if(this.selectedItems.length!==1) return;
            this.editingForm = JSON.parse(JSON.stringify(this.selectedItems[0]));
            this.showEditModal = true;
        },

        // --- æ–°å¢/ç·¨è¼¯/æ­·å² ---
        openAddModal() { this.editingForm = { categoryId: '99', stock: 1, brand: '', priceDate: new Date().toISOString().split('T')[0] }; this.showAddModal = true; },
        closeModal() { this.showAddModal = false; this.showEditModal = false; this.editingForm = {}; },
        saveItem() {
            if(!this.editingForm.name) return alert('åç¨±å¿…å¡«');
            
            // è™•ç†åƒ¹æ ¼æ­·å²
            const saveHistory = (item, newPrice, date) => {
                if(!item.priceHistory) item.priceHistory = [];
                // å¦‚æœåƒ¹æ ¼è®Šäº†ï¼Œæ‰è¨˜éŒ„
                if (item.latestPrice && item.latestPrice != newPrice) {
                    item.priceHistory.push({ date: item.priceDate || 'èˆŠç´€éŒ„', price: item.latestPrice });
                }
                // æ’åºä¸¦åªç•™æœ€è¿‘ 10 ç­†
                item.priceHistory.sort((a,b) => new Date(b.date) - new Date(a.date));
                if(item.priceHistory.length > 10) item.priceHistory = item.priceHistory.slice(0,10);
            };

            if (this.showEditModal) {
                const idx = this.inventory.findIndex(i => i.id === this.editingForm.id);
                if (idx !== -1) {
                    saveHistory(this.inventory[idx], this.editingForm.latestPrice);
                    this.inventory[idx] = { ...this.editingForm };
                }
            } else {
                this.editingForm.id = Date.now().toString();
                this.inventory.push({ ...this.editingForm, priceHistory: [] });
            }
            this.saveData(); this.closeModal(); this.selectedIds = [];
        },
        updateStock(item, change) { item.stock = Math.max(0, (item.stock||0)+change); this.saveData(); },
        viewHistory(item) { this.historyItem = item; this.showHistoryModal = true; },

        // --- æ”¯å‡ºç®¡ç† (Expenses) ---
        addExpense() {
            if(!this.newExpense.amount) return alert('é‡‘é¡å¿…å¡«');
            this.expenses.push({ ...this.newExpense });
            this.newExpense = { date: new Date().toISOString().split('T')[0], category: 'è³¼ç‰©è¨‚å–®', amount: '', note: '' };
            this.saveData();
        },
        deleteExpense(idx) { if(confirm('åˆªé™¤ç´€éŒ„ï¼Ÿ')) { this.expenses.splice(idx, 1); this.saveData(); } },
        exportExpenseCSV() {
            let csv = "\uFEFFæ—¥æœŸ,é¡åˆ¥,é‡‘é¡,å‚™è¨»\n";
            this.sortedExpenses.forEach(e => {
                csv += `${e.date},${e.category},${e.amount},"${e.note||''}"\n`;
            });
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = "family_expenses.csv"; document.body.appendChild(a); a.click(); a.remove();
        },

        // --- Gemini & Import ---
        importFromJSON() {
            try {
                const list = JSON.parse(this.importJsonText);
                if(Array.isArray(list)) {
                    list.forEach(i => {
                        i.id = Date.now() + Math.random().toString(36).substr(2,5);
                        i.stock = 0;
                        if(!i.priceHistory) i.priceHistory = [];
                        if(!i.brand) i.brand = '';
                    });
                    this.inventory.push(...list);
                    this.importJsonText = ''; this.saveData(); alert(`åŒ¯å…¥ ${list.length} ç­†`);
                }
            } catch(e) { alert('JSON æ ¼å¼éŒ¯èª¤'); }
        },
        async analyzePrice() {
            if(!this.pastedText || !this.apiKey) return alert('è«‹å¡«å¯«');
            this.isAnalyzing = true;
            try {
                const prompt = `åˆ†æå•†å“æ–‡å­—: "${this.pastedText}"ï¼Œå›å‚³JSON: {"price": æ•¸å­—, "unitPrice": "ç°¡çŸ­å‚™è¨»", "brand": "å“ç‰Œ"}`;
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                });
                const data = await res.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                
                // æ›´æ–°é‚è¼¯
                const item = this.selectedItemForAnalysis;
                // ç´€éŒ„èˆŠåƒ¹æ ¼
                if(item.latestPrice && item.latestPrice != result.price) {
                     if(!item.priceHistory) item.priceHistory = [];
                     item.priceHistory.push({date: item.priceDate || new Date().toISOString().split('T')[0], price: item.latestPrice});
                }
                item.latestPrice = result.price;
                item.unitPrice = result.unitPrice;
                item.brand = result.brand || item.brand;
                item.priceDate = new Date().toISOString().split('T')[0];
                
                this.saveData(); alert(`åƒ¹æ ¼å·²æ›´æ–°: $${result.price}`);
            } catch(e) { alert('åˆ†æå¤±æ•—'); } finally { this.isAnalyzing = false; }
        },

        // --- ç³»çµ±å‚™ä»½ ---
        exportData() {
            const a = document.createElement('a'); 
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ inventory: this.inventory, expenses: this.expenses, apiKey: this.apiKey }));
            a.download = "good_husband_backup.json"; document.body.appendChild(a); a.click(); a.remove();
        },
        importData(e) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const p = JSON.parse(evt.target.result);
                this.inventory = p.inventory || []; this.expenses = p.expenses || []; this.apiKey = p.apiKey || '';
                this.saveData(); alert('é‚„åŸæˆåŠŸ');
            };
            reader.readAsText(e.target.files[0]);
        }
    }
}).mount('#app');
</script>
</body>
</html>
