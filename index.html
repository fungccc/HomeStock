<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½ç”·äººæ™ºæ…§å®¶å±… v5.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 90px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: none; margin-bottom: 15px; }
        .nav-link.active { background-color: #0d6efd !important; color: white !important; }
        [v-cloak] { display: none; }
        .table-responsive { overflow-x: auto; }
        .table > tbody > tr > td { vertical-align: middle; }
        
        .category-tag { font-size: 0.7rem; padding: 2px 6px; background: #e9ecef; border-radius: 4px; color: #666; display: inline-block; margin-right: 4px; white-space: nowrap;}
        .brand-tag { font-size: 0.7rem; padding: 2px 6px; background: #e3f2fd; border-radius: 4px; color: #0d6efd; display: inline-block; white-space: nowrap;}
        
        .item-name { font-weight: 600; font-size: 1rem; line-height: 1.4; word-break: break-word; white-space: normal; }
        .price-tag { font-size: 0.9rem; color: #198754; font-weight: bold; display: inline-flex; align-items: center; }
        .unit-price { font-size: 0.75rem; color: #888; margin-left: 4px; font-weight: normal;}
        .link-icon { color: #0d6efd; margin-left: 6px; font-size: 0.9rem; transition: transform 0.2s; }
        .link-icon:hover { transform: scale(1.2); color: #0a58ca; }

        /* æµ®å‹•æ“ä½œåˆ— */
        .floating-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(5px);
            padding: 10px 10px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; gap: 8px; z-index: 1000; align-items: center;
            border: 1px solid #dee2e6; width: 95%; max-width: 450px; justify-content: space-around;
        }
        .floating-btn { border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; color: #555; cursor: pointer; width: 55px; }
        .floating-btn i { font-size: 1.3rem; margin-bottom: 2px; }
        
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; }
        .search-box input { padding-left: 35px; border-radius: 20px; }

        /* è³¼ç‰©è»Šèˆ‡æŠ˜æ‰£å€å¡Š */
        .cart-item { background: #fdfdfe; border-bottom: 1px solid #eee; padding: 8px; font-size: 0.9rem; }
        .cart-summary { background-color: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<div id="app" class="container py-3" v-cloak>
    <h4 class="mb-3 text-center fw-bold">ğŸ‘¨â€ğŸ’¼ å¥½ç”·äººæ™ºæ…§å®¶å±… v5.1</h4>

    <ul class="nav nav-pills mb-3 justify-content-center nav-justified bg-white p-1 rounded shadow-sm">
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'" href="#">ğŸ“¦ åº«å­˜</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'expenses'}" @click="currentTab = 'expenses'" href="#">ğŸ’¸ æ”¯å‡º/è¨‚å–®</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'pricewatch'}" @click="currentTab = 'pricewatch'" href="#">ğŸ¤– æ ¼åƒ¹</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'settings'}" @click="currentTab = 'settings'" href="#">âš™ï¸ è¨­å®š</a></li>
    </ul>

    <div v-if="currentTab === 'inventory'">
        <div class="card p-3 mb-3 sticky-top" style="z-index: 900; background: rgba(255,255,255,0.95);">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input v-model="searchQuery" type="text" class="form-control" placeholder="æœå°‹åç¨±ã€å“ç‰Œ...">
            </div>
            <div class="d-flex justify-content-between mt-2 align-items-center">
                <span class="small text-muted">{{ filteredInventory.length }} é …ç‰©å“</span>
                <button v-if="selectedItems.length > 0" @click="selectAll(false)" class="btn btn-sm btn-link text-danger text-decoration-none">å–æ¶ˆå…¨é¸</button>
            </div>
        </div>

        <div class="card p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">ç‰©å“è³‡è¨Š</th>
                            <th class="text-center" style="min-width: 90px;">åº«å­˜</th>
                            <th class="text-center" style="width: 40px;">é¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in filteredInventory" :key="item.id" :class="{'table-active': isSelected(item)}">
                            <td class="ps-3 py-3" @click="toggleSelection(item)">
                                <div class="mb-1">
                                    <span class="category-tag">{{ getCategoryName(item.categoryId) }}</span>
                                    <span v-if="item.brand" class="brand-tag">{{ item.brand }}</span>
                                </div>
                                <div class="item-name">{{ item.name }}</div>
                                <div class="mt-1 d-flex flex-wrap align-items-center gap-2">
                                    <span class="price-tag">
                                        {{ item.latestPrice ? '$'+item.latestPrice : '-' }}
                                        <span class="unit-price" v-if="item.unitPrice">({{ item.unitPrice }})</span>
                                        <a v-if="item.url" :href="item.url" target="_blank" class="link-icon" @click.stop><i class="bi bi-box-arrow-up-right"></i></a>
                                    </span>
                                </div>
                            </td>
                            <td class="text-center align-middle">
                                <div class="btn-group btn-group-sm">
                                    <button @click.stop="updateStock(item, -1)" class="btn btn-outline-secondary px-2">-</button>
                                    <button class="btn btn-light disabled text-dark fw-bold border-top border-bottom px-0" style="width:30px">{{ item.stock }}</button>
                                    <button @click.stop="updateStock(item, 1)" class="btn btn-outline-success px-2">+</button>
                                </div>
                            </td>
                            <td class="text-center align-middle" @click="toggleSelection(item)">
                                <input type="checkbox" class="form-check-input" :checked="isSelected(item)">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div v-if="selectedItems.length === 0" style="position: fixed; bottom: 25px; right: 25px; z-index: 999;">
            <button @click="openAddModal" class="btn btn-primary rounded-circle shadow p-0" style="width: 56px; height: 56px; font-size: 24px;"><i class="bi bi-plus-lg"></i></button>
        </div>

        <div v-if="selectedItems.length > 0" class="floating-bar">
            <button @click="actionEdit" class="floating-btn" :class="{disabled: selectedItems.length > 1}"><i class="bi bi-pencil-square"></i> ç·¨è¼¯</button>
            <button @click="prepareExport('whatsapp')" class="floating-btn text-success"><i class="bi bi-whatsapp"></i> WA</button>
            <button @click="prepareExport('share')" class="floating-btn text-primary"><i class="bi bi-share-fill"></i> åˆ†äº«</button>
            <button @click="prepareExport('copy')" class="floating-btn"><i class="bi bi-clipboard"></i> è¤‡è£½</button>
            <button @click="actionDelete" class="floating-btn text-danger"><i class="bi bi-trash"></i> åˆªé™¤</button>
        </div>
    </div>

    <div v-if="currentTab === 'expenses'">
        <div class="card p-3 mb-3 border-primary">
            <h5 class="text-primary fw-bold">
                <i class="bi bi-cart-plus"></i> {{ isEditingExpense ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢æ”¯å‡º / è¨‚å–®' }}
                <button v-if="isEditingExpense" @click="cancelEditExpense" class="btn btn-sm btn-outline-secondary float-end">å–æ¶ˆ</button>
            </h5>
            
            <div class="row g-2">
                <div class="col-6"><label class="small text-muted">æ—¥æœŸ</label><input v-model="newExpense.date" type="date" class="form-control"></div>
                <div class="col-6"><label class="small text-muted">é¡åˆ¥</label>
                    <select v-model="newExpense.category" class="form-select">
                        <option value="è³¼ç‰©è¨‚å–®">ğŸ›’ è³¼ç‰©è¨‚å–®</option><option value="é›»è²»">âš¡ é›»è²»</option><option value="æ°´è²»">ğŸ’§ æ°´è²»</option><option value="ç…¤æ°£">ğŸ”¥ ç…¤æ°£è²»</option><option value="å¯¬é »/é›»è©±">ğŸ“¶ å¯¬é »/é›»è©±</option><option value="é¤é£²">ğŸ½ï¸ é¤é£²</option><option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                    </select>
                </div>

                <div v-if="newExpense.category === 'è³¼ç‰©è¨‚å–®'" class="col-12 mt-2">
                    <div class="bg-light p-2 rounded border">
                        <label class="small fw-bold mb-1">é¸æ“‡ç‰©å“:</label>
                        <div class="input-group mb-2">
                            <select v-model="selectedInventoryItem" class="form-select">
                                <option :value="null">-- è«‹é¸æ“‡ --</option>
                                <option v-for="item in inventory" :value="item">{{ item.name }} (${{item.latestPrice}})</option>
                            </select>
                            <input v-model.number="tempQty" type="number" class="form-control" placeholder="æ•¸é‡" style="max-width: 80px;" min="1">
                            <button @click="addCartItem" class="btn btn-primary" :disabled="!selectedInventoryItem">åŠ å…¥</button>
                        </div>

                        <div v-if="newExpense.items && newExpense.items.length > 0">
                            <div v-for="(cartItem, idx) in newExpense.items" :key="idx" class="cart-item d-flex justify-content-between align-items-center">
                                <div style="flex-grow: 1;">
                                    <div>{{ cartItem.name }}</div>
                                    <div class="small text-muted">{{ cartItem.brand }} | ${{ cartItem.price }} x {{ cartItem.qty }}</div>
                                </div>
                                <div class="text-end" style="min-width: 60px;">
                                    <span class="fw-bold">${{ (cartItem.price * cartItem.qty).toFixed(1) }}</span>
                                    <i @click="removeCartItem(idx)" class="bi bi-x text-danger ms-2 fs-5" style="cursor:pointer; vertical-align: middle;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 mt-2">
                     <div class="cart-summary border p-2 rounded bg-white">
                        <div class="row g-2 align-items-center">
                            <div class="col-5">
                                <label class="small text-muted">æŠ˜æ‰£/å„ªæƒ </label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">- $</span>
                                    <input v-model.number="newExpense.discount" type="number" class="form-control" placeholder="0">
                                </div>
                            </div>
                            <div class="col-7 text-end">
                                <label class="small text-muted d-block">å¯¦ä»˜é‡‘é¡</label>
                                <div class="fs-4 fw-bold text-danger">
                                    ${{ calculatedTotalAmount }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <label class="small text-muted">åº—é‹ª / å‚™è¨»</label>
                    <div class="input-group">
                        <select v-model="selectedStore" class="form-select">
                            <option v-for="store in storeOptions" :value="store">{{ store }}</option>
                            <option value="other">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)...</option>
                        </select>
                        <input v-if="selectedStore === 'other'" v-model="customStoreInput" type="text" class="form-control" placeholder="è¼¸å…¥åº—å">
                    </div>
                </div>

                <div class="col-12">
                    <label class="small text-muted">å–®è™Ÿ / ä»˜æ¬¾åƒè€ƒ (é¸å¡«)</label>
                    <input v-model="newExpense.refNumber" class="form-control" placeholder="ä¾‹: HKTV-8888">
                </div>
                
                <div class="col-12 mt-3">
                    <button @click="saveExpense" class="btn w-100" :class="isEditingExpense ? 'btn-warning' : 'btn-primary'">
                        {{ isEditingExpense ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„' }}
                    </button>
                </div>
            </div>
        </div>

        <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">ç´€éŒ„åˆ—è¡¨</h5>
                <button @click="exportExpenseCSV" class="btn btn-sm btn-outline-success"><i class="bi bi-file-earmark-excel"></i> CSV</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-sm text-nowrap align-middle">
                    <thead><tr><th>æ—¥æœŸ</th><th>é¡åˆ¥/å–®è™Ÿ</th><th>é‡‘é¡</th><th>æ“ä½œ</th></tr></thead>
                    <tbody>
                        <tr v-for="(exp, index) in sortedExpenses" :key="index">
                            <td>
                                <div>{{ exp.date }}</div>
                                <div class="small text-muted">{{ exp.note }}</div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border">{{ exp.category }}</span>
                                <div v-if="exp.refNumber" class="small text-muted" style="font-size:0.7rem">#{{ exp.refNumber }}</div>
                            </td>
                            <td class="fw-bold">${{ exp.amount }}</td>
                            <td>
                                <button v-if="exp.items && exp.items.length > 0" @click="viewOrderDetails(exp)" class="btn btn-xs btn-outline-info me-1">
                                    <i class="bi bi-file-text"></i> æ˜ç´°
                                </button>
                                <i @click="deleteExpense(index)" class="bi bi-x-circle text-danger ms-1" style="cursor:pointer"></i>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'pricewatch'">
        <div class="card p-3 border-warning mb-3">
            <h5 class="text-warning-emphasis"><i class="bi bi-robot"></i> Gemini JSON åŒ¯å…¥</h5>
            <textarea v-model="importJsonText" class="form-control mb-2" rows="2" placeholder='è²¼ä¸Š JSON...'></textarea>
            <button @click="importFromJSON" class="btn btn-warning w-100">åŒ¯å…¥</button>
        </div>
        <div class="card p-3" :class="{ loading: isAnalyzing }">
            <h5>ğŸ¤– åƒ¹æ ¼åˆ†æå™¨</h5>
            <select v-model="selectedItemForAnalysis" class="form-select mb-2">
                <option :value="null">-- é¸æ“‡ç¾æœ‰ç‰©å“æ›´æ–° --</option>
                <option v-for="item in inventory" :value="item">{{ item.name }}</option>
            </select>
            <textarea v-model="pastedText" class="form-control mb-2" rows="3" placeholder="è²¼ä¸Šç¶²é æ–‡å­—..."></textarea>
            <button @click="analyzePrice" class="btn btn-success w-100" :disabled="!apiKey || !selectedItemForAnalysis">åˆ†æä¸¦æ›´æ–°</button>
        </div>
    </div>

    <div v-if="currentTab === 'settings'">
        <div class="card p-3 mb-3">
            <h5>ğŸ”‘ Gemini API Key</h5>
            <input v-model="apiKey" type="password" class="form-control mb-2" placeholder="API Key">
            <button @click="saveSettings" class="btn btn-success w-100">å„²å­˜</button>
        </div>
        <div class="card p-3">
            <h5>ğŸ’¾ è³‡æ–™åº«ç®¡ç†</h5>
            <div class="row g-2 mb-3">
                <div class="col-6"><button @click="exportData('json')" class="btn btn-outline-primary w-100 h-100 p-2"><i class="bi bi-filetype-json fs-4"></i><br><span class="small">å®Œæ•´å‚™ä»½</span></button></div>
                <div class="col-6"><button @click="exportData('csv')" class="btn btn-outline-success w-100 h-100 p-2"><i class="bi bi-filetype-csv fs-4"></i><br><span class="small">åº«å­˜ CSV</span></button></div>
            </div>
            <label class="form-label fw-bold">ğŸ“¥ åŒ¯å…¥è³‡æ–™</label>
            <input type="file" @change="importData" class="form-control" accept=".json,.csv">
        </div>
    </div>

    <div v-if="showExportModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">å‚³é€å…§å®¹</h5><button @click="showExportModal = false" class="btn-close"></button></div>
                <div class="modal-body d-grid gap-2">
                    <button @click="confirmExport('buy')" class="btn btn-outline-primary text-start fw-bold">ğŸ›’ éœ€è³¼è²·æ¸…å–®</button>
                    <button @click="confirmExport('inventory')" class="btn btn-outline-success text-start fw-bold">ğŸ“¦ åº«å­˜æ¸…å–®</button>
                    <button @click="confirmExport('links')" class="btn btn-outline-info text-start fw-bold">ğŸ”— ç‰©å“é€£çµ</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showOrderDetailModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">ğŸ“œ è¨‚å–®æ˜ç´°</h5>
                    <button @click="showOrderDetailModal = false" class="btn-close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="p-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <div class="fw-bold">{{ viewingOrder.date }}</div>
                            <button @click="editOrderFromModal" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i> ç·¨è¼¯æ­¤å–®</button>
                        </div>
                        <div class="mt-1">{{ viewingOrder.note }}</div>
                        <div class="small text-muted" v-if="viewingOrder.refNumber">å–®è™Ÿ: {{ viewingOrder.refNumber }}</div>
                    </div>
                    <table class="table table-sm mb-0">
                        <thead class="table-light"><tr><th>ç‰©å“</th><th>å–®åƒ¹ x æ•¸é‡</th><th>å°è¨ˆ</th></tr></thead>
                        <tbody>
                            <tr v-for="(itm, idx) in viewingOrder.items" :key="idx">
                                <td>{{ itm.name }}</td>
                                <td>${{ itm.price }} x {{ itm.qty }}</td>
                                <td class="text-end pe-3">${{ (itm.price * itm.qty).toFixed(1) }}</td>
                            </tr>
                        </tbody>
                        <tfoot class="table-group-divider">
                            <tr v-if="viewingOrder.discount > 0">
                                <td colspan="2" class="text-end text-muted">æŠ˜æ‰£:</td>
                                <td class="text-end pe-3 text-muted">- ${{ viewingOrder.discount }}</td>
                            </tr>
                            <tr>
                                <td colspan="2" class="text-end fw-bold">å¯¦ä»˜ç¸½è¨ˆ:</td>
                                <td class="text-end pe-3 fw-bold text-danger">${{ viewingOrder.amount }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showAddModal || showEditModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ showEditModal ? 'ç·¨è¼¯' : 'æ–°å¢' }}</h5>
                    <button @click="closeModal" class="btn-close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-2">
                        <div class="col-6"><label class="small">åˆ†é¡</label><select v-model="editingForm.categoryId" class="form-select"><option v-for="cat in categories" :value="cat.id">{{ cat.name }}</option></select></div>
                        <div class="col-6"><label class="small">å“ç‰Œ</label><input v-model="editingForm.brand" class="form-control"></div>
                    </div>
                    <div class="mb-2"><label class="small">åç¨±</label><textarea v-model="editingForm.name" class="form-control" rows="2"></textarea></div>
                    <div class="row g-2 mb-2">
                        <div class="col-4"><label class="small">åº«å­˜</label><input v-model.number="editingForm.stock" type="number" class="form-control"></div>
                        <div class="col-4"><label class="small">ç¸½åƒ¹</label><input v-model.number="editingForm.latestPrice" type="number" class="form-control"></div>
                        <div class="col-4"><label class="small">å–®åƒ¹</label><input v-model="editingForm.unitPrice" class="form-control"></div>
                    </div>
                    <div class="mb-2"><label class="small">ç¶²å€</label><input v-model="editingForm.url" class="form-control"></div>
                </div>
                <div class="modal-footer"><button @click="closeModal" class="btn btn-secondary">å–æ¶ˆ</button><button @click="saveItem" class="btn btn-primary">å„²å­˜</button></div>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            currentTab: 'expenses', apiKey: '', searchQuery: '',
            inventory: [], expenses: [], selectedIds: [],
            
            // Modal & Editing
            showAddModal: false, showEditModal: false, showExportModal: false, showOrderDetailModal: false,
            exportActionType: '', editingForm: {}, viewingOrder: {},
            
            // Gemini
            importJsonText: '', pastedText: '', isAnalyzing: false, selectedItemForAnalysis: null,
            
            // Expense & Cart Form
            newExpense: { date: new Date().toISOString().split('T')[0], category: 'è³¼ç‰©è¨‚å–®', amount: 0, note: '', refNumber: '', items: [], discount: 0 },
            selectedInventoryItem: null,
            tempQty: 1, // è³¼ç‰©è»Šæš«å­˜æ•¸é‡
            selectedStore: 'æƒ åº·', // é è¨­åº—é‹ª
            customStoreInput: '', // æ‰‹å‹•è¼¸å…¥
            isEditingExpense: false, // æ˜¯å¦æ­£åœ¨ç·¨è¼¯æ¨¡å¼
            editingExpenseIndex: -1, // æ­£åœ¨ç·¨è¼¯çš„ç´¢å¼•

            // Options
            categories: [
                { id: '10', name: 'é£Ÿå“/ä¹¾ç³§' }, { id: '20', name: 'é£²å“' }, { id: '30', name: 'å®¶å±…æ¸…æ½”' }, { id: '40', name: 'å€‹äººè­·ç†' },
                { id: '50', name: 'ç´™å“/è¡›ç”Ÿ' }, { id: '60', name: 'å»šæˆ¿ç”¨å“' }, { id: '70', name: 'è—¥å“/ä¿å¥' }, { id: '99', name: 'å…¶ä»–' }
            ],
            storeOptions: ['æƒ åº·', 'ç™¾ä½³', '759é˜¿ä¿¡å±‹', 'HKTVmall', 'å±ˆè‡£æ°', 'è¬å¯§']
        };
    },
    computed: {
        filteredInventory() {
            const query = this.searchQuery.toLowerCase().trim();
            if (!query) return this.inventory;
            return this.inventory.filter(item => {
                const matchName = item.name.toLowerCase().includes(query);
                const matchBrand = item.brand && item.brand.toLowerCase().includes(query);
                return matchName || matchBrand;
            });
        },
        selectedItems() { return this.inventory.filter(item => this.selectedIds.includes(item.id)); },
        sortedExpenses() { return this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)); },
        
        // è‡ªå‹•è¨ˆç®—å¯¦ä»˜é‡‘é¡ (å”¯è®€é¡¯ç¤ºç”¨)
        calculatedTotalAmount() {
            if (this.newExpense.category !== 'è³¼ç‰©è¨‚å–®') return this.newExpense.amount;
            const itemsTotal = (this.newExpense.items || []).reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discount = this.newExpense.discount || 0;
            return Math.max(0, itemsTotal - discount).toFixed(1); // ç¢ºä¿ä¸ç‚ºè² 
        }
    },
    mounted() { this.loadData(); },
    methods: {
        saveData() { localStorage.setItem('goodHusbandDB_v5_1', JSON.stringify({ inventory: this.inventory, expenses: this.expenses, apiKey: this.apiKey })); },
        loadData() {
            let data = localStorage.getItem('goodHusbandDB_v5_1') || localStorage.getItem('goodHusbandDB_v5');
            if (data) {
                let p = JSON.parse(data);
                this.inventory = p.inventory || [];
                this.expenses = p.expenses || [];
                this.apiKey = p.apiKey || '';
            }
        },
        saveSettings() { this.saveData(); alert('è¨­å®šå·²å„²å­˜ï¼'); },
        getCategoryName(id) { const c = this.categories.find(x => x.id == id); return c ? c.name : 'æœªåˆ†é¡'; },
        
        // --- Inventory Selection ---
        isSelected(item) { return this.selectedIds.includes(item.id); },
        toggleSelection(item) { const id = item.id; if(this.selectedIds.includes(id)) this.selectedIds=this.selectedIds.filter(i=>i!==id); else this.selectedIds.push(id); },
        selectAll(doSelect) { this.selectedIds = doSelect ? this.filteredInventory.map(i => i.id) : []; },

        // --- Export ---
        prepareExport(type) { this.exportActionType = type; this.showExportModal = true; },
        confirmExport(format) {
            this.showExportModal = false;
            let text = "";
            if (format === 'buy') text = "ğŸ›’ *éœ€è³¼è²·æ¸…å–®*ï¼š\n" + this.selectedItems.map(i => `- ${i.name} (åº«å­˜:${i.stock})`).join('\n');
            else if (format === 'inventory') text = "ğŸ“¦ *åº«å­˜æ¸…å–®*ï¼š\n" + this.selectedItems.map(i => `- ${i.name} [${i.brand||''}] | $${i.latestPrice||'-'}`).join('\n');
            else if (format === 'links') text = "ğŸ”— *ç‰©å“é€£çµ*ï¼š\n" + this.selectedItems.map(i => `- ${i.name}\n  ${i.url || 'ç„¡é€£çµ'}`).join('\n');
            
            if (this.exportActionType === 'whatsapp') window.location.href = `whatsapp://send?text=${encodeURIComponent(text)}`;
            else if (this.exportActionType === 'share') { if (navigator.share) navigator.share({title:'åº«å­˜', text:text}); else alert("ä¸æ”¯æ´åˆ†äº«"); }
            else if (this.exportActionType === 'copy') navigator.clipboard.writeText(text).then(()=>alert('å·²è¤‡è£½'));
        },

        // --- Inventory CRUD ---
        openAddModal() { this.editingForm = { categoryId: '99', stock: 1, brand: '' }; this.showAddModal = true; },
        closeModal() { this.showAddModal = false; this.showEditModal = false; this.editingForm = {}; },
        saveItem() {
            if(!this.editingForm.name) return alert('åç¨±å¿…å¡«');
            if (this.showEditModal) {
                const idx = this.inventory.findIndex(i => i.id === this.editingForm.id);
                if (idx !== -1) this.inventory[idx] = { ...this.editingForm };
            } else {
                this.editingForm.id = Date.now().toString();
                this.inventory.push(this.editingForm);
            }
            this.saveData(); this.closeModal(); this.selectedIds = [];
        },
        actionDelete() { if(!confirm('åˆªé™¤ï¼Ÿ')) return; this.inventory = this.inventory.filter(i => !this.selectedIds.includes(i.id)); this.selectedIds = []; this.saveData(); },
        actionEdit() { if(this.selectedItems.length!==1) return; this.editingForm = JSON.parse(JSON.stringify(this.selectedItems[0])); this.showEditModal = true; },
        updateStock(item, change) { item.stock = Math.max(0, (item.stock||0)+change); this.saveData(); },

        // --- Cart Logic (Updated) ---
        addCartItem() {
            if (!this.selectedInventoryItem) return;
            if (this.tempQty < 1) return alert('æ•¸é‡è‡³å°‘ç‚º 1');
            
            if (!this.newExpense.items) this.newExpense.items = [];
            
            this.newExpense.items.push({
                itemId: this.selectedInventoryItem.id,
                name: this.selectedInventoryItem.name,
                brand: this.selectedInventoryItem.brand || '',
                price: this.selectedInventoryItem.latestPrice || 0,
                qty: this.tempQty // ä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„æ•¸é‡
            });
            this.tempQty = 1; // é‡ç½®
            this.selectedInventoryItem = null;
        },
        removeCartItem(idx) {
            this.newExpense.items.splice(idx, 1);
        },

        // --- Expense Management (Updated) ---
        saveExpense() {
            // è™•ç†åº—é‹ªåç¨±
            let storeName = this.selectedStore;
            if (storeName === 'other') storeName = this.customStoreInput || 'å…¶ä»–';
            this.newExpense.note = storeName;

            // è™•ç†é‡‘é¡ (å¦‚æœæ˜¯è³¼ç‰©è¨‚å–®ï¼Œä½¿ç”¨è‡ªå‹•è¨ˆç®—å€¼)
            if (this.newExpense.category === 'è³¼ç‰©è¨‚å–®') {
                 this.newExpense.amount = parseFloat(this.calculatedTotalAmount);
            }
            if(!this.newExpense.amount && this.newExpense.amount !== 0) return alert('é‡‘é¡å¿…å¡«');

            // å„²å­˜é‚è¼¯
            if (this.isEditingExpense) {
                // æ›´æ–°æ¨¡å¼
                this.expenses[this.editingExpenseIndex] = { ...this.newExpense };
                alert('ç´€éŒ„å·²æ›´æ–°');
            } else {
                // æ–°å¢æ¨¡å¼
                this.newExpense.id = Date.now().toString() + Math.random().toString(36).substr(2,5);
                this.expenses.push({ ...this.newExpense });
                
                // åº«å­˜å…¥å¸³æç¤º (åªåœ¨æ–°å¢æ™‚æç¤º)
                if (this.newExpense.category === 'è³¼ç‰©è¨‚å–®' && this.newExpense.items && this.newExpense.items.length > 0) {
                    if (confirm(`å„²å­˜æˆåŠŸï¼\næ˜¯å¦è¦å°‡é€™ ${this.newExpense.items.length} é …å•†å“çš„æ•¸é‡åŠ å…¥åº«å­˜ï¼Ÿ`)) {
                        this.updateInventoryFromOrder(this.newExpense.items);
                    }
                }
            }

            this.resetExpenseForm();
            this.saveData();
        },
        updateInventoryFromOrder(items) {
            let count = 0;
            items.forEach(orderItem => {
                const invItem = this.inventory.find(i => i.id === orderItem.itemId);
                if (invItem) {
                    invItem.stock = (invItem.stock || 0) + orderItem.qty;
                    count++;
                }
            });
            alert(`å·²æ›´æ–° ${count} å€‹åº«å­˜é …ç›®çš„æ•¸é‡ã€‚`);
        },
        deleteExpense(idx) { if(confirm('åˆªé™¤ç´€éŒ„ï¼Ÿ')) { this.expenses.splice(idx, 1); this.saveData(); } },
        
        viewOrderDetails(exp) {
            this.viewingOrder = exp;
            this.showOrderDetailModal = true;
        },
        
        // ç·¨è¼¯è¨‚å–® (å¾ Modal è§¸ç™¼)
        editOrderFromModal() {
            this.showOrderDetailModal = false; // é—œé–‰ Modal
            
            // è¼‰å…¥è³‡æ–™åˆ°è¡¨å–®
            this.newExpense = JSON.parse(JSON.stringify(this.viewingOrder));
            
            // è¨­å®šåº—é‹ªä¸‹æ‹‰é¸å–®ç‹€æ…‹
            if (this.storeOptions.includes(this.newExpense.note)) {
                this.selectedStore = this.newExpense.note;
            } else {
                this.selectedStore = 'other';
                this.customStoreInput = this.newExpense.note;
            }

            // è¨­å®šç·¨è¼¯ç‹€æ…‹
            this.isEditingExpense = true;
            this.editingExpenseIndex = this.expenses.findIndex(e => e.id === this.viewingOrder.id);
            
            // æ»¾å‹•åˆ°é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },
        cancelEditExpense() {
            this.resetExpenseForm();
        },
        resetExpenseForm() {
            this.newExpense = { date: new Date().toISOString().split('T')[0], category: 'è³¼ç‰©è¨‚å–®', amount: 0, note: '', refNumber: '', items: [], discount: 0 };
            this.selectedInventoryItem = null;
            this.tempQty = 1;
            this.isEditingExpense = false;
            this.editingExpenseIndex = -1;
            this.selectedStore = 'æƒ åº·';
            this.customStoreInput = '';
        },
        
        exportExpenseCSV() {
            let csv = "\uFEFFæ—¥æœŸ,é¡åˆ¥,é‡‘é¡,å–®è™Ÿ,å‚™è¨»\n";
            this.sortedExpenses.forEach(e => csv += `${e.date},${e.category},${e.amount},"${e.refNumber||''}", "${e.note||''}"\n`);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = "family_expenses.csv"; document.body.appendChild(a); a.click(); a.remove();
        },

        // --- Gemini & Others ---
        importFromJSON() { try { const list = JSON.parse(this.importJsonText); if(Array.isArray(list)) { list.forEach(i => { i.id = Date.now()+Math.random().toString(36).substr(2,5); i.stock=0; }); this.inventory.push(...list); this.importJsonText=''; this.saveData(); alert(`åŒ¯å…¥ ${list.length}`); } } catch(e){alert('JSON éŒ¯èª¤');} },
        async analyzePrice() { if(!this.pastedText||!this.apiKey)return alert('è«‹å¡«å¯«'); this.isAnalyzing=true; try{ const prompt=`åˆ†æå•†å“:"${this.pastedText}" JSON:{"price":æ•¸,"unitPrice":"æ–‡","brand":"æ–‡"}`; const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})}); const data=await res.json(); const r=JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim()); this.selectedItemForAnalysis.latestPrice=r.price; this.selectedItemForAnalysis.unitPrice=r.unitPrice; this.selectedItemForAnalysis.brand=r.brand; this.saveData(); alert(`æ›´æ–°:$${r.price}`); }catch(e){alert('å¤±æ•—');}finally{this.isAnalyzing=false;} },
        exportData(type) { if(type==='json'){ const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({inventory:this.inventory,expenses:this.expenses,apiKey:this.apiKey})); a.download="backup.json"; document.body.appendChild(a);a.click();a.remove(); } else if(type==='csv'){ let csv="\uFEFFid,åˆ†é¡,å“ç‰Œ,åç¨±,åº«å­˜,åƒ¹æ ¼,å–®åƒ¹,ISBN,ç¶²å€\n"; this.inventory.forEach(i=>{ csv+=[i.id,i.categoryId,i.brand,i.name,i.stock,i.latestPrice,i.unitPrice,i.isbn,i.url].map(f=>`"${String(f||'').replace(/"/g,'""')}"`).join(',')+"\n"; }); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download="inventory.csv"; document.body.appendChild(a);a.click();a.remove(); } },
        importData(e) { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(evt)=>{ const c=evt.target.result; if(f.name.endsWith('.json')){ try{ const p=JSON.parse(c); this.inventory=p.inventory||[]; this.expenses=p.expenses||[]; this.apiKey=p.apiKey||[]; this.saveData(); alert('é‚„åŸæˆåŠŸ'); }catch(err){alert('JSONéŒ¯èª¤');} return; } const l=c.trim().split(/\r?\n/); if(l.length<2)return alert('å…§å®¹éçŸ­'); if(l[0].includes('é¡åˆ¥')&&l[0].includes('é‡‘é¡')){ let cnt=0; for(let i=1;i<l.length;i++){ const cols=l[i].split(','); if(cols.length>=3){ this.expenses.push({ id:Date.now()+Math.random().toString(36), date:cols[0], category:cols[1], amount:parseFloat(cols[2]), refNumber:cols[3]||'', note:cols[4]||'CSV' }); cnt++; } } this.saveData(); alert(`åŒ¯å…¥${cnt}ç­†æ”¯å‡º`); } else { alert('åº«å­˜CSV...'); /* ç°¡åŒ–åº«å­˜åŒ¯å…¥é‚è¼¯ */ } }; r.readAsText(f); }
    }
}).mount('#app');
</script>
</body>
</html>
