<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å®¶å±…åº«å­˜èˆ‡æ ¼åƒ¹ç³»çµ± (Gemini AI)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .status-low { color: red; font-weight: bold; }
        .status-ok { color: green; }
        .nav-link.active { background-color: #0d6efd !important; color: white !important; }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>

<div id="app" class="container py-4">
    <h2 class="mb-4 text-center">ğŸ  æ™ºæ…§å®¶å±…åº«å­˜èˆ‡æ ¼åƒ¹ç³»çµ±</h2>

    <ul class="nav nav-pills mb-4 justify-content-center">
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'" href="#">ğŸ“¦ ç”¨å“åº«å­˜</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'pricewatch'}" @click="currentTab = 'pricewatch'" href="#">ğŸ’° æ ¼åƒ¹è¿½è¹¤</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'utility'}" @click="currentTab = 'utility'" href="#">âš¡ æ°´é›»ç…¤ç´€éŒ„</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'settings'}" @click="currentTab = 'settings'" href="#">âš™ï¸ è¨­å®šèˆ‡å‚™ä»½</a></li>
    </ul>

    <div v-if="currentTab === 'inventory'">
        <div class="card p-3">
            <h4>æ–°å¢/ç·¨è¼¯ç”¨å“</h4>
            <div class="row g-2">
                <div class="col-md-3">
                    <input v-model="newItem.name" type="text" class="form-control" placeholder="å•†å“åç¨± (ä¾‹: ç¶­ä»–æª¸æª¬èŒ¶)">
                </div>
                <div class="col-md-2">
                    <input v-model.number="newItem.stock" type="number" class="form-control" placeholder="ç¾æœ‰åº«å­˜">
                </div>
                <div class="col-md-2">
                    <input v-model.number="newItem.checkInterval" type="number" class="form-control" placeholder="æŸ¥åƒ¹é€±æœŸ(å¤©)">
                </div>
                <div class="col-md-2">
                    <input v-model="newItem.lastBuyDate" type="date" class="form-control" title="ä¸Šæ¬¡è³¼è²·æ—¥">
                </div>
                <div class="col-md-3">
                    <button @click="addItem" class="btn btn-primary w-100">æ–°å¢ç´€éŒ„</button>
                </div>
            </div>
        </div>

        <div class="card p-3">
            <h4>åº«å­˜åˆ—è¡¨</h4>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>åç¨±</th>
                        <th>åº«å­˜</th>
                        <th>ä¸Šæ¬¡è³¼è²·</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item, index) in inventory" :key="index">
                        <td>{{ item.name }}</td>
                        <td>
                            <button @click="item.stock--" class="btn btn-sm btn-outline-danger">-</button>
                            <span class="mx-2">{{ item.stock }}</span>
                            <button @click="item.stock++" class="btn btn-sm btn-outline-success">+</button>
                        </td>
                        <td>{{ item.lastBuyDate || 'æœªè¨˜éŒ„' }}</td>
                        <td :class="item.stock < 2 ? 'status-low' : 'status-ok'">
                            {{ item.stock < 2 ? 'è£œè²¨!' : 'å……è¶³' }}
                        </td>
                        <td>
                            <button @click="deleteItem(index)" class="btn btn-sm btn-danger">åˆªé™¤</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div v-if="currentTab === 'pricewatch'">
        <div class="alert alert-info">
            <small>ğŸ’¡ é»æ“Šã€Œå‰å¾€æœå°‹ã€æ‰“é–‹ç¶²åº—ï¼Œè¤‡è£½å•†å“æ–‡å­—ï¼Œè²¼å…¥ä¸‹æ–¹è®“ Gemini åˆ†æåƒ¹æ ¼ä¸¦æ›´æ–°ç´€éŒ„ã€‚</small>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-3">
                    <h4>éœ€æŸ¥åƒ¹ç‰©å“ (æ¯ {{ newItem.checkInterval || 'N' }} æ—¥)</h4>
                    <ul class="list-group">
                        <li v-for="(item, index) in itemsDueForCheck" :key="index" class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>{{ item.name }}</strong>
                                <small class="text-muted">ä¸Šæ¬¡: {{ item.lastPriceCheck || 'å¾æœª' }}</small>
                            </div>
                            <div class="mt-2">
                                <a :href="'https://www.wellcome.com.hk/zh-hant/search?q=' + encodeURIComponent(item.name)" target="_blank" class="btn btn-sm btn-outline-danger me-1">æƒ åº·æœå°‹</a>
                                <a :href="'https://www.pns.hk/zh-hk/search?text=' + encodeURIComponent(item.name)" target="_blank" class="btn btn-sm btn-outline-primary">ç™¾ä½³æœå°‹</a>
                                <button @click="selectItemForAnalysis(item)" class="btn btn-sm btn-warning float-end">æ›´æ–°åƒ¹æ ¼</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-3" :class="{ loading: isAnalyzing }">
                    <h4>ğŸ¤– Gemini AI åƒ¹æ ¼åˆ†æå™¨</h4>
                    <div v-if="selectedItem">
                        <p>æ­£åœ¨æ›´æ–°: <strong>{{ selectedItem.name }}</strong></p>
                        <textarea v-model="pastedText" class="form-control mb-2" rows="5" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šç¶²åº—çš„å•†å“æè¿°èˆ‡åƒ¹æ ¼æ–‡å­—..."></textarea>
                        <button @click="analyzePrice" class="btn btn-success w-100" :disabled="!apiKey">
                            {{ isAnalyzing ? 'åˆ†æä¸­...' : 'ä½¿ç”¨ Gemini æå–åƒ¹æ ¼' }}
                        </button>
                        <div v-if="!apiKey" class="text-danger mt-2 small">* è«‹å…ˆåœ¨è¨­å®šé é¢è¼¸å…¥ API Key</div>
                    </div>
                    <div v-else class="text-center text-muted py-5">
                        è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹ç‰©å“ä¾†æ›´æ–°åƒ¹æ ¼
                    </div>

                    <div v-if="analysisResult" class="mt-3 p-2 bg-light border rounded">
                        <strong>Gemini åˆ†æçµæœ:</strong>
                        <p class="mb-1">åƒ¹æ ¼: ${{ analysisResult.price }}</p>
                        <p class="mb-1">ä¾†æº/å‚™è¨»: {{ analysisResult.source }}</p>
                        <button @click="confirmPriceUpdate" class="btn btn-sm btn-primary mt-2">ç¢ºèªä¸¦æ›´æ–°è³‡æ–™åº«</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'utility'">
        <div class="card p-3">
            <h4>æ–°å¢è²»ç”¨ç´€éŒ„</h4>
            <div class="row g-2">
                <div class="col-md-3">
                    <select v-model="newBill.type" class="form-select">
                        <option value="é›»è²»">âš¡ é›»è²»</option>
                        <option value="æ°´è²»">ğŸ’§ æ°´è²»</option>
                        <option value="ç…¤æ°£">ğŸ”¥ ç…¤æ°£</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input v-model="newBill.date" type="date" class="form-control">
                </div>
                <div class="col-md-3">
                    <input v-model.number="newBill.amount" type="number" class="form-control" placeholder="é‡‘é¡ ($)">
                </div>
                <div class="col-md-3">
                    <button @click="addBill" class="btn btn-primary w-100">è¨˜éŒ„</button>
                </div>
            </div>
        </div>

        <div class="card p-3">
            <h4>è²»ç”¨æ­·å²</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>é¡åˆ¥</th>
                        <th>æ—¥æœŸ</th>
                        <th>é‡‘é¡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(bill, index) in sortedBills" :key="index">
                        <td>{{ bill.type }}</td>
                        <td>{{ bill.date }}</td>
                        <td>${{ bill.amount }}</td>
                        <td><button @click="deleteBill(index)" class="btn btn-sm btn-danger">X</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div v-if="currentTab === 'settings'">
        <div class="card p-3 mb-3">
            <h4>ğŸ”‘ Gemini API è¨­å®š</h4>
            <div class="mb-3">
                <label class="form-label">Google Gemini API Key</label>
                <input v-model="apiKey" type="password" class="form-control" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key">
                <div class="form-text">Key åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³è‡³å…¶ä»–ä¼ºæœå™¨ã€‚</div>
            </div>
            <button @click="saveSettings" class="btn btn-success">å„²å­˜è¨­å®š</button>
        </div>

        <div class="card p-3">
            <h4>ğŸ’¾ è³‡æ–™å‚™ä»½ (JSON)</h4>
            <p>æ‚¨å¯ä»¥å°‡è³‡æ–™åŒ¯å‡ºä¸¦å„²å­˜åœ¨ Google Drive æˆ– GitHub ä½œç‚ºå‚™ä»½ã€‚</p>
            <div class="d-flex gap-2">
                <button @click="exportData" class="btn btn-outline-primary">åŒ¯å‡ºè³‡æ–™ (ä¸‹è¼‰)</button>
                <button onclick="document.getElementById('importFile').click()" class="btn btn-outline-secondary">åŒ¯å…¥è³‡æ–™</button>
                <input type="file" id="importFile" style="display:none" @change="importData">
            </div>
        </div>
    </div>

</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            currentTab: 'inventory',
            apiKey: '',
            // åº«å­˜è³‡æ–™çµæ§‹
            inventory: [],
            newItem: { name: '', stock: 1, checkInterval: 7, lastBuyDate: '', lastPriceCheck: '' },
            // å¸³å–®è³‡æ–™çµæ§‹
            bills: [],
            newBill: { type: 'é›»è²»', date: '', amount: '' },
            // Gemini åˆ†æç›¸é—œ
            selectedItem: null,
            pastedText: '',
            isAnalyzing: false,
            analysisResult: null
        };
    },
    computed: {
        // ç¯©é¸å‡ºéœ€è¦æŸ¥åƒ¹çš„ç‰©å“ (è¶…é N å¤©æœªæŸ¥åƒ¹)
        itemsDueForCheck() {
            const today = new Date();
            return this.inventory.filter(item => {
                if (!item.lastPriceCheck) return true;
                const lastCheck = new Date(item.lastPriceCheck);
                const diffTime = Math.abs(today - lastCheck);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                return diffDays >= (item.checkInterval || 7);
            });
        },
        sortedBills() {
            return this.bills.sort((a, b) => new Date(b.date) - new Date(a.date));
        }
    },
    mounted() {
        this.loadData();
    },
    methods: {
        // --- è³‡æ–™å­˜å– (LocalStorage) ---
        saveData() {
            localStorage.setItem('homeInventoryDB', JSON.stringify({
                inventory: this.inventory,
                bills: this.bills,
                apiKey: this.apiKey
            }));
        },
        loadData() {
            const data = localStorage.getItem('homeInventoryDB');
            if (data) {
                const parsed = JSON.parse(data);
                this.inventory = parsed.inventory || [];
                this.bills = parsed.bills || [];
                this.apiKey = parsed.apiKey || '';
            }
        },
        saveSettings() {
            this.saveData();
            alert('è¨­å®šå·²å„²å­˜ï¼');
        },

        // --- åº«å­˜ç®¡ç† ---
        addItem() {
            if (!this.newItem.name) return alert('è«‹è¼¸å…¥åç¨±');
            this.inventory.push({ ...this.newItem });
            this.newItem = { name: '', stock: 1, checkInterval: 7, lastBuyDate: '', lastPriceCheck: '' };
            this.saveData();
        },
        deleteItem(index) {
            if(confirm('ç¢ºå®šåˆªé™¤?')) {
                this.inventory.splice(index, 1);
                this.saveData();
            }
        },

        // --- å¸³å–®ç®¡ç† ---
        addBill() {
            if (!this.newBill.amount) return alert('è«‹è¼¸å…¥é‡‘é¡');
            this.bills.push({ ...this.newBill });
            this.newBill = { type: 'é›»è²»', date: '', amount: '' };
            this.saveData();
        },
        deleteBill(index) {
            this.bills.splice(index, 1);
            this.saveData();
        },

        // --- Gemini AI åˆ†æ ---
        selectItemForAnalysis(item) {
            this.selectedItem = item;
            this.pastedText = '';
            this.analysisResult = null;
        },
        async analyzePrice() {
            if (!this.pastedText) return alert('è«‹å…ˆè²¼ä¸Šç¶²é æ–‡å­—');
            if (!this.apiKey) return alert('ç¼ºå°‘ API Key');

            this.isAnalyzing = true;
            
            const prompt = `
                æˆ‘æœƒæä¾›ä¸€æ®µå¾é¦™æ¸¯ç¶²è³¼å¹³å°(æƒ åº·/ç™¾ä½³)è¤‡è£½çš„ç”¢å“æ–‡å­—ã€‚
                è«‹å¹«æˆ‘åˆ†æä¸¦æå–ä»¥ä¸‹è³‡è¨Šï¼Œä¸¦åš´æ ¼åªå›å‚³ JSON æ ¼å¼ï¼š
                {
                    "price": æ•¸å­— (åªå–ç›®å‰å”®åƒ¹ï¼Œå»é™¤è²¨å¹£ç¬¦è™Ÿ),
                    "source": "ç°¡çŸ­æè¿° (ä¾‹å¦‚: ç™¾ä½³ç‰¹åƒ¹)"
                }
                
                æ–‡å­—å…§å®¹:
                ${this.pastedText}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                
                // æ¸…ç† JSON å­—ä¸² (å»é™¤ markdown block)
                const jsonString = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                this.analysisResult = JSON.parse(jsonString);

            } catch (error) {
                console.error(error);
                alert('åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–è²¼ä¸Šçš„æ–‡å­—å…§å®¹ã€‚');
            } finally {
                this.isAnalyzing = false;
            }
        },
        confirmPriceUpdate() {
            if (this.selectedItem && this.analysisResult) {
                // æ›´æ–°è©²ç‰©å“çš„æœ€å¾ŒæŸ¥åƒ¹ç´€éŒ„
                const index = this.inventory.indexOf(this.selectedItem);
                if (index !== -1) {
                    this.inventory[index].lastPriceCheck = new Date().toISOString().split('T')[0];
                    this.inventory[index].latestPrice = this.analysisResult.price;
                    this.saveData();
                    alert(`æ›´æ–°æˆåŠŸï¼${this.selectedItem.name} æœ€æ–°åƒ¹æ ¼: $${this.analysisResult.price}`);
                    this.selectedItem = null;
                    this.analysisResult = null;
                    this.pastedText = '';
                }
            }
        },

        // --- åŒ¯å‡ºåŒ¯å…¥ ---
        exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                inventory: this.inventory,
                bills: this.bills,
                apiKey: this.apiKey
            }));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "home_inventory_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        },
        importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    this.inventory = parsed.inventory || [];
                    this.bills = parsed.bills || [];
                    this.apiKey = parsed.apiKey || '';
                    this.saveData();
                    alert('åŒ¯å…¥æˆåŠŸï¼');
                } catch(err) {
                    alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                }
            };
            reader.readAsText(file);
        }
    }
});
</script>
</body>
</html>
