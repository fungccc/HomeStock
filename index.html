<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥½ç”·äººæ™ºæ…§å®¶å±… v8.8</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; padding-bottom: 100px; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: none; margin-bottom: 15px; }
        .nav-link.active { background-color: #0d6efd !important; color: white !important; }
        [v-cloak] { display: none; }
        .table-responsive { overflow-x: auto; }
        .table > tbody > tr > td { vertical-align: middle; }
        .category-tag { font-size: 0.7rem; padding: 2px 6px; background: #e9ecef; border-radius: 4px; color: #666; display: inline-block; margin-right: 4px; white-space: nowrap;}
        .brand-tag { font-size: 0.7rem; padding: 2px 6px; background: #e3f2fd; border-radius: 4px; color: #0d6efd; display: inline-block; white-space: nowrap;}
        .item-name { font-weight: 600; font-size: 1rem; line-height: 1.4; word-break: break-word; white-space: normal; }
        .price-tag { font-size: 0.9rem; color: #198754; font-weight: bold; display: inline-flex; align-items: center; }
        .unit-price { font-size: 0.75rem; color: #888; margin-left: 4px; font-weight: normal;}
        .link-icon { color: #0d6efd; margin-left: 6px; font-size: 0.9rem; transition: transform 0.2s; }
        .link-icon:hover { transform: scale(1.2); color: #0a58ca; }
        .floating-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(5px); padding: 10px 10px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; gap: 8px; z-index: 1000; align-items: center; border: 1px solid #dee2e6; width: 95%; max-width: 450px; justify-content: space-around; }
        .floating-btn { border: none; background: none; display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; color: #555; cursor: pointer; width: 55px; }
        .floating-btn i { font-size: 1.3rem; margin-bottom: 2px; }
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; }
        .search-box input { padding-left: 35px; border-radius: 20px; }
        .cart-item { background: #fdfdfe; border-bottom: 1px solid #eee; padding: 8px; font-size: 0.9rem; }
        .cart-summary { background-color: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .settings-btn { text-align: left; height: 100%; display: flex; align-items: center; justify-content: flex-start; padding: 12px; }
        .settings-btn i { font-size: 1.5rem; margin-right: 10px; }
        .settings-btn div { line-height: 1.2; }
        .stat-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; background: #f1f3f5; color: #666; margin-right: 5px; }
        .trend-up { color: #dc3545; }
        .trend-down { color: #198754; }
        .preview-card { border-left: 4px solid #0d6efd; transition: all 0.3s; }
        .preview-card.warning { border-left-color: #ffc107; background-color: #fffbf0; }
        .preview-card.error { border-left-color: #dc3545; background-color: #fff5f5; }
        .ai-action-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .map-btn { color: #dc3545; text-decoration: none; margin-left: 5px; }
        .map-btn:hover { color: #bb2d3b; transform: scale(1.1); display: inline-block; }
        .import-receiver { background-color: #fffdf0; border: 2px solid #ffc107; scroll-margin-top: 80px; }
    </style>
</head>
<body>

<div id="app" class="container py-3" v-cloak>
    <h4 class="mb-3 text-center fw-bold">ğŸ‘¨â€ğŸ’¼ å¥½ç”·äººæ™ºæ…§å®¶å±… v8.8</h4>

    <ul class="nav nav-pills mb-3 justify-content-center nav-justified bg-white p-1 rounded shadow-sm">
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'inventory'}" @click="currentTab = 'inventory'" href="#">ğŸ“¦ ç‰©å“ç®¡ç†</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'expenses'}" @click="currentTab = 'expenses'" href="#">ğŸ’¸ è³¬å–®ç´€éŒ„</a></li>
        <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'settings'}" @click="currentTab = 'settings'" href="#">âš™ï¸ ç³»çµ±è¨­å®š</a></li>
    </ul>

    <div v-if="currentTab === 'inventory'">
        <div v-if="showAiImportPanel" class="card mb-3 import-receiver" ref="inventoryPanel">
            <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-box-arrow-in-down"></i> æ­¥é©Ÿ 2: è«‹åœ¨æ­¤è²¼ä¸Š JSON</span>
                <button @click="showAiImportPanel = false" class="btn-close btn-sm"></button>
            </div>
            <div class="card-body">
                <textarea ref="inventoryPasteRef" v-model="importJsonText" class="form-control mb-2" rows="4" placeholder="é»æ“Šé€£çµå›ä¾†å¾Œï¼Œè«‹ç›´æ¥è²¼ä¸Š AI çµ¦çš„å…§å®¹..."></textarea>
                <div class="d-flex gap-2">
                    <button @click="testInventoryJson" class="btn btn-outline-secondary btn-sm" style="width: 30%">å¡«å…¥æ¸¬è©¦ç¯„æœ¬</button>
                    <button @click="processImportData" class="btn btn-warning fw-bold flex-grow-1">åˆ†æä¸¦åŒ¯å…¥è³‡æ–™åº«</button>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-3 sticky-top" style="z-index: 900; background: rgba(255,255,255,0.95);">
            <div class="d-flex gap-2 mb-2">
                <div class="search-box flex-grow-1"><i class="bi bi-search"></i><input v-model="searchQuery" type="text" class="form-control" placeholder="æœå°‹ç‰©å“..."></div>
                <button @click="openAiInventoryModal" class="btn ai-action-btn text-white rounded-circle shadow" style="width: 40px; height: 40px; padding: 0;"><i class="bi bi-robot"></i></button>
            </div>
            <div class="d-flex justify-content-between align-items-center"><span class="small text-muted">{{ filteredInventory.length }} é …ç‰©å“</span><button v-if="selectedItems.length > 0" @click="selectAll(false)" class="btn btn-sm btn-link text-danger text-decoration-none">å–æ¶ˆå…¨é¸</button></div>
        </div>

        <div class="card p-0 overflow-hidden"><div class="table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th class="ps-3">ç‰©å“è³‡è¨Š</th><th class="text-center" style="min-width: 90px;">åº«å­˜</th><th class="text-center" style="width: 40px;">é¸</th></tr></thead><tbody><tr v-for="item in filteredInventory" :key="item.id" :class="{'table-active': isSelected(item)}"><td class="ps-3 py-3" @click="toggleSelection(item)"><div class="mb-1"><span class="category-tag">{{ getCategoryName(item.categoryId) }}</span><span v-if="item.brand" class="brand-tag">{{ item.brand }}</span></div><div class="item-name">{{ item.name }}</div><div class="mt-1"><span class="price-tag">{{ item.latestPrice ? '$'+item.latestPrice : '-' }} <span class="unit-price" v-if="item.unitPrice">({{ item.unitPrice }})</span><a v-if="item.url" :href="item.url" target="_blank" class="link-icon" @click.stop><i class="bi bi-box-arrow-up-right"></i></a></span></div></td><td class="text-center align-middle"><div class="btn-group btn-group-sm"><button @click.stop="updateStock(item, -1)" class="btn btn-outline-secondary px-2">-</button><button class="btn btn-light disabled text-dark fw-bold border-top border-bottom px-0" style="width:30px">{{ item.stock }}</button><button @click.stop="updateStock(item, 1)" class="btn btn-outline-success px-2">+</button></div></td><td class="text-center align-middle" @click="toggleSelection(item)"><input type="checkbox" class="form-check-input" :checked="isSelected(item)"></td></tr></tbody></table></div></div>
        <div v-if="selectedItems.length === 0" style="position: fixed; bottom: 25px; right: 25px; z-index: 999;"><button @click="openAddModal" class="btn btn-primary rounded-circle shadow p-0" style="width: 56px; height: 56px; font-size: 24px;"><i class="bi bi-plus-lg"></i></button></div>
        <div v-if="selectedItems.length > 0" class="floating-bar"><button @click="actionEdit" class="floating-btn" :class="{disabled: selectedItems.length > 1}"><i class="bi bi-pencil-square"></i> ç·¨è¼¯</button><button @click="prepareExport('whatsapp')" class="floating-btn text-success"><i class="bi bi-whatsapp"></i> WA</button><button @click="prepareExport('share')" class="floating-btn text-primary"><i class="bi bi-share-fill"></i> åˆ†äº«</button><button @click="prepareExport('copy')" class="floating-btn"><i class="bi bi-clipboard"></i> è¤‡è£½</button><button @click="actionDelete" class="floating-btn text-danger"><i class="bi bi-trash"></i> åˆªé™¤</button></div>
    </div>

    <div v-if="currentTab === 'expenses'">
        <div v-if="showAiReceiptPanel" class="card mb-3 import-receiver" ref="receiptPanel">
            <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-receipt"></i> æ­¥é©Ÿ 2: è²¼ä¸Šå–®æ“š JSON</span>
                <button @click="showAiReceiptPanel = false" class="btn-close btn-sm"></button>
            </div>
            <div class="card-body">
                <textarea ref="receiptPasteRef" v-model="receiptJsonText" class="form-control mb-2" rows="5" placeholder="è«‹é•·æŒ‰æ­¤è™•è²¼ä¸Š..."></textarea>
                <div class="d-flex gap-2">
                    <button @click="testReceiptJson" class="btn btn-outline-secondary btn-sm" style="width: 30%">å¡«å…¥æ¸¬è©¦ç¯„æœ¬</button>
                    <button @click="processReceiptJson" class="btn btn-warning fw-bold flex-grow-1">è§£æä¸¦å¡«å…¥è¡¨å–®</button>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-3 border-primary" ref="expenseFormCard">
            <h5 class="text-primary fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-cart-plus"></i> {{ isEditingExpense ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢æ”¯å‡º' }}</span>
                <div>
                    <button v-if="!isEditingExpense" @click="openAiReceiptModal" class="btn btn-sm ai-action-btn rounded-pill px-3 me-1"><i class="bi bi-camera"></i> AI æƒå–®</button>
                    <button v-if="isEditingExpense" @click="cancelEditExpense" class="btn btn-sm btn-outline-secondary">å–æ¶ˆ</button>
                </div>
            </h5>
            <div class="row g-2">
                <div class="col-6"><label class="small text-muted">æ—¥æœŸ</label><input v-model="newExpense.date" type="date" class="form-control"></div>
                <div class="col-6"><label class="small text-muted">é¡åˆ¥</label><select v-model="newExpense.category" class="form-select" @change="onCategoryChange"><option v-for="(brands, cat) in companyDB" :value="cat">{{ cat }}</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
                
                <div class="col-12">
                    <label class="small text-muted">åº—é‹ª / å…¬å¸</label>
                    <div class="input-group">
                        <select v-model="selectedStore" class="form-select" @change="onStoreSelectChange">
                            <option v-for="store in currentCompanyOptions" :value="store.name">{{ store.name }}</option>
                            <option value="other">ï¼‹ æ–°å¢ / æ‰‹å‹•è¼¸å…¥...</option>
                        </select>
                        <input v-if="selectedStore === 'other'" v-model="customStoreInput" type="text" class="form-control" placeholder="è¼¸å…¥åç¨±">
                    </div>
                </div>

                <div class="col-12">
                    <div class="row g-2">
                        <div class="col-8">
                            <input v-model="newExpense.address" class="form-control form-control-sm text-muted" placeholder="ğŸ“ åœ°å€ (AIè‡ªå‹•å¡«å¯«)" @input="autoGenerateMapUrl">
                        </div>
                        <div class="col-4">
                            <input v-model="newExpense.mapUrl" class="form-control form-control-sm text-primary" placeholder="ğŸ—ºï¸ Link (è‡ªå‹•)">
                        </div>
                    </div>
                </div>
                
                <div class="col-12 mt-2">
                    <div class="bg-light p-2 rounded border">
                        <div class="d-flex justify-content-between align-items-center mb-2"><label class="small fw-bold mb-0"><i class="bi bi-bag"></i> æ˜ç´°</label><button v-if="isShoppingCategory" @click="addCartItemManual" class="btn btn-xs btn-outline-secondary">+ æ‰‹å‹•åŠ å…¥</button></div>
                        <div v-if="isShoppingCategory" class="input-group mb-2"><select v-model="selectedInventoryItem" class="form-select form-select-sm"><option :value="null">-- å¾åº«å­˜é¸æ“‡ --</option><option v-for="item in inventory" :value="item">{{ item.name }} (${{item.latestPrice}})</option></select><input v-model.number="tempQty" type="number" class="form-control form-select-sm" placeholder="é‡" style="max-width: 60px;" min="1"><button @click="addCartItem" class="btn btn-sm btn-primary" :disabled="!selectedInventoryItem">åŠ å…¥</button></div>
                        <div v-if="newExpense.items && newExpense.items.length > 0"><div v-for="(cartItem, idx) in newExpense.items" :key="idx" class="cart-item d-flex justify-content-between align-items-center"><div style="flex-grow: 1;"><div>{{ cartItem.name }}</div><div class="small text-muted">{{ cartItem.brand }} | ${{ cartItem.price }} x {{ cartItem.qty }}</div></div><div class="text-end" style="min-width: 60px;"><span class="fw-bold">${{ (cartItem.price * cartItem.qty).toFixed(1) }}</span><i @click="removeCartItem(idx)" class="bi bi-x text-danger ms-2" style="cursor:pointer"></i></div></div></div>
                        <div v-if="(!newExpense.items || newExpense.items.length===0) && isShoppingCategory" class="text-center text-muted small py-2">æš«ç„¡æ˜ç´°</div>
                    </div>
                </div>
                
                <div v-if="!isShoppingCategory" class="col-12 mt-2"><label class="small text-muted fw-bold">å¸³å–®åŸé¡</label><input v-model.number="newExpense.subtotal" type="number" class="form-control" placeholder="è¼¸å…¥é‡‘é¡"></div>
                <div class="col-12 mt-2"><div class="cart-summary border p-2 rounded bg-white"><div class="row g-2 align-items-center"><div class="col-5"><label class="small text-muted">æŠ˜æ‰£å„ªæƒ </label><div class="input-group input-group-sm"><span class="input-group-text">-$</span><input v-model.number="newExpense.discount" type="number" class="form-control" placeholder="0"></div></div><div class="col-7 text-end"><label class="small text-muted d-block">å¯¦ä»˜é‡‘é¡ (Final)</label><input v-model.number="newExpense.amount" type="number" class="form-control fw-bold text-danger text-end fs-5" readonly></div></div></div></div>
                <div class="col-12"><label class="small text-muted">å‚™è¨»/å–®è™Ÿ</label><input v-model="newExpense.refNumber" class="form-control" placeholder="é¸å¡«"></div>
                <div class="col-12 mt-3"><button @click="saveExpense" class="btn w-100" :class="isEditingExpense ? 'btn-warning' : 'btn-primary'">{{ isEditingExpense ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„' }}</button></div>
            </div>
        </div>
        
        <div class="card p-3"><div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0">ç´€éŒ„åˆ—è¡¨</h5><button @click="showMonthlySummary" class="btn btn-sm btn-outline-primary"><i class="bi bi-calendar-check"></i> æŸ¥çœ‹æ¯æœˆçµ±è¨ˆ</button></div><div class="table-responsive"><table class="table table-striped table-sm text-nowrap align-middle"><thead><tr><th>æ—¥æœŸ</th><th>é¡åˆ¥/å…¬å¸</th><th>é‡‘é¡</th><th>æ“ä½œ</th></tr></thead><tbody><tr v-for="(exp, index) in sortedExpenses" :key="index"><td><div>{{ exp.date }}</div></td><td><span class="badge bg-light text-dark border">{{ exp.category }}</span><div class="fw-bold text-primary small mt-1">{{ exp.note }} <a v-if="exp.mapUrl" :href="exp.mapUrl" target="_blank" class="map-btn"><i class="bi bi-geo-alt-fill"></i></a></div></td><td class="fw-bold">${{ exp.amount }}</td><td><button v-if="exp.items && exp.items.length > 0" @click="viewOrderDetails(exp)" class="btn btn-xs btn-outline-info me-1"><i class="bi bi-file-text"></i></button><button @click="editExpenseDirectly(exp)" class="btn btn-xs btn-outline-secondary me-1"><i class="bi bi-pencil"></i></button><i @click="deleteExpense(index)" class="bi bi-x-circle text-danger" style="cursor:pointer"></i></td></tr></tbody></table></div></div>
    </div>

    <div v-if="currentTab === 'settings'">
        <div class="card p-3 mb-3"><h5>ğŸ”‘ Gemini API Key</h5><input v-model="apiKey" type="password" class="form-control mb-2" placeholder="API Key"><button @click="saveSettings" class="btn btn-success w-100">å„²å­˜</button></div>
        <div class="card p-3"><h5>ğŸ’¾ è³‡æ–™åº«ç®¡ç†</h5><div class="row g-2 mb-3"><div class="col-12"><button @click="prepareFileExport('json')" class="btn btn-outline-primary w-100 settings-btn"><i class="bi bi-cloud-download"></i> <div><b>å®Œæ•´å‚™ä»½ (JSON)</b><br><span class="small">åŒ…å«æ‰€æœ‰è³‡æ–™èˆ‡è¨­å®š</span></div></button></div><div class="col-12"><hr class="my-1"></div><div class="col-6"><button @click="prepareFileExport('inventory_csv')" class="btn btn-outline-success w-100 settings-btn"><i class="bi bi-file-earmark-spreadsheet"></i> <div><b>åŒ¯å‡ºåº«å­˜CSV</b></div></button></div><div class="col-6"><button @click="prepareFileExport('expense_csv')" class="btn btn-outline-info w-100 settings-btn"><i class="bi bi-file-earmark-text"></i> <div><b>åŒ¯å‡ºç´€éŒ„åˆ—è¡¨</b></div></button></div></div><label class="form-label fw-bold">ğŸ“¥ è³‡æ–™é‚„åŸ/åŒ¯å…¥</label><input type="file" ref="fileInput" @change="handleFileImport" style="display:none" accept=".json,.csv"><div class="d-grid gap-2"><button @click="triggerImport('json')" class="btn btn-light border text-start"><i class="bi bi-arrow-counterclockwise"></i> é‚„åŸå®Œæ•´å‚™ä»½ (.json)</button><button @click="triggerImport('inventory_csv')" class="btn btn-light border text-start"><i class="bi bi-box-seam"></i> åŒ¯å…¥åº«å­˜ CSV</button><button @click="triggerImport('expense_csv')" class="btn btn-light border text-start"><i class="bi bi-card-list"></i> åŒ¯å…¥ç´€éŒ„åˆ—è¡¨ CSV</button></div></div>
    </div>

    <div v-if="showAiInventoryModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-gradient bg-primary text-white"><h5 class="modal-title">ğŸ¤– æ™ºèƒ½ç‰©å“å…¥åº«</h5><button @click="showAiInventoryModal = false" class="btn-close btn-close-white"></button></div>
                <div class="modal-body">
                    <div class="btn-group w-100 mb-3" role="group"><button @click="selectedAI = 'gemini'" type="button" class="btn btn-sm" :class="selectedAI === 'gemini' ? 'btn-primary' : 'btn-outline-primary'">Gemini</button><button @click="selectedAI = 'grok'" type="button" class="btn btn-sm" :class="selectedAI === 'grok' ? 'btn-dark' : 'btn-outline-dark'">Grok</button><button @click="selectedAI = 'chatgpt'" type="button" class="btn btn-sm" :class="selectedAI === 'chatgpt' ? 'btn-success' : 'btn-outline-success'">ChatGPT</button></div>
                    <p class="small text-muted">è²¼ä¸Šå•†å“æ–‡å­—æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•å»æ‹ç…§ï¼š</p>
                    <textarea v-model="pastedText" class="form-control mb-2" rows="2" placeholder="ä¾‹: æƒ åº· ç¶­ä»–å¥¶ $20..."></textarea>
                    <div class="d-grid gap-2"><button @click="copyAndOpenAI('text')" class="btn btn-outline-secondary">ğŸ“ æ–‡å­—æŒ‡ä»¤</button><button @click="copyAndOpenAI('image')" class="btn btn-primary">ğŸ“¸ è®€åœ–æŒ‡ä»¤</button></div>
                    <div v-if="stagedItems.length > 0" class="mt-3 border-top pt-3"><h6 class="fw-bold">é è¦½çµæœ ({{ stagedItems.length }})</h6><div v-for="(item, idx) in stagedItems" :key="idx" class="card mb-2 preview-card bg-light"><div class="card-body p-2"><input v-model="item.name" class="form-control form-control-sm mb-1 fw-bold"><div class="row g-1"><div class="col-4"><input v-model.number="item.latestPrice" type="number" class="form-control form-control-sm"></div><div class="col-4"><input v-model="item.brand" class="form-control form-control-sm" placeholder="å“ç‰Œ"></div><div class="col-4"><input v-model="item.unitPrice" class="form-control form-control-sm" placeholder="å–®ä½"></div></div></div></div><button @click="confirmStagedImport" class="btn btn-success w-100">ç¢ºèªå…¥åº«</button></div>
                </div>
            </div>
        </div>
    </div>
    
    <div v-if="showAiReceiptModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-gradient bg-success text-white"><h5 class="modal-title">ğŸ§¾ AI å–®æ“šæƒæ</h5><button @click="showAiReceiptModal = false" class="btn-close btn-close-white"></button></div>
                <div class="modal-body">
                    <div class="btn-group w-100 mb-3"><button @click="selectedAI = 'gemini'" class="btn btn-sm" :class="selectedAI==='gemini'?'btn-primary':'btn-outline-primary'">Gemini</button><button @click="selectedAI = 'grok'" class="btn btn-sm" :class="selectedAI==='grok'?'btn-dark':'btn-outline-dark'">Grok</button><button @click="selectedAI = 'chatgpt'" class="btn btn-sm" :class="selectedAI==='chatgpt'?'btn-success':'btn-outline-success'">ChatGPT</button></div>
                    <button @click="copyReceiptPrompt" class="btn btn-success w-100 py-2 fw-bold"><i class="bi bi-camera-fill"></i> è¤‡è£½æŒ‡ä»¤ä¸¦æƒæå–®æ“š</button>
                    <div class="small text-muted mt-2 text-center">è·³è½‰å¾Œè«‹ä¸Šå‚³å–®æ“šç…§ç‰‡ï¼Œè¤‡è£½ JSON å¾ŒæŒ‰è¿”å›é€£çµã€‚</div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showMonthlyModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="bi bi-calendar3"></i> æ¯æœˆæ”¯å‡ºçµ±è¨ˆ</h5><button @click="showMonthlyModal = false" class="btn-close btn-close-white"></button></div><div class="modal-body p-0"><table class="table table-striped mb-0 text-center"><thead class="table-light"><tr><th>æœˆä»½</th><th>ç¸½æ”¯å‡º</th></tr></thead><tbody><tr v-for="stat in monthlyStats" :key="stat.month"><td>{{ stat.month }}</td><td class="fw-bold text-danger">${{ stat.total.toLocaleString() }}</td></tr><tr v-if="monthlyStats.length === 0"><td colspan="2" class="py-3">æš«ç„¡è³‡æ–™</td></tr></tbody></table></div></div></div></div>
    <div v-if="showLostDataWarning" class="modal d-block" style="background: rgba(0,0,0,0.8); z-index: 2000;"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-danger"><div class="modal-header bg-danger text-white"><h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> è­¦å‘Šï¼šè³‡æ–™åº«ç©ºç™½ï¼</h5></div><div class="modal-body"><p class="fw-bold">æ‚¨ç¾åœ¨å¯èƒ½æ˜¯åœ¨ App çš„å…§éƒ¨ç€è¦½å™¨ä¸­ã€‚</p><p>è«‹é»æ“Šç€è¦½å™¨åœ–ç¤º ğŸ§­ï¼Œé¸æ“‡ <b>ã€Œåœ¨ Safari/Chrome é–‹å•Ÿã€</b>ã€‚</p></div><div class="modal-footer"><button @click="showLostDataWarning = false" class="btn btn-secondary">é—œé–‰</button></div></div></div></div>
    <div v-if="showFileExportModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ğŸ“¤ æª”æ¡ˆè¼¸å‡º</h5><button @click="showFileExportModal = false" class="btn-close"></button></div><div class="modal-body d-grid gap-3"><button @click="executeExport('share')" class="btn btn-lg btn-success text-start"><i class="bi bi-whatsapp me-2"></i> <b>ç³»çµ±åˆ†äº«</b></button><button @click="executeExport('download')" class="btn btn-lg btn-outline-secondary text-start"><i class="bi bi-download me-2"></i> <b>ä¸‹è¼‰æª”æ¡ˆ</b></button></div></div></div></div>
    <div v-if="showExportModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">å‚³é€å…§å®¹</h5><button @click="showExportModal = false" class="btn-close"></button></div><div class="modal-body d-grid gap-2"><button @click="confirmExport('buy')" class="btn btn-outline-primary text-start fw-bold">ğŸ›’ éœ€è³¼è²·æ¸…å–®</button><button @click="confirmExport('inventory')" class="btn btn-outline-success text-start fw-bold">ğŸ“¦ åº«å­˜æ¸…å–®</button><button @click="confirmExport('links')" class="btn btn-outline-info text-start fw-bold">ğŸ”— ç‰©å“é€£çµ</button></div></div></div></div>
    <div v-if="showOrderDetailModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-light"><h5 class="modal-title">ğŸ“œ è¨‚å–®æ˜ç´°</h5><button @click="showOrderDetailModal = false" class="btn-close"></button></div><div class="modal-body p-0"><div class="p-3 border-bottom"><div class="fw-bold">{{ viewingOrder.date }} ({{ viewingOrder.category }})</div><div class="mt-1 text-primary fw-bold">{{ viewingOrder.note }}</div><div v-if="viewingOrder.address" class="small text-muted mt-1"><i class="bi bi-geo-alt"></i> {{ viewingOrder.address }}</div></div><table class="table table-sm mb-0"><thead class="table-light"><tr><th>ç‰©å“</th><th>å–®åƒ¹ x æ•¸é‡</th><th>å°è¨ˆ</th></tr></thead><tbody><tr v-for="(itm, idx) in viewingOrder.items" :key="idx"><td>{{ itm.name }}</td><td>${{ itm.price }} x {{ itm.qty }}</td><td class="text-end pe-3">${{ (itm.price * itm.qty).toFixed(1) }}</td></tr></tbody><tfoot class="table-group-divider"><tr><td colspan="2" class="text-end fw-bold">ç¸½è¨ˆ:</td><td class="text-end pe-3 fw-bold text-danger">${{ viewingOrder.amount }}</td></tr></tfoot></table><div class="p-3"><button @click="editOrderFromModal" class="btn btn-outline-primary w-100">ç·¨è¼¯æ­¤å–®</button></div></div></div></div></div>
    <div v-if="showAddModal || showEditModal" class="modal d-block" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">{{ showEditModal ? 'ç·¨è¼¯' : 'æ–°å¢' }}</h5><button @click="closeModal" class="btn-close"></button></div><div class="modal-body"><div class="row g-2 mb-2"><div class="col-6"><label class="small">åˆ†é¡</label><select v-model="editingForm.categoryId" class="form-select"><option v-for="cat in categories" :value="cat.id">{{ cat.name }}</option></select></div><div class="col-6"><label class="small">å“ç‰Œ</label><input v-model="editingForm.brand" class="form-control"></div></div><div class="mb-2"><label class="small">åç¨±</label><textarea v-model="editingForm.name" class="form-control" rows="2"></textarea></div><div class="row g-2 mb-2"><div class="col-4"><label class="small">åº«å­˜</label><input v-model.number="editingForm.stock" type="number" class="form-control"></div><div class="col-4"><label class="small">ç¸½åƒ¹</label><input v-model.number="editingForm.latestPrice" type="number" class="form-control"></div><div class="col-4"><label class="small">å–®åƒ¹</label><input v-model.number="editingForm.unitPrice" class="form-control"></div></div><div class="mb-2"><label class="small">ç¶²å€</label><input v-model="editingForm.url" class="form-control"></div></div><div class="modal-footer"><button @click="closeModal" class="btn btn-secondary">å–æ¶ˆ</button><button @click="saveItem" class="btn btn-primary">å„²å­˜</button></div></div></div></div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            currentTab: 'inventory', geminiMode: 'app', apiKey: '', searchQuery: '',
            selectedAI: 'gemini', inventory: [], expenses: [], selectedIds: [], inputMode: 'text',
            
            showAddModal: false, showEditModal: false, showExportModal: false, showOrderDetailModal: false, showLostDataWarning: false, showMonthlyModal: false, showFileExportModal: false, showAiInventoryModal: false, showAiReceiptModal: false,
            // v7.1/v7.2 Landing Zones
            showAiImportPanel: false, showAiReceiptPanel: false,
            
            exportActionType: '', editingForm: {}, viewingOrder: {}, monthlyStats: [],
            importJsonText: '', receiptJsonText: '', pastedText: '', isAnalyzing: false, selectedItemForAnalysis: null, 
            isWaitingForPaste: false, isWaitingForReceiptPaste: false, 
            currentImportType: '', currentExportType: '', stagedItems: [],

            newExpense: { date: new Date().toISOString().split('T')[0], category: 'è¶…ç´šå¸‚å ´', amount: 0, subtotal: 0, note: '', refNumber: '', items: [], discount: 0, address: '', mapUrl: '' },
            selectedInventoryItem: null, tempQty: 1, selectedStore: '', customStoreInput: '',
            isEditingExpense: false, editingExpenseIndex: -1,

            // v8.0: companyDB now stores objects: { name, address, mapUrl }
            companyDB: { 
                "æ°´è²»": [], "é›»è²»": [], "ç…¤æ°£/çŸ³æ²¹æ°£": [], "ç§å®¶è»Šå…¥æ²¹": [], "å¯¬é »": [], "é›»è©±è²»": [], "é›²ç«¯åŠAI": [], "ä¸²æµå½±ç‰‡": [], "éŸ³æ¨‚ä¸²æµ": [], "å¥èº«æœƒç±": [], "é†«ç™‚ä¿éšª": [], "æŒ‰æ­ä¾›æ¬¾": [], "ç®¡ç†è²»": [], "è¶…ç´šå¸‚å ´": [], "é£²é£Ÿ": [], "äº¤é€š(å…«é”é€š)": [], "è»Šè³‡": [], "ç¶²è³¼": [] 
            },
            
            // Default Initial Data (will be converted on load if string)
            defaultCompanies: {
                "æ°´è²»": ["æ°´å‹™ç½²"], "é›»è²»": ["ä¸­é›»", "æ¸¯ç‡ˆ"], "ç…¤æ°£/çŸ³æ²¹æ°£": ["Towngas", "å”å’Œ", "ä¸­çŸ³åŒ–", "æ¨™æº–", "ç¾å­š", "èœ†æ®¼", "æ–°æµ·", "åŠå³¶", "åŠ å¾·å£«"], "ç§å®¶è»Šå…¥æ²¹": ["Shell", "Esso", "åŠ å¾·å£«", "ä¸­çŸ³åŒ–", "ä¸­æ²¹", "ECO"], "å¯¬é »": ["Netvigator", "HKBN", "HGC", "i-CABLE", "CMHK"], "é›»è©±è²»": ["csl", "1O1O", "SmarTone", "CMHK", "3HK", "HKT", "HKBN"], "é›²ç«¯åŠAI": ["AWS", "Azure", "GCP", "é˜¿é‡Œé›²", "ChatGPT", "Gemini", "Grok", "Perplexity", "Copilot", "MJ"], "ä¸²æµå½±ç‰‡": ["Netflix", "Disney+", "Max", "AppleTV+", "Viu", "hmvod", "NowE"], "éŸ³æ¨‚ä¸²æµ": ["Spotify", "AppleMusic", "KKBOX"], "å¥èº«æœƒç±": ["PURE", "Anytime", "24/7Fitness"], "é†«ç™‚ä¿éšª": ["AXA", "Bupa", "Bowtie", "BlueCross", "FWD", "Manulife", "Pru"], "æŒ‰æ­ä¾›æ¬¾": ["HSBC", "æ’ç”Ÿ", "ä¸­éŠ€", "æ¸£æ‰“"], "ç®¡ç†è²»": ["å±‹è‹‘ç®¡ç†è™•", "ç‰©ç®¡å…¬å¸"], "è¶…ç´šå¸‚å ´": ["æƒ åº·", "ç™¾ä½³", "AEON", "MarketPlace", "FUSION", "TASTE", "cityâ€™super", "HKTVmall"], "é£²é£Ÿ": ["éº¥ç•¶å‹", "å¤§å®¶æ¨‚", "å¤§å¿«æ´»", "ç¿ è¯", "Starbucks", "PacificCoffee"], "äº¤é€š(å…«é”é€š)": ["å…«é”é€š", "MTR", "KMB", "CTB", "LWB"], "è»Šè³‡": ["çš„å£«", "Uber"], "ç¶²è³¼": ["HKTVmall", "Taobao", "Tmall", "JD", "Amazon"]
            },

            categories: [ { id: '10', name: 'é£Ÿå“/ä¹¾ç³§' }, { id: '20', name: 'é£²å“' }, { id: '30', name: 'å®¶å±…æ¸…æ½”' }, { id: '40', name: 'å€‹äººè­·ç†' }, { id: '50', name: 'ç´™å“/è¡›ç”Ÿ' }, { id: '60', name: 'å»šæˆ¿ç”¨å“' }, { id: '70', name: 'è—¥å“/ä¿å¥' }, { id: '99', name: 'å…¶ä»–' } ]
        };
    },
    computed: {
        filteredInventory() { const query = this.searchQuery.toLowerCase().trim(); if (!query) return this.inventory; return this.inventory.filter(item => { const matchName = item.name.toLowerCase().includes(query); const matchBrand = item.brand && item.brand.toLowerCase().includes(query); return matchName || matchBrand; }); },
        selectedItems() { return this.inventory.filter(item => this.selectedIds.includes(item.id)); },
        sortedExpenses() { return this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)); },
        currentCompanyOptions() { return this.companyDB[this.newExpense.category] || []; },
        isShoppingCategory() { return ['è¶…ç´šå¸‚å ´', 'ç¶²è³¼', 'é£²é£Ÿ'].includes(this.newExpense.category); }
    },
    watch: { 'newExpense.items': { handler() { this.updateCalculatedAmount(); }, deep: true }, 'newExpense.discount': function() { this.updateCalculatedAmount(); }, 'newExpense.subtotal': function() { this.updateCalculatedAmount(); } },
    mounted() { 
        this.loadData(); 
        
        // Ensure default structure if empty
        if (Object.keys(this.companyDB).length === 0 || this.companyDB["è¶…ç´šå¸‚å ´"].length === 0) {
             // Init defaults
             for(let k in this.defaultCompanies) {
                 this.companyDB[k] = this.defaultCompanies[k].map(n => ({ name: n, address: '', mapUrl: '' }));
             }
        }

        const params = new URLSearchParams(window.location.search);
        const hash = window.location.hash;
        
        if (hash.includes('import_inventory')) {
            this.currentTab = 'inventory'; this.showAiImportPanel = true; this.clearHash();
            setTimeout(() => { if (this.$refs.inventoryPasteRef) { this.$refs.inventoryPasteRef.focus(); this.$refs.inventoryPasteRef.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }, 500);
        } else if (hash.includes('import_expenses')) {
            this.currentTab = 'expenses'; this.showAiReceiptPanel = true; this.clearHash();
            setTimeout(() => { if (this.$refs.receiptPasteRef) { this.$refs.receiptPasteRef.focus(); this.$refs.receiptPasteRef.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }, 500);
        }
    },
    methods: {
        saveData() { localStorage.setItem('goodHusbandDB_v7', JSON.stringify({ inventory: this.inventory, expenses: this.expenses, apiKey: this.apiKey, companyDB: this.companyDB })); },
        loadData() { 
            let data = localStorage.getItem('goodHusbandDB_v7') || localStorage.getItem('goodHusbandDB_v5_3'); 
            if (data) { 
                let p = JSON.parse(data); 
                this.inventory = p.inventory || []; 
                this.expenses = p.expenses || []; 
                this.apiKey = p.apiKey || ''; 
                
                // v8.0 Migration: Convert String[] to Object[]
                if(p.companyDB) {
                    this.companyDB = p.companyDB;
                    for(let key in this.companyDB) {
                        this.companyDB[key] = this.companyDB[key].map(item => {
                            return (typeof item === 'string') ? { name: item, address: '', mapUrl: '' } : item;
                        });
                    }
                }
            } 
        },
        saveSettings() { this.saveData(); alert('è¨­å®šå·²å„²å­˜ï¼'); }, getCategoryName(id) { const c = this.categories.find(x => x.id == id); return c ? c.name : 'æœªåˆ†é¡'; },
        isSelected(item) { return this.selectedIds.includes(item.id); }, toggleSelection(item) { const id = item.id; if(this.selectedIds.includes(id)) this.selectedIds=this.selectedIds.filter(i=>i!==id); else this.selectedIds.push(id); }, selectAll(doSelect) { this.selectedIds = doSelect ? this.filteredInventory.map(i => i.id) : []; },
        prepareExport(type) { this.exportActionType = type; this.showExportModal = true; }, confirmExport(format) { this.showExportModal = false; let text = ""; if (format === 'buy') text = "ğŸ›’ *éœ€è³¼è²·æ¸…å–®*ï¼š\n" + this.selectedItems.map(i => `- ${i.name} (åº«å­˜:${i.stock})`).join('\n'); else if (format === 'inventory') text = "ğŸ“¦ *åº«å­˜æ¸…å–®*ï¼š\n" + this.selectedItems.map(i => `- ${i.name} [${i.brand||''}] | $${i.latestPrice||'-'}`).join('\n'); else if (format === 'links') text = "ğŸ”— *ç‰©å“é€£çµ*ï¼š\n" + this.selectedItems.map(i => `- ${i.name}\n  ${i.url || 'ç„¡é€£çµ'}`).join('\n'); if (this.exportActionType === 'whatsapp') window.location.href = `whatsapp://send?text=${encodeURIComponent(text)}`; else if (this.exportActionType === 'share') { if (navigator.share) navigator.share({title:'åº«å­˜', text:text}); else alert("ä¸æ”¯æ´åˆ†äº«"); } else if (this.exportActionType === 'copy') navigator.clipboard.writeText(text).then(()=>alert('å·²è¤‡è£½')); },
        
        clearHash() { history.replaceState(null, null, ' '); },
        forceOpenInventoryImport() { this.showAiImportPanel = true; setTimeout(() => { if (this.$refs.inventoryPasteRef) this.$refs.inventoryPasteRef.focus(); }, 100); },
        forceOpenExpenseImport() { this.showAiReceiptPanel = true; setTimeout(() => { if (this.$refs.receiptPasteRef) this.$refs.receiptPasteRef.focus(); }, 100); },

        openTargetAI(url) { window.open(url, "_blank"); },
        getAiUrl() { if (this.selectedAI === 'grok') return 'https://x.com/i/grok'; if (this.selectedAI === 'chatgpt') return 'https://chatgpt.com/'; return 'https://gemini.google.com/app'; },

        // --- Inventory AI ---
        openAiInventoryModal() { this.showAiInventoryModal = true; },
        copyAndOpenAI(mode) {
            const returnUrl = window.location.href.split('#')[0] + "#import_inventory";
            let contentText = mode === 'image' ? "(è«‹ç­‰å¾…æˆ‘ä¸Šå‚³åœ–ç‰‡)" : (this.pastedText || "ï¼ˆç„¡å…§å®¹ï¼‰");
            let actionInstruction = mode === 'image' ? "è«‹åˆ†ææˆ‘ä¸Šå‚³çš„åœ–ç‰‡ã€‚" : "è«‹å°‡æˆ‘æä¾›çš„å•†å“å…§å®¹è½‰æ›ç‚º JSON æ ¼å¼ã€‚";
            let extra = this.selectedAI === 'grok' ? `\n(âš ï¸ æ³¨æ„ï¼šGrok App è«‹æ‰‹å‹•åˆ‡æ›å›ç€è¦½å™¨è²¼ä¸Š)\n` : '';
            const prompt = `ä½ ç¾åœ¨æ˜¯æˆ‘çš„ã€Œå®¶å±…åº«å­˜è³‡æ–™æ•´ç†å“¡ã€ã€‚${actionInstruction}\n\n1. è¼¸å‡ºæ ¼å¼ï¼šåš´æ ¼åªè¼¸å‡º JSON Array (ä»£ç¢¼å¡Š) [...]ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚\n2. æ¬„ä½ï¼šname, brand, categoryId, latestPrice (æ•¸å­—), unitPrice (å¦‚ 2/åŒ…), url\n3. åˆ†é¡IDè¡¨ï¼š10:é£Ÿå“, 20:é£²å“, 30:æ¸…æ½”, 40:è­·ç†, 50:è¡›ç”Ÿ, 60:å»šæˆ¿, 70:è—¥å“, 99:å…¶ä»–\n${extra}éå¸¸é‡è¦ï¼šè«‹åœ¨ JSON è¼¸å‡ºçµæŸå¾Œï¼Œæ–°èµ·ä¸€è¡Œï¼Œé™„ä¸Šé€™å€‹è¿”å›é€£çµï¼š\n[â†©ï¸ é»æ“Šé€™è£¡è¿”å›ç³»çµ±åŒ¯å…¥](${returnUrl})\n\næˆ‘çš„è¼¸å…¥å…§å®¹ï¼š\n${contentText}`;
            navigator.clipboard.writeText(prompt).then(() => { this.openTargetAI(this.getAiUrl()); });
        },
        processImportData() {
            try {
                let cleanText = this.importJsonText.replace(/[\u201C\u201D]/g, '"').replace(/```json/g, '').replace(/```/g, '');
                const linkIndex = cleanText.indexOf('[â†©ï¸'); if (linkIndex !== -1) cleanText = cleanText.substring(0, linkIndex);
                const firstBracket = cleanText.indexOf('['); const lastBracket = cleanText.lastIndexOf(']');
                if (firstBracket !== -1 && lastBracket !== -1) cleanText = cleanText.substring(firstBracket, lastBracket + 1);
                const list = JSON.parse(cleanText);
                this.stagedItems = list.map(item => {
                    const existingItem = this.inventory.find(inv => inv.name === item.name);
                    return { ...item, id: existingItem ? existingItem.id : Date.now() + Math.random().toString(36).substr(2, 5), stock: existingItem ? existingItem.stock : 0 };
                });
                this.confirmStagedImport();
            } catch (e) { alert('JSON éŒ¯èª¤'); }
        },
        confirmStagedImport() {
            this.stagedItems.forEach(item => {
                const idx = this.inventory.findIndex(inv => inv.id === item.id);
                if (idx !== -1) this.inventory[idx] = { ...this.inventory[idx], ...item, latestPrice: item.latestPrice };
                else this.inventory.push({ ...item, priceHistory: [] });
            });
            this.stagedItems = []; this.importJsonText = ''; this.showAiImportPanel = false; this.showAiInventoryModal = false; this.saveData(); alert("æ›´æ–°æˆåŠŸï¼");
        },

        // --- 2. Receipt AI (v8.8 Error Handling & Test) ---
        openAiReceiptModal() { this.showAiReceiptModal = true; },
        copyReceiptPrompt() {
            const returnUrl = window.location.href.split('#')[0] + "#import_expenses";
            let extra = this.selectedAI === 'grok' ? `\n(âš ï¸ æ³¨æ„ï¼šGrok App è«‹æ‰‹å‹•åˆ‡æ›å›ç€è¦½å™¨)\n` : '';
            const prompt = `ä½ ç¾åœ¨æ˜¯æˆ‘çš„ã€Œæ”¶æ“š/ç™¼ç¥¨åˆ†æå“¡ã€ã€‚è«‹åˆ†ææˆ‘ä¸Šå‚³çš„åœ–ç‰‡ã€‚\nè«‹æå–ä»¥ä¸‹è³‡è¨Šä¸¦åš´æ ¼è¼¸å‡º JSON æ ¼å¼ï¼š\n{\n "date": "YYYY-MM-DD",\n "store": "ç°¡çŸ­åº—å(å¦‚ New Balance, æƒ åº·)",\n "address": "è«‹æå–æ”¶æ“šä¸Šçš„åœ°å€ï¼Œè‹¥ç„¡è©³ç´°åœ°å€è«‹æä¾›åœ°å€(å¦‚ æ—ºè§’)",\n "total": æ•¸å­—(æœ€çµ‚å¯¦ä»˜é‡‘é¡),\n "category": "è«‹æ¨æ¸¬é¡åˆ¥(è¶…ç´šå¸‚å ´, ç¶²è³¼, é£²é£Ÿ, è¡£ç‰©, å…¶ä»–)",\n "items": [ { "name": "å•†å“å", "price": å–®åƒ¹, "qty": æ•¸é‡ } ]\n}\næ³¨æ„ï¼š"total" å¿…é ˆæ˜¯æŠ˜æ‰£å¾Œçš„æœ€çµ‚ä»˜æ¬¾é‡‘é¡ã€‚${extra}\néå¸¸é‡è¦ï¼šè«‹åœ¨ JSON è¼¸å‡ºçµæŸå¾Œï¼Œæ–°èµ·ä¸€è¡Œï¼Œé™„ä¸Šè¿”å›é€£çµï¼š\n[â†©ï¸ é»æ“Šé€™è£¡è¿”å›ç³»çµ±åŒ¯å…¥](${returnUrl})`;
            navigator.clipboard.writeText(prompt).then(() => { this.openTargetAI(this.getAiUrl()); });
        },
        
        // [v8.8 New Feature] Test Data Injection
        testReceiptJson() {
            this.receiptJsonText = JSON.stringify({
                "date": "2025-01-01",
                "store": "æ¸¬è©¦å•†åº— (Demo)",
                "address": "é¦™æ¸¯æ¸¬è©¦å€æ¸¬è©¦è·¯8è™Ÿ",
                "total": 128.5,
                "category": "é£²é£Ÿ",
                "items": [
                    { "name": "æ¸¬è©¦æ¼¢å ¡", "price": 50, "qty": 2 },
                    { "name": "æ¸¬è©¦å¯æ¨‚", "price": 28.5, "qty": 1 }
                ]
            }, null, 2);
        },

        // [v8.8 Enhanced Error Handling]
        processReceiptJson() {
            if (!this.receiptJsonText) return alert("è«‹å…ˆè²¼ä¸Šå…§å®¹ï¼");
            try {
                let cleanText = this.receiptJsonText.replace(/[\u201C\u201D]/g, '"').replace(/```json/g, '').replace(/```/g, '');
                const linkIndex = cleanText.indexOf('[â†©ï¸'); if (linkIndex !== -1) cleanText = cleanText.substring(0, linkIndex);
                
                const firstBrace = cleanText.indexOf('{'); const lastBrace = cleanText.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    cleanText = cleanText.substring(firstBrace, lastBrace + 1);
                } else {
                    throw new Error("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ JSON æ ¼å¼ {...}");
                }

                const data = JSON.parse(cleanText);
                
                this.newExpense.date = data.date || new Date().toISOString().split('T')[0];
                this.newExpense.note = data.store || '';
                this.newExpense.amount = data.total || 0;
                this.newExpense.subtotal = data.total || 0;
                this.newExpense.category = data.category || 'å…¶ä»–';
                this.newExpense.address = data.address || '';
                this.autoGenerateMapUrl();
                
                if (data.items && Array.isArray(data.items)) {
                    this.newExpense.items = data.items.map(i => ({ itemId: 'AI-' + Date.now() + Math.random(), name: i.name, brand: '', price: i.price || 0, qty: i.qty || 1 }));
                }
                
                let matched = false;
                if (this.companyDB[data.category]) {
                     const found = this.companyDB[data.category].find(c => c.name === data.store);
                     if(found) { this.newExpense.category = data.category; matched = true; } 
                     else {
                         for (const cat in this.companyDB) { 
                             const foundInCat = this.companyDB[cat].find(c => c.name === data.store);
                             if (foundInCat) { this.newExpense.category = cat; matched = true; break; } 
                         }
                     }
                }

                this.onCategoryChange(); 
                if (matched) { 
                    this.selectedStore = data.store; 
                } else { 
                    this.selectedStore = 'other'; 
                    this.customStoreInput = data.store; 
                }

                this.showAiReceiptPanel = false;
                this.receiptJsonText = '';
                this.isEditingExpense = false; 
                this.showAiReceiptModal = false;
                
                this.$nextTick(() => {
                    alert("å–®æ“šè§£ææˆåŠŸï¼");
                    if (this.$refs.expenseFormCard) {
                        this.$refs.expenseFormCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
                
            } catch (e) { 
                alert('è§£æå¤±æ•—ï¼š\n' + e.message + '\n\nè«‹æª¢æŸ¥è²¼ä¸Šçš„å…§å®¹æ˜¯å¦åŒ…å«å®Œæ•´çš„ { ... }'); 
                console.error(e); 
            }
        },
        
        autoGenerateMapUrl() {
            const store = (this.selectedStore === 'other' ? this.customStoreInput : this.selectedStore) || this.newExpense.note;
            const address = this.newExpense.address || "";
            if (store) {
                 const searchQuery = store + (address ? " " + address : "");
                 this.newExpense.mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
            }
        },

        updateCalculatedAmount() {
            let baseAmount = 0;
            if (this.isShoppingCategory) { baseAmount = (this.newExpense.items || []).reduce((sum, item) => sum + (item.price * item.qty), 0); this.newExpense.subtotal = baseAmount; } else { baseAmount = this.newExpense.subtotal || 0; }
            const discount = this.newExpense.discount || 0;
            this.newExpense.amount = parseFloat(Math.max(0, baseAmount - discount).toFixed(1));
        },
        
        addCartItemManual(){ this.newExpense.items.push({itemId:'MANUAL', name:'æ–°é …ç›®', brand:'', price:0, qty:1}); },
        openAddModal(){this.editingForm={categoryId:'99',stock:1,brand:''};this.showAddModal=true;},closeModal(){this.showAddModal=false;this.showEditModal=false;this.editingForm={};},saveItem(){if(!this.editingForm.name)return alert('åç¨±å¿…å¡«');if(this.showEditModal){const idx=this.inventory.findIndex(i=>i.id===this.editingForm.id);if(idx!==-1)this.inventory[idx]={...this.editingForm};}else{this.editingForm.id=Date.now().toString();this.inventory.push(this.editingForm);}this.saveData();this.closeModal();this.selectedIds=[];},actionDelete(){if(!confirm('åˆªé™¤ï¼Ÿ'))return;this.inventory=this.inventory.filter(i=>!this.selectedIds.includes(i.id));this.selectedIds=[];this.saveData();},actionEdit(){if(this.selectedItems.length!==1)return;this.editingForm=JSON.parse(JSON.stringify(this.selectedItems[0]));this.showEditModal=true;},updateStock(item,change){item.stock=Math.max(0,(item.stock||0)+change);this.saveData();},
        
        // v8.0 Store Selection Change
        onStoreSelectChange() {
            if (this.selectedStore && this.selectedStore !== 'other') {
                const storeObj = this.currentCompanyOptions.find(c => c.name === this.selectedStore);
                if (storeObj) {
                    this.newExpense.address = storeObj.address || '';
                    this.newExpense.mapUrl = storeObj.mapUrl || '';
                }
            } else {
                this.customStoreInput = '';
            }
        },
        onCategoryChange(){
            this.selectedStore = (this.currentCompanyOptions.length > 0) ? this.currentCompanyOptions[0].name : 'other';
            this.onStoreSelectChange();
        },

        addCartItem(){if(!this.selectedInventoryItem)return;if(this.tempQty<1)return alert('æ•¸é‡è‡³å°‘ç‚º 1');if(!this.newExpense.items)this.newExpense.items=[];this.newExpense.items.push({itemId:this.selectedInventoryItem.id,name:this.selectedInventoryItem.name,brand:this.selectedInventoryItem.brand||'',price:this.selectedInventoryItem.latestPrice||0,qty:this.tempQty});this.tempQty=1;this.selectedInventoryItem=null;},removeCartItem(idx){this.newExpense.items.splice(idx,1);},
        
        saveExpense(){
            let storeName = this.selectedStore;
            if(storeName==='other') storeName = this.customStoreInput||'å…¶ä»–';
            this.newExpense.note = storeName;
            this.updateCalculatedAmount();
            
            if(!this.newExpense.amount&&this.newExpense.amount!==0)return alert('é‡‘é¡å¿…å¡«');
            
            // v8.0: Save Company Info (Address/Map)
            if (this.newExpense.category && this.companyDB[this.newExpense.category]) {
                const existingStoreIndex = this.companyDB[this.newExpense.category].findIndex(c => c.name === storeName);
                
                if (existingStoreIndex === -1) {
                    this.companyDB[this.newExpense.category].push({
                        name: storeName,
                        address: this.newExpense.address || '',
                        mapUrl: this.newExpense.mapUrl || ''
                    });
                } else {
                    if (this.newExpense.address) {
                        this.companyDB[this.newExpense.category][existingStoreIndex].address = this.newExpense.address;
                        this.companyDB[this.newExpense.category][existingStoreIndex].mapUrl = this.newExpense.mapUrl;
                    }
                }
            }

            if(this.isEditingExpense){this.expenses[this.editingExpenseIndex]={...this.newExpense};alert('ç´€éŒ„å·²æ›´æ–°');}else{this.newExpense.id=Date.now().toString()+Math.random().toString(36).substr(2,5);this.expenses.push({...this.newExpense});if(this.isShoppingCategory&&this.newExpense.items&&this.newExpense.items.length>0){if(confirm(`å„²å­˜æˆåŠŸï¼\næ˜¯å¦è¦å°‡é€™ ${this.newExpense.items.length} é …å•†å“çš„æ•¸é‡åŠ å…¥åº«å­˜ï¼Ÿ`)){this.updateInventoryFromOrder(this.newExpense.items);}}}this.resetExpenseForm();this.saveData();
        },
        updateInventoryFromOrder(items){let count=0;items.forEach(orderItem=>{const invItem=this.inventory.find(i=>i.id===orderItem.itemId);if(invItem){invItem.stock=(invItem.stock||0)+orderItem.qty;count++;}});alert(`å·²æ›´æ–° ${count} å€‹åº«å­˜é …ç›®ã€‚`);},deleteExpense(idx){if(confirm('åˆªé™¤ç´€éŒ„ï¼Ÿ')){this.expenses.splice(idx,1);this.saveData();}},viewOrderDetails(exp){this.viewingOrder=exp;this.showOrderDetailModal=true;},editOrderFromModal(){this.showOrderDetailModal=false;this.editExpenseDirectly(this.viewingOrder);},
        editExpenseDirectly(exp){
            this.newExpense=JSON.parse(JSON.stringify(exp));
            if(this.newExpense.subtotal === undefined) { this.newExpense.subtotal = this.newExpense.amount + (this.newExpense.discount || 0); }
            
            const currentOpts = this.companyDB[this.newExpense.category] || [];
            const storeObj = currentOpts.find(c => c.name === this.newExpense.note);
            
            if (storeObj) {
                this.selectedStore = storeObj.name;
                if(!this.newExpense.address) this.newExpense.address = storeObj.address;
                if(!this.newExpense.mapUrl) this.newExpense.mapUrl = storeObj.mapUrl;
            } else {
                this.selectedStore = 'other';
                this.customStoreInput = this.newExpense.note;
            }
            
            this.isEditingExpense=true;this.editingExpenseIndex=this.expenses.findIndex(e=>e.id===exp.id);window.scrollTo({top:0,behavior:'smooth'});
        },
        cancelEditExpense(){this.resetExpenseForm();},
        resetExpenseForm(){
            this.newExpense={date:new Date().toISOString().split('T')[0],category:'è¶…ç´šå¸‚å ´',amount:0,subtotal:0,note:'',refNumber:'',items:[],discount:0, address:'', mapUrl:''};
            this.selectedInventoryItem=null;this.tempQty=1;this.isEditingExpense=false;this.editingExpenseIndex=-1;
            this.onCategoryChange();
        },
        exportExpenseCSV(){let csv="\uFEFFæ—¥æœŸ,é¡åˆ¥,å…¬å¸,é‡‘é¡,å–®è™Ÿ,åœ°å€\n";this.sortedExpenses.forEach(e=>csv+=`${e.date},${e.category},"${e.note||''}",${e.amount},"${e.refNumber||''}", "${e.address||''}"\n`);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download="family_expenses.csv";document.body.appendChild(a);a.click();a.remove();},showMonthlySummary(){const stats={};this.expenses.forEach(e=>{const monthKey=e.date.substring(0,7);if(!stats[monthKey])stats[monthKey]=0;stats[monthKey]+=parseFloat(e.amount||0);});this.monthlyStats=Object.keys(stats).map(k=>({month:k,total:stats[k]})).sort((a,b)=>b.month.localeCompare(a.month));this.showMonthlyModal=true;},
        prepareFileExport(type){this.currentExportType=type;this.showFileExportModal=true;},executeExport(method){this.showFileExportModal=false;let content="",filename="",mimeType="text/plain";if(this.currentExportType==='json'){content=JSON.stringify({inventory:this.inventory,expenses:this.expenses,apiKey:this.apiKey,companyDB:this.companyDB});filename="good_husband_backup.json";mimeType="application/json";}else if(this.currentExportType==='inventory_csv'){content="\uFEFFid,åˆ†é¡,å“ç‰Œ,åç¨±,åº«å­˜,åƒ¹æ ¼,å–®åƒ¹,ISBN,ç¶²å€\n";this.inventory.forEach(i=>{content+=[i.id,i.categoryId,i.brand,i.name,i.stock,i.latestPrice,i.unitPrice,i.isbn,i.url].map(f=>`"${String(f||'').replace(/"/g,'""')}"`).join(',')+"\n";});filename="inventory.csv";mimeType="text/csv";}else if(this.currentExportType==='expense_csv'){content="\uFEFFæ—¥æœŸ,é¡åˆ¥,å…¬å¸,é‡‘é¡,å–®è™Ÿ,åœ°å€\n";this.sortedExpenses.forEach(e=>content+=`${e.date},${e.category},"${e.note||''}",${e.amount},"${e.refNumber||''},"${e.address||''}"\n`);filename="expenses_list.csv";mimeType="text/csv";}if(method==='download'){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type:mimeType}));a.download=filename;document.body.appendChild(a);a.click();a.remove();}else if(method==='share'){const file=new File([content],filename,{type:mimeType});if(navigator.canShare&&navigator.canShare({files:[file]})){navigator.share({files:[file],title:filename,text:'å¥½ç”·äººæ™ºæ…§å®¶å±…è³‡æ–™åŒ¯å‡º'}).catch(err=>console.log('Share canceled',err));}else{alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´æª”æ¡ˆåˆ†äº«ï¼Œå°‡æ”¹ç‚ºç›´æ¥ä¸‹è¼‰ã€‚");const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type:mimeType}));a.download=filename;document.body.appendChild(a);a.click();a.remove();}}},triggerImport(type){this.currentImportType=type;this.$refs.fileInput.click();},handleFileImport(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(evt)=>{const c=evt.target.result;if(this.currentImportType==='json'){try{const p=JSON.parse(c);this.inventory=p.inventory||[];this.expenses=p.expenses||[];this.apiKey=p.apiKey||'';if(p.companyDB)this.companyDB=p.companyDB;this.saveData();alert('é‚„åŸæˆåŠŸ');}catch(err){alert('JSON æ ¼å¼éŒ¯èª¤');}}else if(this.currentImportType==='inventory_csv'){const l=c.trim().split(/\r?\n/);let count=0;for(let i=1;i<l.length;i++){const cols=l[i].split(',').map(s=>s.replace(/^"|"$/g,''));if(cols.length>3){this.inventory.push({id:Date.now()+Math.random().toString(36),categoryId:cols[1],brand:cols[2],name:cols[3],stock:cols[4],latestPrice:cols[5]});count++;}}this.saveData();alert(`åŒ¯å…¥ ${count} ç­†åº«å­˜`);}else if(this.currentImportType==='expense_csv'){const l=c.trim().split(/\r?\n/);let count=0;for(let i=1;i<l.length;i++){const cols=l[i].split(',').map(s=>s.replace(/^"|"$/g,''));if(cols.length>=4){this.expenses.push({id:Date.now()+Math.random().toString(36),date:cols[0],category:cols[1],note:cols[2],amount:parseFloat(cols[3]),refNumber:cols[4]||''});count++;}}this.saveData();alert(`åŒ¯å…¥ ${count} ç­†æ”¯å‡º`);}e.target.value='';};r.readAsText(f);}
    }
}).mount('#app');
</script>
</body>
</html>
